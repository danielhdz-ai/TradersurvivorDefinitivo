<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trader Survivor - Trading Journal Profesional V2</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <!-- Incluir Dexie.js -->
    <script src="https://unpkg.com/dexie@3/dist/dexie.js"></script>
    <!-- Incluir Lightweight Charts -->
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <!-- Supabase CDN -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        /* Paleta de colores: Negro, Verde Fluorescente y Blanco */
        :root {
            --primary: #39ff14;       /* Verde Fluorescente */
            --secondary: #28e000;     /* Verde Fluorescente más oscuro para hover */
            --background: #0a0a0a;     /* Negro Oscuro */
            --surface: #141414;       /* Negro ligeramente más claro para tarjetas */
            --surface-light: #2a2a2a; /* Gris muy oscuro para bordes e inactivos */
            --text: #ffffff;           /* Blanco Puro */
            --text-secondary: #a0a0a0; /* Gris claro para texto secundario */
            --red: #ff4136;            /* Rojo brillante para pérdidas */
            --green: #39ff14;          /* Verde Fluorescente para ganancias */
            --yellow: #f59e0b;         /* Amarillo para métricas neutrales */
        }
        
        /* Clases de utilidad para colores dinámicos en JS */
        .text-positive { color: var(--green); }
        .text-negative { color: var(--red); }
        .text-neutral { color: var(--text-secondary); }

        /* Estilo base del cuerpo */
        body {
            font-family: 'Segoe UI', 'Roboto', system-ui, -apple-system, sans-serif;
            background-color: var(--background);
            color: var(--text);
            margin: 0;
            padding: 0;
        }

        .app-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        /* Pestañas de navegación */
        .nav-tabs {
            border-bottom: 1px solid var(--surface-light);
        }
        .nav-tab {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            color: var(--text-secondary);
            border-bottom: 3px solid transparent;
            margin-bottom: -1px;
            white-space: nowrap;
        }
        .nav-tab.active {
            color: var(--text);
            border-bottom-color: var(--primary);
            font-weight: 600;
        }
        .nav-tab:hover:not(.active) {
            color: var(--text);
            border-bottom-color: var(--surface-light);
        }

        /* Contenedor de sección */
        .section-container {
            display: none;
            padding: 1.5rem 0;
            margin-bottom: 2rem;
        }
        .section-container.active { display: block; }

        /* Tarjetas de métricas */
        .metric-card {
            background-color: var(--surface);
            border-radius: 0.5rem;
            padding: 1.5rem;
            border: 1px solid var(--surface-light);
            transition: all 0.2s ease-in-out;
        }
        .metric-card:hover {
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(57, 255, 20, 0.05);
        }

        /* Tarjetas de Cuentas */
        .account-card {
            background-color: var(--surface);
            border-radius: 0.5rem;
            padding: 1.5rem;
            border: 1px solid var(--surface-light);
            transition: all 0.2s ease-in-out;
        }
        .account-card:hover {
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(57, 255, 20, 0.1);
            transform: translateY(-2px);
        }
        .account-card.selected {
            border-color: var(--primary);
            box-shadow: 0 0 25px rgba(57, 255, 20, 0.15);
        }
        
        /* Calendario */
        .calendar-day {
            width: 100%; aspect-ratio: 1 / 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-radius: 0.25rem; cursor: pointer; transition: all 0.2s ease; position: relative;
            background-color: var(--surface); border: 1px solid var(--surface-light);
        }
        .calendar-day.empty { background-color: transparent; border-color: var(--background); cursor: default; }
        .calendar-day.empty:hover { transform: none; }
        .calendar-day.profit { background-color: rgba(57, 255, 20, 0.05); border-color: var(--green); }
        .calendar-day.loss { background-color: rgba(255, 65, 54, 0.05); border-color: var(--red); }
        .calendar-day:not(.empty):hover { transform: scale(1.05); z-index: 10; border-color: var(--primary); }
        .day-number { font-size: 1.2rem; font-weight: 600; }
        .day-profit.positive { color: var(--green); }
        .day-profit.negative { color: var(--red); }
        .day-trades { font-size: 0.7rem; color: var(--text-secondary); }

        /* Botones */
        button {
            background-color: var(--surface-light); color: var(--text); border: 1px solid var(--surface-light);
            border-radius: 0.25rem; padding: 0.6rem 1.2rem; cursor: pointer; transition: all 0.2s ease; font-weight: 500;
        }
        button:hover { background-color: var(--primary); border-color: var(--primary); color: var(--background); font-weight: bold; }
        button.primary { background-color: var(--primary); border-color: var(--primary); color: var(--background); font-weight: bold; }
        button.primary:hover { background-color: var(--secondary); border-color: var(--secondary); }
        button.success { background-color: var(--green); border-color: var(--green); color: var(--background); font-weight: bold; }
        button.danger { background-color: var(--red); border-color: var(--red); }
        #operations-table td button, #accounts-container button, #finances-table-body td button {
            padding: 0.3rem 0.6rem; font-size: 0.875rem; background-color: transparent; border: none;
        }
        #operations-table td button:hover, #accounts-container button:hover, #finances-table-body td button:hover {
            opacity: 0.8; color: var(--primary);
        }

        /* Formularios */
        input, select, textarea {
            background-color: var(--surface); color: var(--text); border: 1px solid var(--surface-light);
            border-radius: 0.25rem; padding: 0.6rem; width: 100%; transition: border-color 0.2s ease;
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); }
        input[type="file"]::file-selector-button {
            background-color: var(--primary); color: var(--background); border: none; padding: 0.5rem 1rem;
            border-radius: 0.25rem; cursor: pointer; transition: background-color 0.3s ease; margin-right: 0.8rem; font-weight: bold;
        }
        input[type="file"]::file-selector-button:hover { background-color: var(--secondary); }

        /* Tablas */
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th {
            text-align: left; padding: 0.8rem 1rem; background-color: transparent;
            font-weight: 600; color: var(--text-secondary); text-transform: uppercase; font-size: 0.75rem;
            letter-spacing: 0.05em; border-bottom: 1px solid var(--surface-light);
        }
        td {
            padding: 0.8rem 1rem; border-bottom: 1px solid var(--surface);
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap; vertical-align: middle;
        }
        tr:hover td { background-color: rgba(57, 255, 20, 0.03); }
        #operations-table tr.cursor-pointer:hover td { background-color: rgba(57, 255, 20, 0.08); }
        #best-trades tr.cursor-pointer:hover td, #worst-trades tr.cursor-pointer:hover td, #day-modal-table-body tr.cursor-pointer:hover td {
             background-color: rgba(57, 255, 20, 0.08);
        }
        /* Tablas clicables en Analytics */
        #analytics-monthly-performance tr, #analytics-daily-performance tr {
            cursor: pointer;
        }
        #analytics-monthly-performance tr:hover td, #analytics-daily-performance tr:hover td {
            background-color: rgba(57, 255, 20, 0.08);
        }

        /* --- NUEVO: Estilo para cabeceras de tabla ordenables --- */
        #operations-table-render th[data-sort] {
            cursor: pointer;
            position: relative;
        }
        #operations-table-render th[data-sort]:hover {
            color: var(--text);
        }
        #operations-table-render th[data-sort].sorted::after {
            content: '';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            border: 4px solid transparent;
        }
        #operations-table-render th[data-sort].sorted.asc::after {
            border-bottom-color: var(--primary);
            margin-top: -2px;
        }
        #operations-table-render th[data-sort].sorted.desc::after {
            border-top-color: var(--primary);
            margin-top: 2px;
        }


        /* Currency Switch */
        .currency-switch { display: inline-flex; overflow: hidden; border-radius: 0.25rem; background-color: var(--surface); border: 1px solid var(--surface-light); }
        .currency-switch label { padding: 0.5rem 1rem; cursor: pointer; transition: all 0.2s ease; color: var(--text-secondary); font-size: 0.875rem; }
        .currency-switch input[type="radio"] { display: none; }
        .currency-switch input[type="radio"]:checked + label { background-color: var(--primary); color: var(--background); font-weight: 600; }
        .currency-switch label:hover:not(.active) { background-color: var(--surface-light); }
        
        /* Gráficos */
        .chart-container { position: relative; height: 320px; margin-bottom: 1rem; }

        /* Loading Spinner */
        .loading { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(10, 10, 10, 0.9); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .spinner { border: 4px solid var(--surface-light); border-radius: 50%; border-top: 4px solid var(--primary); width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Modals */
        .image-modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.95); align-items: center; justify-content: center; }
        .image-modal-content { max-width: 90%; max-height: 90%; border-radius: 5px; }
        .image-modal-close { position: absolute; top: 15px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; cursor: pointer; }
        
        #day-detail-modal { background-color: rgba(0,0,0,0.8); }
        #day-detail-modal > div { background-color: var(--surface); border: 1px solid var(--surface-light); }
        
        /* --- NUEVO: Estilo para el modal de detalles de Analytics --- */
        #analytics-detail-modal {
            display: none; /* Oculto por defecto */
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.9);
            z-index: 1002;
            padding: 2rem;
            overflow-y: auto;
        }
        .analytics-detail-container {
            background-color: var(--background);
            border: 1px solid var(--surface-light);
            border-radius: 0.5rem;
            max-width: 1400px;
            margin: 2rem auto;
            padding: 2rem;
        }

        
        /* --- AUTHENTICATION MODAL STYLES --- */
        .auth-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 1050;
            align-items: center;
            justify-content: center;
        }
        
        .auth-modal {
            background-color: var(--surface);
            border: 1px solid var(--surface-light);
            border-radius: 0.75rem;
            padding: 2rem;
            width: 100%;
            max-width: 400px;
            margin: 1rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        
        .auth-tabs {
            display: flex;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--surface-light);
        }
        
        .auth-tab {
            flex: 1;
            padding: 0.75rem 1rem;
            text-align: center;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: var(--text-secondary);
            transition: all 0.2s ease;
            font-weight: 500;
        }
        
        .auth-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        
        .auth-tab:hover:not(.active) {
            color: var(--text);
        }
        
        .auth-form {
            display: none;
        }
        
        .auth-form.active {
            display: block;
        }
        
        .auth-input {
            width: 100%;
            padding: 0.75rem 1rem;
            background-color: var(--background);
            border: 1px solid var(--surface-light);
            border-radius: 0.5rem;
            color: var(--text);
            font-size: 1rem;
            transition: all 0.2s ease;
            margin-bottom: 1rem;
        }
        
        .auth-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(57, 255, 20, 0.1);
        }
        
        .auth-input::placeholder {
            color: var(--text-secondary);
        }
        
        .auth-button {
            width: 100%;
            padding: 0.75rem 1rem;
            background-color: var(--primary);
            color: var(--background);
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 1rem;
        }
        
        .auth-button:hover {
            background-color: var(--secondary);
        }
        
        .auth-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .auth-error {
            background-color: rgba(255, 65, 54, 0.1);
            border: 1px solid var(--red);
            color: var(--red);
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }
        
        .auth-success {
            background-color: rgba(57, 255, 20, 0.1);
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--text);
            font-size: 0.875rem;
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--primary);
            color: var(--background);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
        }
        
        .logout-button {
            padding: 0.5rem 1rem;
            background-color: var(--surface);
            border: 1px solid var(--surface-light);
            color: var(--text);
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }
        
        .logout-button:hover {
            background-color: var(--surface-light);
            border-color: var(--primary);
        }
        
        .app-hidden {
            display: none !important;
        }
        /* --- END: AUTHENTICATION STYLES --- */
    </style>
</head>
<body>
    <!-- Authentication Modal -->
    <div id="authModal" class="auth-overlay">
        <div class="auth-modal">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-white flex items-center justify-center">
                    <i class="fas fa-rocket mr-3 text-primary"></i>
                    Trader Survivor
                </h2>
                <p class="text-text-secondary mt-2">Accede a tu trading journal profesional</p>
            </div>
            
            <div class="auth-tabs">
                <div class="auth-tab active" data-tab="login">
                    <i class="fas fa-sign-in-alt mr-2"></i>
                    Iniciar Sesión
                </div>
                <div class="auth-tab" data-tab="register">
                    <i class="fas fa-user-plus mr-2"></i>
                    Registrarse
                </div>
            </div>

            <!-- Login Form -->
            <form id="loginForm" class="auth-form active">
                <div id="authMessage" class="auth-error" style="display: none;"></div>
                
                <input
                    type="email"
                    id="loginEmail"
                    class="auth-input"
                    placeholder="Email"
                    required
                />
                
                <input
                    type="password"
                    id="loginPassword"
                    class="auth-input"
                    placeholder="Contraseña"
                    required
                />
                
                <button type="submit" class="auth-button">
                    <i class="fas fa-sign-in-alt mr-2"></i>
                    Iniciar Sesión
                </button>
            </form>

            <!-- Register Form -->
            <form id="registerForm" class="auth-form">
                <input
                    type="email"
                    id="registerEmail"
                    class="auth-input"
                    placeholder="Email"
                    required
                />
                
                <input
                    type="password"
                    id="registerPassword"
                    class="auth-input"
                    placeholder="Contraseña (mínimo 6 caracteres)"
                    minlength="6"
                    required
                />
                
                <input
                    type="password"
                    id="confirmPassword"
                    class="auth-input"
                    placeholder="Confirmar Contraseña"
                    minlength="6"
                    required
                />
                
                <button type="submit" class="auth-button">
                    <i class="fas fa-user-plus mr-2"></i>
                    Crear Cuenta
                </button>
            </form>
        </div>
    </div>
    
    <div class="app-container app-hidden" id="mainApp">
        <header class="flex flex-wrap justify-between items-center mb-6 gap-4">
            <h1 class="text-3xl font-bold flex items-center text-white">
                <i class="fas fa-rocket mr-4 text-primary"></i> Trader Survivor
            </h1>

            <div class="currency-switch">
                <input type="radio" id="usd" name="currency" value="USD" checked>
                <label for="usd">USD</label>
                <input type="radio" id="eur" name="currency" value="EUR">
                <label for="eur">EUR</label>
                <input type="radio" id="percentage" name="currency" value="%">
                <label for="percentage">%</label>
            </div>
            
            <!-- User Info -->
            <div id="userInfo" class="user-info" style="display: none;">
                <div class="user-avatar" id="userAvatar">U</div>
                <span id="userEmail" class="text-sm">usuario@ejemplo.com</span>
                <button id="logoutBtn" class="logout-button">
                    <i class="fas fa-sign-out-alt mr-1"></i>
                    Cerrar Sesión
                </button>
            </div>
        </header>

        <nav class="mb-6 overflow-x-auto">
            <div class="nav-tabs flex">
                <div class="nav-tab active" data-target="dashboard">Dashboard</div>
                <div class="nav-tab" data-target="analytics">Analytics</div>
                <div class="nav-tab" data-target="calendar">Calendario</div>
                <div class="nav-tab" data-target="operations">Operaciones</div>
                <div class="nav-tab" data-target="accounts">Cuentas</div>
                <div class="nav-tab" data-target="finances">Finanzas</div>
                <div class="nav-tab" data-target="news">Noticias</div>
                <div class="nav-tab" data-target="config">Configuración</div>
            </div>
        </nav>

        <section id="dashboard" class="section-container active">
            <div id="account-selector" class="mb-6 flex flex-wrap justify-between items-center gap-4">
                <div class="flex items-center space-x-2">
                    <select id="dashboard-account-select" class="w-64">
                        <option value="all">Todas las cuentas</option>
                    </select>
                    <button id="dashboard-date-filter-btn" class="date-filter-trigger p-2 bg-surface rounded" title="Filtrar por fecha">
                        <i class="fas fa-calendar-alt"></i>
                    </button>
                    <div id="dashboard-date-filter-display" class="date-filter-display-text text-sm text-text-secondary">Sin filtro de fecha</div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="metric-card">
                    <h3 class="text-sm font-medium text-text-secondary mb-1">P/L Neto</h3>
                    <p id="current-balance" class="text-3xl font-bold text-green">$0.00</p>
                </div>

                <div class="metric-card">
                    <h3 class="text-sm font-medium text-text-secondary mb-1">Win Rate</h3>
                    <p id="win-rate" class="text-3xl font-bold text-green">0%</p>
                </div>

                <div class="metric-card">
                    <h3 class="text-sm font-medium text-text-secondary mb-1">Profit Factor</h3>
                    <p id="profit-factor" class="text-3xl font-bold text-yellow">0.00</p>
                </div>

                <div class="metric-card">
                    <h3 class="text-sm font-medium text-text-secondary mb-1">Operaciones</h3>
                    <p id="total-trades" class="text-3xl font-bold text-white">0</p>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <div class="metric-card lg:col-span-2">
                    <h3 class="text-lg font-semibold mb-2">Evolución de la Cuenta</h3>
                    <div class="time-range-buttons mb-3 text-sm">
                        <button data-range="1W" class="time-range-btn">1S</button>
                        <button data-range="1M" class="time-range-btn">1M</button>
                        <button data-range="3M" class="time-range-btn">3M</button>
                        <button data-range="6M" class="time-range-btn">6M</button>
                        <button data-range="1Y" class="time-range-btn">1A</button>
                        <button data-range="ALL" class="time-range-btn active">Todo</button>
                    </div>
                    <div class="chart-container" style="height: 350px;">
                        <canvas id="account-evolution-chart"></canvas>
                    </div>
                </div>

                <div class="metric-card">
                    <h3 class="text-lg font-semibold mb-2">Puntuación de Rendimiento</h3>
                    <div class="chart-container" style="height: 350px;">
                        <canvas id="dashboard-radar-chart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 my-8">
                <div class="metric-card">
                    <h3 class="text-sm font-medium text-text-secondary mb-1">Total Ganado</h3>
                    <p id="dashboard-total-win" class="text-2xl font-bold text-green">$0.00</p>
                </div>
                <div class="metric-card">
                    <h3 class="text-sm font-medium text-text-secondary mb-1">Total Perdido</h3>
                    <p id="dashboard-total-loss" class="text-2xl font-bold text-red">$0.00</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 my-8">
                <div class="metric-card">
                    <h3 class="text-sm font-medium text-text-secondary mb-1">Retorno Prom. / Ganador</h3>
                    <p id="dashboard-avg-win" class="text-2xl font-bold text-green">$0.00</p>
                </div>
                <div class="metric-card">
                    <h3 class="text-sm font-medium text-text-secondary mb-1">Retorno Prom. / Perdedor</h3>
                    <p id="dashboard-avg-loss" class="text-2xl font-bold text-red">$0.00</p>
                </div>
                <div class="metric-card">
                    <h3 class="text-sm font-medium text-text-secondary mb-1">P/L Promedio / Trade</h3>
                    <p id="dashboard-avg-pl" class="text-2xl font-bold text-white">$0.00</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="metric-card">
                    <h3 class="text-lg font-semibold mb-2">Rendimiento por Instrumento</h3>
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="instrument-performance-chart"></canvas>
                    </div>
                </div>

                <div class="metric-card">
                    <h3 class="text-lg font-semibold mb-2">Rendimiento por Día de la Semana</h3>
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="day-performance-chart"></canvas>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 gap-6 mt-8">
                <div class="metric-card">
                    <h3 class="text-lg font-semibold mb-2">Rendimiento por Tipo de Operación (Long/Short)</h3>
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="type-performance-chart"></canvas>
                    </div>
                </div>
            </div>

        </section>

        <section id="analytics" class="section-container">
            <h2 class="text-xl font-semibold mb-6">Análisis Detallado</h2>
            <div class="mb-6">
                <div class="flex items-center space-x-2">
                    <select id="analytics-account-select" class="w-64">
                        <option value="all">Todas las cuentas</option>
                    </select>
                    <button id="analytics-date-filter-btn" class="date-filter-trigger p-2 bg-surface rounded" title="Filtrar por fecha">
                        <i class="fas fa-calendar-alt"></i>
                    </button>
                </div>
                <div id="analytics-date-filter-display" class="date-filter-display-text text-sm text-text-secondary mt-1">Sin filtro de fecha</div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                 <div class="metric-card"><h3 class="text-base mb-1 text-text-secondary">P/L Neto Total</h3><p id="analytics-total-pl" class="text-2xl font-bold text-green">$0.00</p></div>
                <div class="metric-card"><h3 class="text-base mb-1 text-text-secondary">Win Rate</h3><p id="analytics-win-rate" class="text-2xl font-bold text-green">0%</p></div>
                <div class="metric-card"><h3 class="text-base mb-1 text-text-secondary">Profit Factor</h3><p id="analytics-profit-factor" class="text-2xl font-bold text-yellow">0.00</p></div>
                <div class="metric-card"><h3 class="text-base mb-1 text-text-secondary">Total Trades</h3><p id="analytics-total-trades" class="text-2xl font-bold text-white">0</p></div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <div class="metric-card"><h3 class="text-lg font-semibold mb-3">Métricas Clave</h3><dl class="space-y-2 text-sm">
                    <div class="flex justify-between"><dt>Ganancia Promedio:</dt><dd id="analytics-avg-win" class="font-semibold text-green">$0.00</dd></div>
                    <div class="flex justify-between"><dt>Pérdida Promedio:</dt><dd id="analytics-avg-loss" class="font-semibold text-red">$0.00</dd></div>
                    <div class="flex justify-between"><dt>P/L Promedio / Trade:</dt><dd id="analytics-avg-pl-trade" class="font-semibold text-white">$0.00</dd></div>
                    <div class="flex justify-between"><dt>Expectativa:</dt><dd id="analytics-expectancy" class="font-semibold text-white">$0.00</dd></div>
                    <div class="flex justify-between"><dt>Mayor Ganancia:</dt><dd id="analytics-largest-win" class="font-semibold text-green">$0.00</dd></div>
                    <div class="flex justify-between"><dt>Mayor Pérdida:</dt><dd id="analytics-largest-loss" class="font-semibold text-red">$0.00</dd></div></dl>
                </div>
                 <div class="metric-card"><h3 class="text-lg font-semibold mb-3">Rachas</h3><dl class="space-y-2 text-sm"><div class="flex justify-between"><dt>Racha Ganadora Máx.:</dt><dd id="analytics-longest-win-streak" class="font-semibold">0</dd></div><div class="flex justify-between"><dt>Racha Perdedora Máx.:</dt><dd id="analytics-longest-loss-streak" class="font-semibold">0</dd></div><div class="flex justify-between"><dt>Trades Ganadores:</dt><dd id="analytics-total-wins-count" class="font-semibold">0</dd></div><div class="flex justify-between"><dt>Trades Perdedores:</dt><dd id="analytics-total-losses-count" class="font-semibold">0</dd></div><div class="flex justify-between"><dt>Trades Breakeven:</dt><dd id="analytics-total-breakeven-count" class="font-semibold">0</dd></div></dl></div>
                <div class="metric-card"><h3 class="text-lg font-semibold mb-3">Métricas de Riesgo y Consistencia</h3><dl class="space-y-2 text-sm">
                    <div class="flex justify-between"><dt>Drawdown Máximo:</dt><dd id="analytics-max-drawdown" class="font-semibold text-red">$0.00 (0%)</dd></div>
                    <div class="flex justify-between"><dt>Ratio Ganancia/Pérdida Prom:</dt><dd id="analytics-avg-wl-ratio" class="font-semibold">0.00</dd></div>
                    <div class="flex justify-between"><dt>Tiempo Prom. por Operación:</dt><dd id="analytics-avg-hold-time" class="font-semibold">N/A</dd></div>
                    <div class="flex justify-between"><dt>Desv. Estándar del P/L:</dt><dd id="analytics-std-dev-pl" class="font-semibold">$0.00</dd></div>
                </dl></div>
            </div>

             <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div class="metric-card"><h3 class="text-lg font-semibold mb-2">Rendimiento por Mes (Clic para detalles)</h3><div class="overflow-y-auto max-h-72"><table class="w-full"><thead><tr><th>Mes</th><th>P/L</th><th>Trades</th><th>Win %</th></tr></thead><tbody id="analytics-monthly-performance"></tbody></table></div></div>
                <div class="metric-card"><h3 class="text-lg font-semibold mb-2">Rendimiento por Día de la Semana (Clic para detalles)</h3><div class="overflow-y-auto max-h-72"><table class="w-full"><thead><tr><th>Día</th><th>P/L</th><th>Trades</th><th>Win %</th></tr></thead><tbody id="analytics-daily-performance"></tbody></table></div></div>
            </div>

             <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="metric-card"><h3 class="text-lg font-semibold mb-2">Rendimiento por Instrumento (Top 10)</h3><div class="chart-container" style="height: 280px;"><canvas id="analytics-instrument-performance-chart"></canvas></div></div>
                <div class="metric-card"><h3 class="text-lg font-semibold mb-2">Rendimiento por Hora del Día (Entrada)</h3><div class="chart-container" style="height: 280px;"><canvas id="analytics-hourly-performance-chart"></canvas></div></div>
            </div>
        </section>

        <section id="calendar" class="section-container">
            <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                <div class="flex items-center space-x-4">
                    <select id="calendar-account-select" class="w-48"><option value="all">Todas las cuentas</option></select>
                     <div class="currency-switch"><input type="radio" id="cal-usd" name="cal-currency" value="USD" checked><label for="cal-usd">USD</label><input type="radio" id="cal-eur" name="cal-currency" value="EUR"><label for="cal-eur">EUR</label><input type="radio" id="cal-percentage" name="cal-currency" value="%"><label for="cal-percentage">%</label></div>
                </div>
                <div class="flex items-center"><button id="prev-month" class="mr-2 px-3 py-2"><i class="fas fa-chevron-left"></i></button><h2 id="current-month" class="text-xl font-semibold mx-4 w-40 text-center">Abril 2025</h2><button id="next-month" class="ml-2 px-3 py-2"><i class="fas fa-chevron-right"></i></button></div>
            </div>
            <div class="grid grid-cols-8 gap-2 text-center font-bold p-2 mb-2 text-text-secondary"><div>Dom</div><div>Lun</div><div>Mar</div><div>Mié</div><div>Jue</div><div>Vie</div><div>Sáb</div><div>Semana</div></div>
            <div id="calendar-grid" class="grid grid-cols-8 gap-2"></div>
            <div class="mt-8"><h3 class="text-xl font-semibold mb-4">Resumen Mensual</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"><div class="metric-card"><h4 class="text-base mb-1 text-text-secondary">P&L Mensual</h4><p id="monthly-pl" class="text-2xl font-bold text-green">$0.00</p></div><div class="metric-card"><h4 class="text-base mb-1 text-text-secondary">Días Operados</h4><p id="monthly-trading-days" class="text-2xl font-bold text-white">0</p></div><div class="metric-card"><h4 class="text-base mb-1 text-text-secondary">Días Ganadores</h4><p id="monthly-winning-days" class="text-2xl font-bold text-green">0</p></div><div class="metric-card"><h4 class="text-base mb-1 text-text-secondary">Días Perdedores</h4><p id="monthly-losing-days" class="text-2xl font-bold text-red">0</p></div></div></div>
            <div class="mt-8"><h3 class="text-xl font-semibold mb-4">Tendencia Semanal</h3><div class="chart-container"><canvas id="weekly-trend-chart"></canvas></div></div>
        </section>

        <section id="operations" class="section-container">
            <div class="flex flex-wrap justify-between items-center mb-6"><h2 class="text-xl font-semibold">Registro de Operaciones</h2><button id="add-operation-btn" class="primary"><i class="fas fa-plus mr-2"></i>Añadir Operación</button></div>
             <div id="add-operation-form" class="metric-card mb-6" style="display: none;"><h3 class="text-lg font-semibold mb-4">Nueva Operación</h3><form id="operation-details-form"><div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-4"><div><label class="block mb-1">Fecha</label><input type="date" id="op-date"></div><div><label class="block mb-1">Cuenta</label><select id="op-account"></select></div><div class="lg:col-span-2"><label class="block mb-1">Instrumento</label><input type="text" id="op-instrument" placeholder="EURUSD, AAPL, etc."></div><div><label class="block mb-1">Precio de Entrada</label><input type="number" id="op-entry" step="any"></div><div><label class="block mb-1">Hora Entrada</label><input type="time" id="op-entry-time"></div><div><label class="block mb-1">Precio de Salida</label><input type="number" id="op-exit" step="any"></div><div><label class="block mb-1">Hora Salida</label><input type="time" id="op-exit-time"></div><div><label class="block mb-1">Volumen</label><input type="number" id="op-volume" step="any"></div><div><label class="block mb-1">Divisa</label><select id="op-currency"><option value="USD">USD</option><option value="EUR">EUR</option></select></div><div><label class="block mb-1">Tipo</label><select id="op-type"><option value="buy">Compra (Long)</option><option value="sell">Venta (Short)</option></select></div>
                <!-- NUEVO CAMPO: SESIÓN -->
                <div>
                    <label class="block mb-1">Sesión</label>
                    <select id="op-session">
                        <option value="">Seleccionar Sesión</option>
                        <option value="Asia">Asia</option>
                        <option value="Londres">Londres</option>
                        <option value="New York">New York</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>
                <!-- FIN NUEVO CAMPO: SESIÓN -->
                <div><label class="block mb-1">Resultado</label><div class="flex"><button type="button" id="op-win-btn" class="flex-1 mr-1 success">Ganancia</button><button type="button" id="op-loss-btn" class="flex-1 ml-1 danger">Pérdida</button></div></div><div class="md:col-span-2"><label class="block mb-1">Notas</label><textarea id="op-notes" rows="3"></textarea></div><div class="md:col-span-2"><label class="block mb-1">P&L Manual (opcional)</label><input type="number" id="op-manual-pl" step="any" placeholder="Sobrescribe P&L calculado"></div><div class="lg:col-span-4"><label class="block mb-1">Adjuntar Imágenes (Máx. 5)</label><input type="file" id="op-image" accept="image/png, image/jpeg, image/jpg" multiple><div id="op-image-previews-container" class="mt-2 grid grid-cols-3 sm:grid-cols-5 gap-2"></div></div></div><div class="flex justify-end"><button type="button" id="op-cancel" class="mr-2">Cancelar</button><button type="button" id="op-save" class="primary">Guardar</button></div></form></div>
            <div class="flex flex-wrap justify-between items-end mb-4"><div class="flex flex-wrap items-end space-x-4"><div><label for="filter-account" class="block mb-1 text-sm text-text-secondary">Filtrar por cuenta:</label><select id="filter-account" class="w-56 h-12"><option value="all">Todas las cuentas</option></select></div><div class="flex items-end space-x-2"><div><label for="filter-instrument" class="block mb-1 text-sm text-text-secondary">Filtrar por instrumento:</label><input type="text" id="filter-instrument" placeholder="Escribir instrumento..." class="w-56 h-12"></div><button id="operations-date-filter-btn" class="date-filter-trigger p-2 bg-surface rounded h-12" title="Filtrar por fecha"><i class="fas fa-calendar-alt"></i></button></div></div></div>
            <div id="operations-date-filter-display" class="date-filter-display-text text-sm text-text-secondary mb-4">Sin filtro de fecha</div>
            <div class="overflow-x-auto metric-card p-0"><table id="operations-table-render" class="min-w-full">
                <thead>
                    <tr>
                        <th data-sort="date">Fecha</th>
                        <th data-sort="entryTime">H. Entrada</th>
                        <th data-sort="exitTime">H. Salida</th>
                        <th data-sort="accountId">Cuenta</th>
                        <th data-sort="instrument">Instrumento</th>
                        <th data-sort="type">Tipo</th>
                        <th data-sort="entry">Entrada</th>
                        <th data-sort="exit">Salida</th>
                        <th data-sort="volume">Volumen</th>
                        <th data-sort="result">Resultado</th>
                        <th data-sort="pl">P&L</th>
                        <th data-sort="currency">Divisa</th>
                        <th data-sort="session">Sesión</th>
                        <th class="text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody id="operations-table"></tbody>
            </table></div>
        </section>

        <!-- Nueva Sección de Página Completa para Detalles de Operación -->
        <section id="operation-detail-page" class="section-container">
            <button id="back-to-operations-btn" class="mb-4 button"><i class="fas fa-arrow-left mr-2"></i> Volver a Operaciones</button>
            <div class="metric-card p-6">
                <h2 id="op-detail-page-title" class="text-3xl font-bold mb-6 text-primary">Detalles de la Operación</h2>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-6 gap-y-4 mb-6 text-sm">
                    <div><strong>Fecha:</strong> <span id="op-detail-date"></span></div>
                    <div><strong>Cuenta:</strong> <span id="op-detail-account"></span></div>
                    <div><strong>Instrumento:</strong> <span id="op-detail-instrument"></span></div>
                    <div><strong>Tipo:</strong> <span id="op-detail-type"></span></div>
                    <div><strong>Entrada:</strong> <span id="op-detail-entry"></span></div>
                    <div><strong>Hora Entrada:</strong> <span id="op-detail-entry-time"></span></div>
                    <div><strong>Salida:</strong> <span id="op-detail-exit"></div>
                    <div><strong>Hora Salida:</strong> <span id="op-detail-exit-time"></span></div>
                    <div><strong>Volumen:</strong> <span id="op-detail-volume"></span></div>
                    <div><strong>Divisa:</strong> <span id="op-detail-currency"></span></div>
                    <div><strong>P&L Manual:</strong> <span id="op-detail-manual-pl"></span></div>
                    <div><strong>Sesión:</strong> <span id="op-detail-session"></span></div> <!-- CAMPO SESIÓN EN DETALLES -->
                    <div>
                        <strong>Resultado:</strong> <span id="op-detail-result" class="font-semibold"></span>
                        <br>
                        <strong>P&L Neto:</strong> <span id="op-detail-pl" class="font-semibold"></span>
                    </div>
                </div>

                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-2">Notas:</h3>
                    <p id="op-detail-notes" class="text-sm bg-background p-3 rounded min-h-[80px] whitespace-pre-wrap"></p>
                </div>

                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-2">Imágenes Adjuntas:</h3>
                    <div id="op-detail-images" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                        <p class="text-sm text-text-secondary md:col-span-3 text-center">No hay imágenes adjuntas.</p>
                    </div>
                </div>

                <div>
                    <h3 class="text-lg font-semibold mb-2">Análisis de Sesión:</h3>
                    <p class="text-sm mb-3">Esta operación se inició durante la sesión de: <span id="op-detail-session-current" class="font-bold text-primary">N/A</span></p>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr>
                                    <th>Sesión</th>
                                    <th>P&L Total</th>
                                    <th>Trades</th>
                                    <th>Win %</th>
                                </tr>
                            </thead>
                            <tbody id="op-detail-session-metrics">
                                <!-- Las métricas de sesión se rellenarán aquí -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <section id="accounts" class="section-container">
            <div class="flex justify-between items-center mb-6"><h2 class="text-xl font-semibold">Gestión de Cuentas</h2><button id="add-account-btn" class="primary"><i class="fas fa-plus mr-2"></i>Agregar Cuenta</button></div>
            <div id="add-account-form" class="metric-card mb-6" style="display: none;"><h3 class="text-lg font-semibold mb-4">Nueva Cuenta</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><div><label class="block mb-1">Nombre de la cuenta</label><input type="text" id="acc-name" placeholder="FTMO, PropFirm, etc."></div><div><label class="block mb-1">Balance inicial</label><input type="number" id="acc-balance" step="0.01" placeholder="100000"></div><div><label class="block mb-1">Divisa</label><select id="acc-currency"><option value="USD">USD</option><option value="EUR">EUR</option></select></div><div><label class="block mb-1">Plataforma</label><select id="acc-platform"><option value="meta-trader-4">Meta Trader 4</option><option value="meta-trader-5">Meta Trader 5</option><option value="tradelocker">TradeLocker</option><option value="ctrader">cTrader</option><option value="bingx">BingX</option><option value="bitget">Bitget</option><option value="primexbt">PrimeXBT</option><option value="bitunix">Bitunix</option><option value="matchtrader">Machtrader</option><option value="other">Otra</option></select></div></div><div class="flex justify-end"><button id="acc-cancel" class="mr-2">Cancelar</button><button id="acc-save" class="primary">Guardar</button></div></div>
            <div id="accounts-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            <div id="selected-account-details" class="mt-8" style="display: none;">
                <h3 id="account-detail-name" class="text-xl font-semibold mb-4">Detalles de la Cuenta</h3>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-2">Evolución de la Cuenta</h3>
                        <div class="time-range-buttons mb-3 text-sm" id="account-detail-time-range">
                            <button data-range="1W" class="time-range-btn">1S</button>
                            <button data-range="1M" class="time-range-btn">1M</button>
                            <button data-range="3M" class="time-range-btn">3M</button>
                            <button data-range="6M" class="time-range-btn">6M</button>
                            <button data-range="1Y" class="time-range-btn">1A</button>
                            <button data-range="ALL" class="time-range-btn active">Todo</button>
                        </div>
                        <div class="chart-container"><canvas id="account-detail-chart"></canvas></div>
                    </div>
                    <div class="metric-card p-6">
                        <h3 class="text-lg font-semibold mb-4">Métricas de la Cuenta</h3>
                        <div class="grid grid-cols-2 gap-x-8 gap-y-4 mb-4">
                            <div><p class="text-sm text-text-secondary">P&L Total</p><p id="account-detail-pl" class="text-2xl font-bold">$0.00</p></div>
                            <div><p class="text-sm text-text-secondary">Win Rate</p><p id="account-detail-winrate" class="text-2xl font-bold">0%</p></div>
                            <div><p class="text-sm text-text-secondary">Operaciones</p><p id="account-detail-trades" class="text-2xl font-bold">0</p></div>
                            <div><p class="text-sm text-text-secondary">Profit Factor</p><p id="account-detail-pf" class="text-2xl font-bold">0.00</p></div>
                        </div>
                        <h3 class="text-lg font-semibold mb-2 mt-4">Puntuación de Rendimiento</h3>
                        <div class="chart-container" style="height: 220px;">
                            <canvas id="account-detail-radar-chart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
                    <div class="metric-card xl:col-span-1">
                        <h3 class="text-lg font-semibold mb-3">Estadísticas Adicionales</h3>
                        <dl class="space-y-3 text-sm">
                            <div class="flex justify-between"><dt>Drawdown Máximo:</dt><dd id="account-detail-drawdown" class="font-semibold text-red">$0.00 (0%)</dd></div>
                            <div class="flex justify-between"><dt>Ratio Ganancia/Pérdida Prom:</dt><dd id="account-detail-avg-w-l-ratio" class="font-semibold">0.00</dd></div>
                            <div class="flex justify-between"><dt>Racha Ganadora Máx:</dt><dd id="account-detail-win-streak" class="font-semibold">0</dd></div>
                            <div class="flex justify-between"><dt>Racha Perdedora Máx:</dt><dd id="account-detail-loss-streak" class="font-semibold">0</dd></div>
                            <div class="flex justify-between"><dt>Tiempo Prom. por Operación:</dt><dd id="account-detail-hold-time" class="font-semibold">N/A</dd></div>
                        </dl>
                        <h3 class="text-lg font-semibold mt-6 mb-3">Análisis Long/Short</h3>
                        <table class="w-full text-xs"><thead><tr><th>Tipo</th><th>Trades</th><th>P&L</th><th>Win%</th></tr></thead><tbody id="account-long-short-analysis"></tbody></table>
                    </div>
                    <div class="metric-card xl:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><h3 class="text-lg font-semibold mb-2">Mejores Operaciones</h3><table class="w-full"><thead><tr><th>Fecha</th><th>Instrumento</th><th>P&L</th></tr></thead><tbody id="best-trades"></tbody></table></div>
                        <div><h3 class="text-lg font-semibold mb-2">Peores Operaciones</h3><table class="w-full"><thead><tr><th>Fecha</th><th>Instrumento</th><th>P&L</th></tr></thead><tbody id="worst-trades"></tbody></table></div>
                    </div>
                </div>
            </div>
        </section>

        <section id="finances" class="section-container">
            <div class="flex flex-wrap justify-between items-center mb-6"><h2 class="text-xl font-semibold">Finanzas Manuales (Ingresos/Gastos)</h2><button id="add-finance-entry-btn" class="primary"><i class="fas fa-plus mr-2"></i>Añadir Movimiento</button></div>
            <div id="add-finance-entry-form" class="metric-card mb-6" style="display: none;"><h3 class="text-lg font-semibold mb-4">Nuevo Movimiento Financiero</h3><form id="finance-entry-details-form"><div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4"><div><label class="block mb-1">Fecha</label><input type="date" id="finance-date"></div><div><label class="block mb-1">Monto (+/-)</label><input type="number" id="finance-amount" step="any" placeholder="Ej: 500 o -150"></div><div><label class="block mb-1">Divisa</label><select id="finance-currency"><option value="USD">USD</option><option value="EUR">EUR</option></select></div><div class="md:col-span-3"><label class="block mb-1">Descripción / Notas</label><textarea id="finance-notes" rows="2" placeholder="Ej: Retiro de broker, Compra de curso..."></textarea></div></div><div class="flex justify-end"><button type="button" id="finance-cancel-btn" class="mr-2">Cancelar</button><button type="button" id="finance-save-btn" class="primary">Guardar</button></div></form></div>
             <div class="flex flex-wrap justify-between items-start mb-6 gap-4">
                <div><label class="block mb-2 text-text-secondary">Filtrar por fecha:</label><div class="flex items-center space-x-2"><button id="finances-date-filter-btn" class="date-filter-trigger p-2 bg-surface rounded" title="Filtrar por fecha"><i class="fas fa-calendar-alt"></i></button><div id="finances-date-filter-display" class="date-filter-display-text text-sm text-text-secondary">Sin filtro de fecha</div></div></div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 w-full lg:w-auto"><div class="metric-card text-center p-3"><h4 class="text-sm text-text-secondary">P/L de Trading</h4><p id="finance-trading-pl" class="text-xl font-bold text-green">$0.00</p></div><div class="metric-card text-center p-3"><h4 class="text-sm text-text-secondary">Win Rate</h4><p id="finance-win-rate" class="text-xl font-bold text-green">0%</p></div><div class="metric-card text-center p-3"><h4 class="text-sm text-text-secondary">Ingresos</h4><p id="finance-total-income" class="text-xl font-bold text-green">$0.00</p></div><div class="metric-card text-center p-3"><h4 class="text-sm text-text-secondary">Gastos</h4><p id="finance-total-expenses" class="text-xl font-bold text-red">$0.00</p></div><div class="metric-card text-center p-3"><h4 class="text-sm text-text-secondary">Balance Neto</h4><p id="finance-net-balance" class="text-xl font-bold text-white">$0.00</p></div></div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="metric-card"><h3 class="text-lg font-semibold mb-2">Evolución Financiera</h3><div class="chart-container" style="height: 350px;"><canvas id="finances-evolution-chart"></canvas></div></div>
                <div class="metric-card"><h3 class="text-lg font-semibold mb-2">Registro de Movimientos</h3><div class="overflow-y-auto max-h-[350px]"><table id="finances-table" class="w-full"><thead><tr><th class="w-1/4">Fecha</th><th class="w-2/5">Descripción</th><th class="w-1/5">Monto</th><th class="w-1/6">Divisa</th><th class="w-1/5 text-center">Acciones</th></tr></thead><tbody id="finances-table-body"></tbody></table></div></div>
            </div>
        </section>

        <section id="news" class="section-container">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="metric-card p-0 flex flex-col">
                    <h3 class="text-lg font-semibold p-4 pb-2">Calendario de Noticias Económicas</h3>
                    <div class="flex-grow" style="min-height: 600px;">
                        <!-- TradingView Widget BEGIN -->
                        <div class="tradingview-widget-container">
                          <div class="tradingview-widget-container__widget"></div>
                          <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-events.js" async>
                          {
                          "colorTheme": "dark",
                          "isTransparent": true,
                          "width": "100%",
                          "height": "100%",
                          "locale": "es",
                          "importanceFilter": "-1,0,1",
                          "currencyFilter": "USD,EUR,JPY,GBP,CHF,AUD,CAD,NZD,CNY"
                          }
                          </script>
                        </div>
                        <!-- TradingView Widget END -->
                    </div>
                </div>
                <div class="metric-card p-0 flex flex-col">
                    <h3 class="text-lg font-semibold p-4 pb-2">Últimas Noticias del Mercado</h3>
                    <div class="flex-grow" style="min-height: 600px;">
                        <!-- TradingView Widget BEGIN -->
                        <div class="tradingview-widget-container">
                          <div class="tradingview-widget-container__widget"></div>
                          <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-timeline.js" async>
                          {
                          "feedMode": "all_symbols",
                          "colorTheme": "dark",
                          "isTransparent": true,
                          "displayMode": "regular",
                          "width": "100%",
                          "height": "100%",
                          "locale": "es"
                        }
                          </script>
                        </div>
                        <!-- TradingView Widget END -->
                    </div>
                </div>
            </div>
             <div class="metric-card p-4 mt-6">
                <h3 class="text-lg font-semibold mb-2">Visión General del Mercado</h3>
                <!-- TradingView Widget BEGIN -->
                <div class="tradingview-widget-container">
                  <div class="tradingview-widget-container__widget"></div>
                  <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-market-overview.js" async>
                  {
                  "colorTheme": "dark",
                  "dateRange": "12M",
                  "showChart": true,
                  "locale": "es",
                  "largeChartUrl": "",
                  "isTransparent": true,
                  "showSymbolLogo": true,
                  "showFloatingTooltip": false,
                  "width": "100%",
                  "height": "660",
                  "plotLineColorGrowing": "rgba(57, 255, 20, 1)",
                  "plotLineColorFalling": "rgba(255, 65, 54, 1)",
                  "gridLineColor": "rgba(42, 42, 42, 1)",
                  "scaleFontColor": "rgba(160, 160, 160, 1)",
                  "belowLineFillColorGrowing": "rgba(57, 255, 20, 0.12)",
                  "belowLineFillColorFalling": "rgba(255, 65, 54, 0.12)",
                  "belowLineFillColorGrowingBottom": "rgba(57, 255, 20, 0)",
                  "belowLineFillColorFallingBottom": "rgba(255, 65, 54, 0)",
                  "symbolActiveColor": "rgba(57, 255, 20, 0.12)",
                  "tabs": [
                    {
                      "title": "Índices",
                      "symbols": [
                        { "s": "FOREXCOM:SPXUSD", "d": "S&P 500" },
                        { "s": "FOREXCOM:NSXUSD", "d": "US 100" },
                        { "s": "FOREXCOM:DJI", "d": "Dow 30" },
                        { "s": "INDEX:DEU40", "d": "DAX 40" },
                        { "s": "FOREXCOM:UKXGBP", "d": "UK 100" },
                        { "s": "CAPITALCOM:JP225", "d": "Nikkei 225" }
                      ],
                      "originalTitle": "Indices"
                    },
                    {
                      "title": "Criptomonedas",
                      "symbols": [
                        { "s": "BITSTAMP:BTCUSD", "d": "Bitcoin" },
                        { "s": "BITSTAMP:ETHUSD", "d": "Ethereum" },
                        { "s": "COINBASE:SOLUSD", "d": "Solana" },
                        { "s": "COINBASE:XRPUSD", "d": "Ripple" },
                        { "s": "COINBASE:DOGEUSD", "d": "Dogecoin" },
                        { "s": "COINBASE:ADAUSD", "d": "Cardano" }
                      ],
                      "originalTitle": "Cryptocurrencies"
                    },
                    {
                      "title": "Materias primas",
                      "symbols": [
                        { "s": "COMEX:GC1!", "d": "Oro" },
                        { "s": "NYMEX:CL1!", "d": "Petróleo Crudo" },
                        { "s": "TVC:SILVER", "d": "Plata" },
                        { "s": "NYMEX:NG1!", "d": "Gas Natural" },
                        { "s": "TVC:COPPER", "d": "Cobre" },
                        { "s": "CBOT:ZC1!", "d": "Maíz" }
                      ],
                      "originalTitle": "Commodities"
                    },
                    {
                      "title": "Forex",
                      "symbols": [
                        { "s": "FX:EURUSD", "d": "EUR/USD" },
                        { "s": "FX:GBPUSD", "d": "GBP/USD" },
                        { "s": "FX:USDJPY", "d": "USD/JPY" },
                        { "s": "FX:USDCHF", "d": "USD/CHF" },
                        { "s": "FX:AUDUSD", "d": "AUD/USD" },
                        { "s": "FX:USDCAD", "d": "USD/CAD" }
                      ],
                      "originalTitle": "Forex"
                    }
                  ]
                }
                  </script>
                </div>
                <!-- TradingView Widget END -->
            </div>
        </section>

        <section id="config" class="section-container">
            <h2 class="text-xl font-semibold mb-6">Configuración</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="metric-card">
                    <h3 class="text-lg font-semibold mb-4">Integración de APIs (En Desarrollo)</h3><div class="mb-6 opacity-50 pointer-events-none"><h4 class="font-semibold mb-2">cTrader API</h4><div class="grid grid-cols-1 gap-4"><div><label class="block mb-1">Clave API</label><input type="password" id="ctrader-api-key" placeholder="Introduce tu clave API de cTrader" disabled></div><div><label class="block mb-1">Secret API</label><input type="password" id="ctrader-api-secret" placeholder="Introduce tu secret API de cTrader" disabled></div><div><label class="block mb-1">Cuenta a sincronizar</label><select id="ctrader-account" disabled><option value="">Seleccionar cuenta...</option></select></div><div class="flex justify-end"><button id="ctrader-connect" class="primary" disabled>Conectar cTrader</button></div></div><p class="text-xs text-text-secondary mt-2">Tus claves se almacenan localmente.</p></div>
                    <div class="opacity-50 pointer-events-none"><h4 class="font-semibold mb-2">BingX API</h4><div class="grid grid-cols-1 gap-4"><div><label class="block mb-1">Clave API</label><input type="password" id="bingx-api-key" placeholder="Introduce tu clave API de BingX" disabled></div><div><label class="block mb-1">Secret API</label><input type="password" id="bingx-api-secret" placeholder="Introduce tu secret API de BingX" disabled></div><div><label class="block mb-1">Cuenta a sincronizar</label><select id="bingx-account" disabled><option value="">Seleccionar cuenta...</option></select></div><div class="flex justify-end"><button id="bingx-connect" class="primary" disabled>Conectar BingX</button></div></div><p class="text-xs text-text-secondary mt-2">Tus claves se almacenan localmente.</p></div>
                </div>
                <div class="metric-card">
                    <h3 class="text-lg font-semibold mb-4">Ajustes y Datos</h3><div class="mb-6"><h4 class="font-semibold mb-2">Opciones de Visualización</h4><div class="mb-4"><label class="flex items-center mb-2"><input type="checkbox" id="dark-mode" checked disabled><span class="ml-2 opacity-50">Modo oscuro (Siempre activo)</span></label><label class="flex items-center mb-2"><input type="checkbox" id="show-tooltips" checked><span class="ml-2">Mostrar tooltips en gráficos</span></label><label class="flex items-center mb-2"><input type="checkbox" id="auto-refresh" checked disabled><span class="ml-2 opacity-50">Actualizar auto. (Desactivado)</span></label></div></div>
                    <div id="csv-import-section" class="mb-6"><h4 class="font-semibold mb-2">Importar Operaciones desde CSV</h4><div class="grid grid-cols-1 gap-4 items-end"><div><label for="csv-file-input" class="block mb-1">Seleccionar archivo CSV:</label><input type="file" id="csv-file-input" accept=".csv"></div><button id="import-csv-btn" class="primary h-12"><i class="fas fa-upload mr-2"></i>Importar CSV</button></div><p class="text-xs text-text-secondary mt-2">Formato: Nombre Cuenta, Fecha (YYYY-MM-DD), Hora Entrada (HH:MM), Hora Salida (HH:MM), Instrumento, Tipo (buy/sell), Entrada, Salida, Volumen, P&L (opc), Divisa, Notas (opc)</p><div id="csv-import-status" class="mt-2 text-sm"></div></div>
                    <div class="mb-6"><h4 class="font-semibold mb-2">Respaldo y Datos</h4><div class="grid grid-cols-1 gap-4"><button id="export-data" class="primary"><i class="fas fa-download mr-2"></i>Exportar datos (.json)</button><div><label for="import-data" class="block w-full text-center py-3 px-4 bg-surface-light hover:bg-primary hover:text-background cursor-pointer rounded-md transition-all font-bold"><i class="fas fa-upload mr-2"></i>Importar datos (.json)</label><input type="file" id="import-data" class="hidden" accept=".json"></div><button id="clear-data" class="danger"><i class="fas fa-trash-alt mr-2"></i>Borrar todos los datos</button></div></div>
                    <div><h4 class="font-semibold mb-2">Ayuda y Exportar</h4><p class="text-sm mb-4">Exportar como PDF desde el navegador (Ctrl+P / Cmd+P).</p><button id="load-sample-data" class="primary mt-2 w-full"><i class="fas fa-database mr-2"></i>Cargar Datos de Ejemplo</button><button id="test-supabase" class="primary mt-2 w-full"><i class="fas fa-cloud mr-2"></i>Probar Conexión Supabase</button><button id="test-rls" class="primary mt-2 w-full"><i class="fas fa-shield-alt mr-2"></i>Verificar Permisos RLS</button></div>
                </div>
            </div>
        </section>

        <div id="loading" class="loading" style="display: none;"><div class="spinner"></div></div>
        
        <div id="image-modal" class="image-modal"><span class="image-modal-close" id="image-modal-close-btn">&times;</span><span class="image-modal-nav" id="image-modal-prev">&#10094;</span><img class="image-modal-content" id="modal-image-content"><span class="image-modal-nav" id="image-modal-next">&#10095;</span></div>

        <div id="global-calendar-popup" class="absolute z-50 mt-1 p-3 rounded-md shadow-lg hidden" style="border: 1px solid var(--surface-light); width: 280px; background-color: var(--surface);"><div class="flex justify-between items-center mb-2"><button id="popup-cal-prev-month-btn" class="px-2 py-1 hover:bg-surface-light rounded text-sm"><i class="fas fa-chevron-left"></i></button><div id="popup-cal-current-month-year" class="font-semibold text-sm"></div><button id="popup-cal-next-month-btn" class="px-2 py-1 hover:bg-surface-light rounded text-sm"><i class="fas fa-chevron-right"></i></button></div><div class="grid grid-cols-7 gap-1 text-center text-xs mb-1 text-text-secondary"><div>Lu</div><div>Ma</div><div>Mi</div><div>Ju</div><div>Vi</div><div>Sa</div><div>Do</div></div><div id="popup-cal-days-grid" class="grid grid-cols-7 gap-1 text-center"></div><div class="mt-3 space-y-1"><button id="popup-cal-select-week-btn" class="w-full text-xs py-1.5 px-2 bg-surface-light rounded">Semana del Mes Visible</button><button id="popup-cal-select-month-btn" class="w-full text-xs py-1.5 px-2 bg-surface-light rounded">Mes Visible Completo</button><button id="popup-cal-select-semester-btn" class="w-full text-xs py-1.5 px-2 bg-surface-light rounded">Semestre Actual</button><button id="popup-cal-select-year-btn" class="w-full text-xs py-1.5 px-2 bg-surface-light rounded">Año Actual</button><button id="popup-cal-clear-filter-btn" class="w-full text-xs py-1.5 px-2 bg-red-700 hover:bg-red-600 rounded mt-2">Limpiar Filtro de Fecha</button></div></div>

        <div id="day-detail-modal" class="fixed inset-0 hidden items-center justify-center z-[1002] px-4 py-6"><div class="p-5 rounded-lg shadow-xl w-full max-w-3xl text-text relative flex flex-col max-h-[90vh]"><div class="flex justify-between items-center mb-4 pb-3 border-b border-surface-light"><h3 id="day-modal-title" class="text-xl font-semibold">Trades del DD/MM/YYYY</h3><button id="close-day-modal-icon" class="text-2xl text-text-secondary hover:text-text leading-none -mt-1">&times;</button></div><div class="mb-4 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-x-4 gap-y-3 text-sm"><div>P&L Total: <span id="day-total-pl-header" class="font-semibold"></span></div><div>Trades Totales: <span id="day-total-trades-header" class="font-semibold"></span></div><div>Win Rate: <span id="day-win-rate-header" class="font-semibold"></span></div><div>Ganadores: <span id="day-winners-header" class="font-semibold"></span></div><div>Perdedores: <span id="day-losers-header" class="font-semibold"></span></div><div>Volumen: <span id="day-volume-header" class="font-semibold"></span></div><div class="md:col-span-1">Profit Factor: <span id="day-profit-factor-header" class="font-semibold"></span></div></div><div class="overflow-y-auto flex-grow mb-4 border border-surface-light rounded-md"><table class="w-full text-left text-sm"><thead class="sticky top-0 bg-surface z-10"><tr><th class="py-2 px-3">Hora Entrada</th><th class="py-2 px-3">Símbolo</th><th class="py-2 px-3">Tipo</th><th class="py-2 px-3">P&L Neto</th><th class="py-2 px-3">Hora Salida</th></tr></thead><tbody id="day-modal-table-body" class="divide-y divide-surface"></tbody></table></div><div class="text-right pt-4 border-t border-surface-light"><button id="close-day-modal-btn" class="primary px-4 py-2">Cerrar</button></div></div></div>
    
        <!-- --- NUEVO: Modal para Detalles de Analytics --- -->
        <div id="analytics-detail-modal">
            <div class="analytics-detail-container">
                <div class="flex justify-between items-start mb-6">
                    <h2 id="analytics-detail-title" class="text-3xl font-bold text-primary">Análisis Detallado</h2>
                    <button id="analytics-detail-close-btn" class="text-3xl text-text-secondary hover:text-text leading-none">&times;</button>
                </div>
                
                <!-- Métricas principales -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="metric-card"><h3 class="text-sm font-medium text-text-secondary mb-1">P/L Neto</h3><p id="analytics-detail-pl" class="text-3xl font-bold">$0.00</p></div>
                    <div class="metric-card"><h3 class="text-sm font-medium text-text-secondary mb-1">Win Rate</h3><p id="analytics-detail-winrate" class="text-3xl font-bold">0%</p></div>
                    <div class="metric-card"><h3 class="text-sm font-medium text-text-secondary mb-1">Profit Factor</h3><p id="analytics-detail-pf" class="text-3xl font-bold">0.00</p></div>
                    <div class="metric-card"><h3 class="text-sm font-medium text-text-secondary mb-1">Operaciones</h3><p id="analytics-detail-trades" class="text-3xl font-bold">0</p></div>
                </div>

                <!-- Gráficos y Métricas Avanzadas -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <div class="metric-card lg:col-span-1">
                        <h3 class="text-lg font-semibold mb-3">Estadísticas Clave</h3>
                        <dl class="space-y-3 text-sm">
                            <div class="flex justify-between"><dt>Ganancia Promedio:</dt><dd id="analytics-detail-avg-win" class="font-semibold text-green">$0.00</dd></div>
                            <div class="flex justify-between"><dt>Pérdida Promedio:</dt><dd id="analytics-detail-avg-loss" class="font-semibold text-red">$0.00</dd></div>
                            <div class="flex justify-between"><dt>Ratio G/P Promedio:</dt><dd id="analytics-detail-w-l-ratio" class="font-semibold">0.00</dd></div>
                            <div class="flex justify-between"><dt>Mayor Ganancia:</dt><dd id="analytics-detail-largest-win" class="font-semibold text-green">$0.00</dd></div>
                            <div class="flex justify-between"><dt>Mayor Pérdida:</dt><dd id="analytics-detail-largest-loss" class="font-semibold text-red">$0.00</dd></div>
                            <div class="flex justify-between"><dt>Drawdown Máximo:</dt><dd id="analytics-detail-drawdown" class="font-semibold text-red">$0.00</dd></div>
                        </dl>
                    </div>
                     <div class="metric-card lg:col-span-2">
                        <h3 class="text-lg font-semibold mb-2">Puntuación de Rendimiento</h3>
                        <div class="chart-container" style="height: 250px;">
                            <canvas id="analytics-detail-radar-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Más Gráficos -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-2">Rendimiento por Instrumento</h3>
                        <div class="chart-container" style="height: 280px;">
                            <canvas id="analytics-detail-instrument-chart"></canvas>
                        </div>
                    </div>
                    <div class="metric-card">
                        <h3 class="text-lg font-semibold mb-2">Rendimiento Long vs Short</h3>
                        <div class="chart-container" style="height: 280px;">
                            <canvas id="analytics-detail-long-short-chart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Tabla de Operaciones -->
                <div class="metric-card p-0">
                    <h3 class="text-lg font-semibold p-4">Operaciones del Período</h3>
                    <div class="overflow-y-auto max-h-96">
                        <table class="w-full text-sm">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Instrumento</th>
                                    <th>Tipo</th>
                                    <th>Entrada</th>
                                    <th>Salida</th>
                                    <th>Volumen</th>
                                    <th>P&L</th>
                                </tr>
                            </thead>
                            <tbody id="analytics-detail-table-body">
                                <!-- Las operaciones se insertarán aquí -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        const dexieDB = new Dexie('TraderSurvivorDB');
        dexieDB.version(5).stores({
            accounts: 'id,name,currency,platform',
            operations: 'id,date,accountId,instrument,result,currency', 
            finances: '++id,date',
            generalData: 'key',
        });

        const DB = {
            accounts: [],
            operations: [],
            finances: [], 
            settings: { showTooltips: true, defaultCurrency: 'USD' },
            apiKeys: { ctrader: {}, bingx: {} }
        };

        let globalDateFilter = { type: 'all', startDate: null, endDate: null, display: 'Sin filtro de fecha' };
        let popupCalendarStateDate = new Date();
        const monthNamesShort = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
        let currentEditingOpImages = [];
        let modalImageList = [];
        let modalImageIndex = 0;
        // NUEVO: Estado para el ordenamiento de la tabla de operaciones
        let operationSortState = { column: 'date', order: 'desc' };


        async function loadData() {
            showLoading(true);
            try {
                const [accounts, operations, finances, storedSettings, storedApiKeys] = await Promise.all([
                    dexieDB.accounts.toArray(),
                    dexieDB.operations.toArray(),
                    dexieDB.finances.toArray(), 
                    dexieDB.generalData.get('settings'),
                    dexieDB.generalData.get('apiKeys')
                ]);

                DB.accounts = accounts || [];
                DB.operations = operations || [];
                DB.finances = finances || []; 

                if (storedSettings) {
                    DB.settings = { ...{ darkMode: true, showTooltips: true, autoRefresh: false, defaultCurrency: 'USD' }, ...storedSettings };
                } else {
                    await dexieDB.generalData.put(DB.settings, 'settings');
                }
                
                if (storedApiKeys) {
                    DB.apiKeys = { ...{ ctrader: { key: '', secret: '', accountId: '' }, bingx: { key: '', secret: '', accountId: '' } }, ...storedApiKeys };
                } else {
                    await dexieDB.generalData.put(DB.apiKeys, 'apiKeys');
                }


                let operationsToUpdateInDB = [];
                DB.operations.forEach(op => {
                    let changes = {};
                    let hasChanged = false;

                    if (op.date && op.date.includes('/')) {
                        const parts = op.date.split('/');
                        if (parts.length === 3) {
                            op.date = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                            changes.date = op.date;
                            hasChanged = true;
                        }
                    }
                    if (typeof op.imageData !== 'undefined' && op.imageData !== null) {
                        if (typeof op.imageDatas === 'undefined' || !Array.isArray(op.imageDatas) || op.imageDatas.length === 0) {
                            op.imageDatas = [op.imageData];
                            changes.imageDatas = op.imageDatas;
                            changes.imageData = Dexie.delete; // Eliminar la propiedad antigua
                            hasChanged = true;
                        }
                        delete op.imageData; 
                    } else if (typeof op.imageDatas === 'undefined' || !Array.isArray(op.imageDatas)) {
                         op.imageDatas = []; 
                         changes.imageDatas = [];
                         if (typeof op.imageData !== 'undefined') {
                            changes.imageData = Dexie.delete;
                            delete op.imageData;
                         }
                         hasChanged = true;
                    }

                    if (typeof op.manualPL === 'undefined') {op.manualPL = null; changes.manualPL = null; hasChanged = true;}
                    if (typeof op.entryTime === 'undefined') {op.entryTime = null; changes.entryTime = null; hasChanged = true;}
                    if (typeof op.exitTime === 'undefined') {op.exitTime = null; changes.exitTime = null; hasChanged = true;}
                    // Añadir migración para el nuevo campo 'session'
                    if (typeof op.session === 'undefined') {op.session = null; changes.session = null; hasChanged = true;}
                    
                    if(hasChanged) {
                        operationsToUpdateInDB.push({key: op.id, changes: changes});
                    }
                });

                if (operationsToUpdateInDB.length > 0) {
                    await dexieDB.operations.bulkUpdate(operationsToUpdateInDB);
                }


            } catch (e) {
                console.error('Error loading data from DexieDB:', e);
            } finally {
                showLoading(false);
            }
        }
        
        async function addSampleData() {
            if (!confirm("Esto reemplazará todos los datos existentes con datos de ejemplo. ¿Continuar?")) {
                return;
            }
            showLoading(true);
            const sampleAccounts = [
                { id: 'acc1', name: 'FTMO Challenge', balance: 100000, initialBalance: 100000, currency: 'USD', platform: 'meta-trader-4' },
                { id: 'acc2', name: 'MyFxFunds', balance: 50000, initialBalance: 50000, currency: 'EUR', platform: 'ctrader' },
                { id: 'acc3', name: 'BingX Cripto', balance: 10000, initialBalance: 10000, currency: 'USD', platform: 'bingx' }
            ];
            const today = new Date();
            const d = (offset) => { const date = new Date(today); date.setDate(today.getDate() - offset); return date.toISOString().split('T')[0]; };
            const sampleOperations = [
                { id: 'op1', date: d(30), entryTime: '09:30', exitTime: '11:45', accountId: 'acc1', instrument: 'EURUSD', type: 'buy', entry: 1.0750, exit: 1.0830, volume: 10, result: 'win', pl: 8000, currency: 'USD', notes: 'Breakout diario', imageDatas: [], manualPL: null, session: 'Londres' },
                { id: 'op2', date: d(25), entryTime: '14:00', exitTime: '15:30', accountId: 'acc1', instrument: 'GBPUSD', type: 'sell', entry: 1.2650, exit: 1.2590, volume: 5, result: 'win', pl: 3000, currency: 'USD', notes: 'Rechazo soporte', imageDatas: [], manualPL: null, session: 'New York' },
                { id: 'op3', date: d(22), entryTime: '10:15', exitTime: '10:55', accountId: 'acc2', instrument: 'AUDCAD', type: 'buy', entry: 0.8950, exit: 0.8920, volume: 1, result: 'loss', pl: -300, currency: 'EUR', notes: 'Falsa ruptura', imageDatas: [], manualPL: null, session: 'Londres' },
                { id: 'op4', date: d(20), entryTime: '16:00', exitTime: '18:10', accountId: 'acc3', instrument: 'BTCUSDT', type: 'buy', entry: 65000, exit: 64500, volume: 0.1, result: 'loss', pl: -5000, currency: 'USD', notes: 'Liquidación en cascada', imageDatas: [], manualPL: null, session: 'New York' },
                { id: 'op5', date: d(15), entryTime: '08:00', exitTime: '12:00', accountId: 'acc1', instrument: 'US30', type: 'buy', entry: 38000, exit: 38250, volume: 2, result: 'win', pl: 5000, currency: 'USD', notes: 'Sentimiento de mercado positivo', imageDatas: [], manualPL: null, session: 'Londres' },
                { id: 'op6', date: d(10), entryTime: '11:00', exitTime: '11:30', accountId: 'acc2', instrument: 'EURJPY', type: 'sell', entry: 168.50, exit: 168.90, volume: 3, result: 'loss', pl: -800, currency: 'EUR', notes: 'Entrada prematura', imageDatas: [], manualPL: null, session: 'Londres' },
                { id: 'op7', date: d(5), entryTime: '09:45', exitTime: '14:00', accountId: 'acc1', instrument: 'XAUUSD', type: 'buy', entry: 2300, exit: 2325, volume: 1, result: 'win', pl: 2500, currency: 'USD', notes: 'Aumento de tensión geopolítica', imageDatas: [], manualPL: null, session: 'Londres' },
            ];
             const sampleFinances = [
                { id: 1, date: d(40), amount: -150, currency: 'USD', notes: 'Suscripción TradingView' },
                { id: 2, date: d(20), amount: 1000, currency: 'USD', notes: 'Retiro de Broker X' },
                { id: 3, date: d(10), amount: -250, currency: 'EUR', notes: 'Curso de Trading' },
            ];
            try {
                await dexieDB.transaction('rw', dexieDB.accounts, dexieDB.operations, dexieDB.finances, async () => {
                    await dexieDB.accounts.clear();
                    await dexieDB.operations.clear();
                    await dexieDB.finances.clear();
                    await dexieDB.accounts.bulkPut(sampleAccounts);
                    await dexieDB.operations.bulkPut(sampleOperations);
                    await dexieDB.finances.bulkPut(sampleFinances);
                });
                
                DB.accounts = sampleAccounts;
                DB.operations = sampleOperations;
                DB.finances = sampleFinances;
                
                // Guardar datos de ejemplo en Supabase
                if (currentUser) {
                    console.log('💾 Guardando datos de ejemplo en Supabase...');
                    
                    // Limpiar datos existentes en Supabase primero
                    await Promise.all([
                        supabase.from('accounts').delete().eq('user_id', currentUser.id),
                        supabase.from('operations').delete().eq('user_id', currentUser.id),
                        supabase.from('finances').delete().eq('user_id', currentUser.id)
                    ]);
                    
                    // Guardar cuentas
                    for (const account of sampleAccounts) {
                        await saveAccountToSupabase(account);
                    }
                    
                    // Guardar operaciones
                    for (const operation of sampleOperations) {
                        await saveOperationToSupabase(operation);
                    }
                    
                    // Guardar finanzas
                    for (const finance of sampleFinances) {
                        const supabaseData = await saveFinanceToSupabase(finance);
                        if (supabaseData) {
                            finance.supabase_id = supabaseData.id;
                        }
                    }
                    
                    console.log('✅ Datos de ejemplo guardados en Supabase');
                }
                
                updateAccountBalances();
                updateGlobalDateFilter({ type: 'all', startDate: null, endDate: null, display: 'Sin filtro de fecha' });
                refreshAllViews();
                alert("Datos de ejemplo cargados.");
            } catch (e) {
                console.error("Failed to add sample data to DexieDB", e);
                alert("Error al añadir datos de ejemplo.");
            } finally {
                showLoading(false);
            }
        }

        function updateAccountBalances() {
            DB.accounts.forEach(account => {
                account.balance = account.initialBalance;
                const accountOps = DB.operations.filter(op => op.accountId === account.id);
                accountOps.forEach(operation => {
                    let pl = operation.pl;
                    if (operation.currency !== account.currency) {
                        pl = convertCurrency(pl, operation.currency, account.currency);
                    }
                    account.balance += pl;
                });
                account.balance = Math.round(account.balance * 100) / 100;
            });
        }

        function convertCurrency(amount, fromCurrency, toCurrency) {
            const rates = { 'USD_EUR': 0.92, 'EUR_USD': 1.09 };
            if (fromCurrency === toCurrency) return amount;
            const rateKey = `${fromCurrency}_${toCurrency}`;
            if (rates[rateKey]) return amount * rates[rateKey];
            console.warn(`Tasa de conversión no encontrada para ${fromCurrency} a ${toCurrency}. Usando 1:1.`);
            return amount;
        }

        function formatCurrency(amount, baseCurrency = null, displayCurrency = null) {
            const currencyToDisplay = displayCurrency || document.querySelector('input[name="currency"]:checked').value;

            if (amount === 0 || typeof amount === 'undefined' || amount === null) {
                return currencyToDisplay === '%' ? '0.00%' : currencyToDisplay === 'EUR' ? '€0.00' : '$0.00';
            }
            const amountActualCurrency = baseCurrency || DB.settings.defaultCurrency;

            if (currencyToDisplay === '%') {
                const activeTab = document.querySelector('.nav-tab.active')?.dataset.target;
                let accountSelectId;
                if (activeTab === 'dashboard') accountSelectId = 'dashboard-account-select';
                else if (activeTab === 'analytics') accountSelectId = 'analytics-account-select';
                else if (activeTab === 'calendar') accountSelectId = 'calendar-account-select';

                if (!accountSelectId) return (amount > 0 ? '+' : '') + amount.toFixed(2);

                const selectedAccountFilterInput = document.getElementById(accountSelectId);
                const selectedAccountFilter = selectedAccountFilterInput ? selectedAccountFilterInput.value : 'all';

                let initialBalanceInDefault = 0;
                if (selectedAccountFilter === 'all') {
                    initialBalanceInDefault = DB.accounts.reduce((sum, acc) => {
                        let balance = acc.initialBalance;
                        if (acc.currency !== DB.settings.defaultCurrency) {
                            balance = convertCurrency(balance, acc.currency, DB.settings.defaultCurrency);
                        }
                        return sum + balance;
                    }, 0);
                } else {
                    const foundAccount = DB.accounts.find(a => a.id === selectedAccountFilter);
                    if (foundAccount) {
                        initialBalanceInDefault = foundAccount.initialBalance;
                        if (foundAccount.currency !== DB.settings.defaultCurrency) {
                            initialBalanceInDefault = convertCurrency(initialBalanceInDefault, foundAccount.currency, DB.settings.defaultCurrency);
                        }
                    }
                }
                if (initialBalanceInDefault === 0) return '0.00%';

                let amountInDefault = amount;
                if (amountActualCurrency !== DB.settings.defaultCurrency) {
                    amountInDefault = convertCurrency(amount, amountActualCurrency, DB.settings.defaultCurrency);
                }
                const percentage = (amountInDefault / initialBalanceInDefault) * 100;
                return percentage.toFixed(2) + '%';
            }

            let displayAmount = amount;
            if (amountActualCurrency !== currencyToDisplay) {
                displayAmount = convertCurrency(amount, amountActualCurrency, currencyToDisplay);
            }
            const options = { minimumFractionDigits: 2, maximumFractionDigits: 2 };
            if (currencyToDisplay === 'EUR') {
                return '€' + displayAmount.toLocaleString('es-ES', options);
            } else {
                return '$' + displayAmount.toLocaleString('en-US', options);
            }
        }


        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substring(2, 9);
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                const date = dateString.includes('T') ? new Date(dateString) : new Date(dateString + 'T00:00:00');
                if (isNaN(date.getTime())) return dateString;
                const day = String(date.getUTCDate()).padStart(2, '0');
                const month = String(date.getUTCMonth() + 1).padStart(2, '0');
                const year = date.getUTCFullYear();
                return `${day}/${month}/${year}`;
            } catch (e) {
                console.warn("Error formatting date:", dateString, e);
                return dateString;
            }
        }

        function formatPlatformName(platformValue) {
            const names = {
                'meta-trader-4': 'Meta Trader 4',
                'meta-trader-5': 'Meta Trader 5',
                'tradelocker': 'TradeLocker',
                'ctrader': 'cTrader',
                'bingx': 'BingX',
                'bitget': 'Bitget',
                'primexbt': 'PrimeXBT',
                'bitunix': 'Bitunix',
                'matchtrader': 'Machtrader',
                'other': 'Otra'
            };
            return names[platformValue] || platformValue;
        }


        function getStartDateForRange(range) {
            const endDate = new Date();
            let startDate = new Date();
            switch (range) {
                case '1W': startDate.setDate(endDate.getDate() - 7); break;
                case '1M': startDate.setMonth(endDate.getMonth() - 1); break;
                case '3M': startDate.setMonth(endDate.getMonth() - 3); break;
                case '6M': startDate.setMonth(endDate.getMonth() - 6); break;
                case '1Y': startDate.setFullYear(endDate.getFullYear() - 1); break;
                case 'ALL': default: return null;
            }
            return startDate.toISOString().split('T')[0];
        }

        function applyDateFilterToData(dataArray) {
            if (globalDateFilter.type === 'all' || !globalDateFilter.startDate || !globalDateFilter.endDate) {
                return dataArray;
            }
            return dataArray.filter(item => {
                const itemDate = item.date;
                return itemDate >= globalDateFilter.startDate && itemDate <= globalDateFilter.endDate;
            });
        }


        function initDashboard() {
            updateAccountSelect('dashboard-account-select');
            refreshDashboard();
            document.getElementById('dashboard-account-select').addEventListener('change', refreshDashboard);
            document.querySelectorAll('input[name="currency"]').forEach(radio => {
                radio.addEventListener('change', refreshDashboard);
            });
        }

        function refreshDashboard() {
            if (!document.getElementById('dashboard').classList.contains('active')) return;
            const selectedAccount = document.getElementById('dashboard-account-select').value;
            const displayCurrency = document.querySelector('input[name="currency"]:checked').value;

            let operationsForMetrics = applyDateFilterToData(DB.operations);

            if (selectedAccount !== 'all') {
                operationsForMetrics = operationsForMetrics.filter(op => op.accountId === selectedAccount);
            }

            const metrics = calculateMetrics(operationsForMetrics, selectedAccount);
            const advancedMetrics = calculateAdvancedMetrics(operationsForMetrics, selectedAccount);
            const totalPL = metrics.totalWin + metrics.totalLoss;

            const balanceEl = document.getElementById('current-balance');
            balanceEl.textContent = formatCurrency(totalPL, DB.settings.defaultCurrency, displayCurrency);
            balanceEl.className = `text-3xl font-bold ${totalPL >= 0 ? 'text-green' : 'text-negative'}`;

            document.getElementById('win-rate').textContent = metrics.winRate.toFixed(0) + '%';
            document.getElementById('profit-factor').textContent = isFinite(metrics.profitFactor) ? metrics.profitFactor.toFixed(2) : "∞";
            document.getElementById('total-trades').textContent = metrics.totalTrades;
            
            document.getElementById('dashboard-total-win').textContent = formatCurrency(metrics.totalWin, DB.settings.defaultCurrency, displayCurrency);
            document.getElementById('dashboard-total-loss').textContent = formatCurrency(metrics.totalLoss, DB.settings.defaultCurrency, displayCurrency);

            const avgWinEl = document.getElementById('dashboard-avg-win');
            avgWinEl.textContent = formatCurrency(advancedMetrics.avgWin, DB.settings.defaultCurrency, displayCurrency);

            const avgLossEl = document.getElementById('dashboard-avg-loss');
            avgLossEl.textContent = formatCurrency(advancedMetrics.avgLoss, DB.settings.defaultCurrency, displayCurrency);

            const avgPlEl = document.getElementById('dashboard-avg-pl');
            avgPlEl.textContent = formatCurrency(advancedMetrics.avgPLPerTrade, DB.settings.defaultCurrency, displayCurrency);
            avgPlEl.className = `text-2xl font-bold ${advancedMetrics.avgPLPerTrade >= 0 ? 'text-white' : 'text-negative'}`;

            const activeRangeButton = document.querySelector('#dashboard .time-range-btn.active');
            const timeRange = activeRangeButton ? activeRangeButton.dataset.range : 'ALL';

            let opsForEvolutionChart = applyDateFilterToData(DB.operations);
            if (selectedAccount !== 'all') {
                opsForEvolutionChart = opsForEvolutionChart.filter(op => op.accountId === selectedAccount);
            }
            updateAccountEvolutionChart(opsForEvolutionChart, selectedAccount, timeRange);

            updateDashboardRadarChart(operationsForMetrics, selectedAccount);
            updateInstrumentPerformanceChart(operationsForMetrics, 'instrument-performance-chart');
            updateDayPerformanceChart(operationsForMetrics, 'day-performance-chart');
            updateTypePerformanceChart(operationsForMetrics, 'type-performance-chart');
        }
        function calculateMetrics(operations, accountId = 'all') {
            let currentBalance = 0;
            let initialBalance = 0;
            let accountCurrency = DB.settings.defaultCurrency;
            let totalWin = 0;
            let totalLoss = 0;
            let winningTrades = 0;
            let losingTrades = 0;
            let breakevenTrades = 0;

            if (accountId !== 'all') {
                const account = DB.accounts.find(a => a.id === accountId);
                if (account) {
                    currentBalance = account.balance;
                    initialBalance = account.initialBalance;
                    accountCurrency = account.currency;
                }
            } else {
                DB.accounts.forEach(account => {
                    let accBalance = account.balance;
                    let accInitialBalance = account.initialBalance;
                    if (account.currency !== DB.settings.defaultCurrency) {
                        accBalance = convertCurrency(accBalance, account.currency, DB.settings.defaultCurrency);
                        accInitialBalance = convertCurrency(accInitialBalance, account.currency, DB.settings.defaultCurrency);
                    }
                    currentBalance += accBalance;
                    initialBalance += accInitialBalance;
                });
                accountCurrency = DB.settings.defaultCurrency;
            }

            operations.forEach(op => {
                let plInDefaultCurrency = op.pl;
                if (op.currency !== DB.settings.defaultCurrency) {
                    plInDefaultCurrency = convertCurrency(plInDefaultCurrency, op.currency, DB.settings.defaultCurrency);
                }

                if (op.result === 'win') {
                    totalWin += plInDefaultCurrency;
                    winningTrades++;
                } else if (op.result === 'loss') {
                    totalLoss += plInDefaultCurrency;
                    losingTrades++;
                } else if (op.result === 'breakeven') {
                    breakevenTrades++;
                }
            });

            const totalTrades = operations.length;
            const relevantTradesForWinRate = winningTrades + losingTrades;
            const winRate = relevantTradesForWinRate > 0 ? (winningTrades / relevantTradesForWinRate) * 100 : 0;
            const profitFactor = Math.abs(totalLoss) > 0 ? Math.abs(totalWin / totalLoss) : (totalWin > 0 ? Infinity : 0);

            return {
                currentBalance, initialBalance, accountCurrency,
                totalWin,
                totalLoss,
                winningTrades, losingTrades, breakevenTrades, totalTrades,
                winRate, profitFactor
            };
        }

        let accountEvolutionChart = null;
        function updateAccountEvolutionChart(allAccountOps, accountId, timeRange = 'ALL') {
            const ctx = document.getElementById('account-evolution-chart').getContext('2d');
            if (accountEvolutionChart) accountEvolutionChart.destroy();
            const displayCurrency = document.querySelector('input[name="currency"]:checked').value;

            const startDateStringForChartRange = getStartDateForRange(timeRange);
            let chartOps = allAccountOps;
            if (startDateStringForChartRange) {
                chartOps = allAccountOps.filter(op => op.date >= startDateStringForChartRange);
            }
            chartOps = [...chartOps].sort((a, b) => new Date(a.date + 'T' + (a.entryTime || "00:00:00")) - new Date(b.date + 'T' + (b.entryTime || "00:00:00")));

            let startingBalance = 0;
            let chartTargetCurrency = displayCurrency === '%' ? DB.settings.defaultCurrency : displayCurrency;
            let initialBalanceForPercentCalc = 0;

            if (accountId !== 'all') {
                const account = DB.accounts.find(a => a.id === accountId);
                if (account) {
                    startingBalance = account.initialBalance;
                    initialBalanceForPercentCalc = convertCurrency(account.initialBalance, account.currency, chartTargetCurrency);
                    if (account.currency !== chartTargetCurrency) {
                        startingBalance = convertCurrency(startingBalance, account.currency, chartTargetCurrency);
                    }
                    const operationsBeforeChartRange = DB.operations.filter(op =>
                        op.accountId === accountId &&
                        op.date < (chartOps.length > 0 ? chartOps[0].date : new Date().toISOString().split('T')[0]) &&
                        (!globalDateFilter.startDate || op.date >= globalDateFilter.startDate)
                    );
                    operationsBeforeChartRange.forEach(op => {
                        let pl = op.pl;
                        if (op.currency !== chartTargetCurrency) {
                            pl = convertCurrency(pl, op.currency, chartTargetCurrency);
                        }
                        startingBalance += pl;
                    });
                }
            } else {
                startingBalance = DB.accounts.reduce((sum, acc) => {
                    let accEffectiveInitialBalance = acc.initialBalance;
                    const opsBeforeRangeForThisAccount = DB.operations.filter(op =>
                        op.accountId === acc.id &&
                        op.date < (chartOps.length > 0 ? chartOps[0].date : new Date().toISOString().split('T')[0]) &&
                        (!globalDateFilter.startDate || op.date >= globalDateFilter.startDate)
                    );
                    opsBeforeRangeForThisAccount.forEach(op => {
                        let pl = op.pl;
                        if (op.currency !== acc.currency) {
                            pl = convertCurrency(pl, op.currency, acc.currency);
                        }
                        accEffectiveInitialBalance += pl;
                    });
                    if (acc.currency !== chartTargetCurrency) {
                        accEffectiveInitialBalance = convertCurrency(accEffectiveInitialBalance, acc.currency, chartTargetCurrency);
                    }
                    return sum + accEffectiveInitialBalance;
                }, 0);

                initialBalanceForPercentCalc = DB.accounts.reduce((sum, acc) => {
                    let iBalance = acc.initialBalance;
                    if (acc.currency !== chartTargetCurrency) {
                        iBalance = convertCurrency(iBalance, acc.currency, chartTargetCurrency);
                    }
                    return sum + iBalance;
                }, 0);
            }

            const labels = ['Inicio'];
            const dataPoints = [startingBalance];
            chartOps.reduce((balance, op) => {
                let pl = op.pl;
                if (op.currency !== chartTargetCurrency) pl = convertCurrency(pl, op.currency, chartTargetCurrency);
                const newBalance = balance + pl;
                dataPoints.push(newBalance);
                labels.push(formatDate(op.date));
                return newBalance;
            }, startingBalance);

            const finalData = displayCurrency === '%' && initialBalanceForPercentCalc !== 0
                ? dataPoints.map(val => ((val / initialBalanceForPercentCalc) * 100) - 100)
                : dataPoints;

            const yAxisFormatter = displayCurrency === '%'
                ? (val) => (val > 0 ? '+' : '') + val.toFixed(1) + '%'
                : (val) => formatCurrency(val, chartTargetCurrency, chartTargetCurrency);

            accountEvolutionChart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets: [{ label: 'Balance', data: finalData, borderColor: '#FFFFFF', backgroundColor: 'rgba(255, 255, 255, 0.1)', borderWidth: 2, fill: true, tension: 0.4, pointRadius: 0, pointHoverRadius: 5, pointHoverBackgroundColor: '#FFFFFF' }] },
                options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => `Balance: ${yAxisFormatter(c.raw)}` } } }, scales: { x: { grid: { color: '#2a2a2a' }, ticks: { color: '#FFFFFF' } }, y: { grid: { color: '#2a2a2a' }, ticks: { color: '#FFFFFF', callback: yAxisFormatter }, zeroLineColor: '#2a2a2a' } } }
            });
        }

        let dashboardRadarChart = null;
        function updateDashboardRadarChart(operations, accountId, chartId = 'dashboard-radar-chart') {
            const ctx = document.getElementById(chartId)?.getContext('2d');
            if (!ctx) return;
            // Destruir el gráfico existente basado en el ID del canvas
            if (chartId === 'dashboard-radar-chart' && dashboardRadarChart) {
                dashboardRadarChart.destroy();
            } else if (chartId === 'analytics-detail-radar-chart' && window.analyticsDetailRadarChart) {
                window.analyticsDetailRadarChart.destroy();
            }

            const basicMetrics = calculateMetrics(operations, accountId);
            const advancedMetrics = calculateAdvancedMetrics(operations, accountId);

            let maxDrawdownPercentage = 0;
            if (operations.length > 0) {
                const sortedOps = [...operations].sort((a, b) => new Date(a.date + 'T' + (a.entryTime || '00:00')) - new Date(b.date + 'T' + (b.entryTime || '00:00')));
                let accountInitialBalance = 0;
                let accountCurrency = DB.settings.defaultCurrency;

                if (accountId !== 'all') {
                    const account = DB.accounts.find(a => a.id === accountId);
                    if (account) {
                        accountInitialBalance = account.initialBalance;
                        accountCurrency = account.currency;
                    }
                } else {
                    accountInitialBalance = DB.accounts.reduce((sum, acc) => sum + convertCurrency(acc.initialBalance, acc.currency, DB.settings.defaultCurrency), 0);
                }

                if (accountInitialBalance > 0) {
                    let peakBalance = accountInitialBalance;
                    let maxDrawdownValue = 0;
                    let currentBalance = accountInitialBalance;
                    sortedOps.forEach(op => {
                        let pl = convertCurrency(op.pl, op.currency, accountCurrency);
                        currentBalance += pl;
                        if (currentBalance > peakBalance) peakBalance = currentBalance;
                        const drawdown = peakBalance - currentBalance;
                        if (drawdown > maxDrawdownValue) maxDrawdownValue = drawdown;
                    });
                    maxDrawdownPercentage = (maxDrawdownValue / accountInitialBalance) * 100;
                }
            }


            const winRateScore = basicMetrics.winRate || 0;
            const profitFactorScore = Math.min(basicMetrics.profitFactor / 3, 1) * 100; // PF of 3.0 is 100%
            const avgWLRatio = advancedMetrics.avgWin && advancedMetrics.avgLoss ? Math.abs(advancedMetrics.avgWin / advancedMetrics.avgLoss) : 0;
            const avgWLRatioScore = Math.min(avgWLRatio / 3, 1) * 100; // Ratio of 3.0 is 100%
            const drawdownScore = Math.max(0, (1 - Math.min(maxDrawdownPercentage / 20, 1)) * 100); // 20% DD is 0 score

            let consistencyScore = 0;
            if (operations.length > 1) {
                const tradingDays = new Set(operations.map(op => op.date));
                if (tradingDays.size > 0) {
                    const dailyPL = {};
                    operations.forEach(op => {
                        if (!dailyPL[op.date]) dailyPL[op.date] = 0;
                        dailyPL[op.date] += convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency);
                    });
                    const winningDays = Object.values(dailyPL).filter(pl => pl > 0).length;
                    consistencyScore = (winningDays / tradingDays.size) * 100;
                }
            }
            
            const radarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Win %', 'Profit Factor', 'Avg Win/Loss', 'Drawdown Ctrl', 'Consistencia'],
                    datasets: [{
                        label: 'Puntuación',
                        data: [winRateScore, profitFactorScore, avgWLRatioScore, drawdownScore, consistencyScore],
                        fill: true,
                        backgroundColor: 'rgba(57, 255, 20, 0.2)',
                        borderColor: 'rgba(57, 255, 20, 0.8)',
                        pointBackgroundColor: 'var(--primary)',
                        pointBorderColor: '#0a0a0a',
                        pointHoverBackgroundColor: '#FFFFFF',
                        pointHoverBorderColor: 'var(--primary)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            min: 0,
                            max: 100,
                            angleLines: { color: '#2a2a2a' },
                            grid: { color: '#2a2a2a' },
                            pointLabels: { color: '#FFFFFF', font: { size: 11 } },
                            ticks: { display: false, stepSize: 20 }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });

            // Asignar la nueva instancia de gráfico a la variable correcta
            if (chartId === 'dashboard-radar-chart') {
                dashboardRadarChart = radarChart;
            } else if (chartId === 'analytics-detail-radar-chart') {
                window.analyticsDetailRadarChart = radarChart;
            }
        }

        let instrumentPerformanceChart = null;
        let analyticsInstrumentPerformanceChart = null;
        function updateInstrumentPerformanceChart(operations, chartId) {
            const ctx = document.getElementById(chartId)?.getContext('2d');
            if (!ctx) return;
            if (chartId === 'instrument-performance-chart' && instrumentPerformanceChart) instrumentPerformanceChart.destroy();
            if (chartId === 'analytics-instrument-performance-chart' && analyticsInstrumentPerformanceChart) analyticsInstrumentPerformanceChart.destroy();
            if (chartId === 'analytics-detail-instrument-chart' && window.analyticsDetailInstrumentChart) window.analyticsDetailInstrumentChart.destroy();

            const performance = {};
            operations.forEach(op => {
                const instrumentKey = op.instrument.toUpperCase();
                if (!performance[instrumentKey]) performance[instrumentKey] = { total: 0 };
                performance[instrumentKey].total += convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency);
            });
            const sorted = Object.entries(performance).sort((a, b) => b[1].total - a[1].total).slice(0, 10);
            const chart = new Chart(ctx, { type: 'bar', data: { labels: sorted.map(item => item[0]), datasets: [{ data: sorted.map(item => item[1].total), backgroundColor: sorted.map(item => item[1].total >= 0 ? 'rgba(57, 255, 20, 0.7)' : 'rgba(255, 65, 54, 0.7)') }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { color: '#2a2a2a' }, ticks: { color: '#FFFFFF' } }, y: { grid: { display: false }, ticks: { color: '#FFFFFF' } } } } });
            
            if (chartId === 'instrument-performance-chart') instrumentPerformanceChart = chart;
            else if (chartId === 'analytics-instrument-performance-chart') analyticsInstrumentPerformanceChart = chart;
            else if (chartId === 'analytics-detail-instrument-chart') window.analyticsDetailInstrumentChart = chart;

        }

        let dayPerformanceChart = null;
        function updateDayPerformanceChart(operations, chartId) {
            const ctx = document.getElementById(chartId)?.getContext('2d');
            if (!ctx) return;
            if (dayPerformanceChart) dayPerformanceChart.destroy();
            const days = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
            const performance = Array(7).fill(0);
            operations.forEach(op => { const day = new Date(op.date + 'T00:00:00').getUTCDay(); performance[day] += convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency); });
            dayPerformanceChart = new Chart(ctx, { type: 'bar', data: { labels: days, datasets: [{ data: performance, backgroundColor: performance.map(v => v >= 0 ? 'rgba(57, 255, 20, 0.7)' : 'rgba(255, 65, 54, 0.7)') }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false }, ticks: { color: '#FFFFFF' } }, y: { grid: { color: '#2a2a2a' }, ticks: { color: '#FFFFFF' } } } } });
        }

        let typePerformanceChart = null;
        function updateTypePerformanceChart(operations, chartId) {
            const ctx = document.getElementById(chartId)?.getContext('2d');
            if (!ctx) return;
            if (chartId === 'type-performance-chart' && typePerformanceChart) typePerformanceChart.destroy();
            if (chartId === 'analytics-detail-long-short-chart' && window.analyticsDetailLongShortChart) window.analyticsDetailLongShortChart.destroy();


            const calcPL = (type, result) => operations
                .filter(op => op.type === type && op.result === result)
                .reduce((sum, op) => sum + convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency), 0);

            const buyWin = calcPL('buy', 'win');
            const buyLoss = calcPL('buy', 'loss');
            const sellWin = calcPL('sell', 'win');
            const sellLoss = calcPL('sell', 'loss');

            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Compra (Long)', 'Venta (Short)'],
                    datasets: [
                        {
                            label: 'Ganancias',
                            data: [buyWin, sellWin],
                            backgroundColor: 'rgba(57, 255, 20, 0.7)'
                        },
                        {
                            label: 'Pérdidas',
                            data: [buyLoss, sellLoss],
                            backgroundColor: 'rgba(255, 65, 54, 0.7)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#a0a0a0' } } },
                    scales: {
                        x: { stacked: true, grid: { display: false }, ticks: { color: '#FFFFFF' } },
                        y: { stacked: true, grid: { color: '#2a2a2a' }, ticks: { color: '#FFFFFF' } }
                    }
                }
            });

            if (chartId === 'type-performance-chart') typePerformanceChart = chart;
            else if (chartId === 'analytics-detail-long-short-chart') window.analyticsDetailLongShortChart = chart;

        }
        
        let financesEvolutionChart = null;
        function updateFinancesEvolutionChart(entries) {
            const ctx = document.getElementById('finances-evolution-chart').getContext('2d');
            if (financesEvolutionChart) financesEvolutionChart.destroy();

            const sortedEntries = [...entries].sort((a, b) => new Date(a.date) - new Date(b.date));
            const chartTargetCurrency = DB.settings.defaultCurrency;

            const labels = ['Inicio'];
            const dataPoints = [0];
            let currentBalance = 0;

            sortedEntries.forEach(entry => {
                let amountInTargetCurrency = entry.amount;
                if (entry.currency !== chartTargetCurrency) {
                    amountInTargetCurrency = convertCurrency(entry.amount, entry.currency, chartTargetCurrency);
                }
                currentBalance += amountInTargetCurrency;
                dataPoints.push(currentBalance);
                labels.push(formatDate(entry.date));
            });

            const yAxisFormatter = (val) => formatCurrency(val, chartTargetCurrency, chartTargetCurrency);

            financesEvolutionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `Balance en ${chartTargetCurrency}`,
                        data: dataPoints,
                        borderColor: '#FFFFFF',
                        backgroundColor: 'rgba(255, 255, 255, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { display: false }, tooltip: { callbacks: { label: (ctx) => `Balance: ${yAxisFormatter(ctx.raw)}` } } },
                    scales: {
                        x: { grid: { display: false }, ticks: { color: '#FFFFFF' } },
                        y: { grid: { color: '#2a2a2a' }, ticks: { color: '#FFFFFF', callback: yAxisFormatter } }
                    }
                }
            });
        }
        
        let weeklyTrendChart = null;
        function updateWeeklyTrendChart(weekOperationsData, baseCurrency, initialBalanceForPercent) {
            const ctx = document.getElementById('weekly-trend-chart').getContext('2d'); if (weeklyTrendChart) weeklyTrendChart.destroy();

            const sortedWeeks = Object.values(weekOperationsData).sort((a, b) => parseInt(a.weekNumber) - parseInt(b.weekNumber));
            const labels = sortedWeeks.map(week => 'Sem ' + week.weekNumber);
            const dataPL = sortedWeeks.map(week => week.totalPL);
            const dataTrades = sortedWeeks.map(week => week.count);
            const currencyMode = document.querySelector('input[name="cal-currency"]:checked').value;

            weeklyTrendChart = new Chart(ctx, {
                 type: 'bar', data: { labels: labels, datasets: [{ label: 'P&L', data: dataPL, backgroundColor: dataPL.map(v => v >= 0 ? 'rgba(57, 255, 20, 0.7)' : 'rgba(255, 65, 54, 0.7)'), yAxisID: 'y' }, { label: 'Operaciones', data: dataTrades, type: 'line', fill: false, borderColor: '#a0a0a0', borderWidth: 2, pointRadius: 4, pointBackgroundColor: '#a0a0a0', yAxisID: 'y1' }] },
                 options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display: false}, tooltip: { enabled: DB.settings.showTooltips, callbacks: { label: (ctx) => { if (ctx.dataset.label === 'P&L') { let fPL; if (currencyMode === '%') { const p = initialBalanceForPercent > 0 ? (ctx.raw / initialBalanceForPercent) * 100 : 0; fPL = p.toFixed(2) + '%'; } else { fPL = formatCurrency(ctx.raw, baseCurrency, currencyMode); } return 'P&L: ' + fPL; } else { return 'Operaciones: ' + ctx.raw; } } } } }, scales: { x: { grid: { display: false }, ticks: { color: '#FFFFFF' } }, y: { position: 'left', grid: { color: '#2a2a2a' }, ticks: { color: '#FFFFFF', callback: (val) => { if (currencyMode === '%') { const p = initialBalanceForPercent > 0 ? (val / initialBalanceForPercent) * 100 : 0; return p.toFixed(1) + '%'; } else { return formatCurrency(val, baseCurrency, currencyMode); } } } }, y1: { position: 'right', grid: { drawOnChartArea: false }, ticks: { color: '#a0a0a0', stepSize: 1 }, min: 0 } } }
            });
        }
        
        let accountDetailChart = null;
        function updateAccountDetailChart(account, allAccountOps, timeRange = 'ALL') {
            const ctx = document.getElementById('account-detail-chart').getContext('2d');
            if (accountDetailChart) accountDetailChart.destroy();
            const chartTargetCurrency = account.currency;

            const startDateString = getStartDateForRange(timeRange);
            let chartOps = allAccountOps;
             if (startDateString) {
                 chartOps = allAccountOps.filter(op => op.date >= startDateString);
             }
            chartOps = [...chartOps].sort((a, b) => new Date(a.date + 'T00:00:00Z') - new Date(b.date + 'T00:00:00Z'));

            let startingBalance = account.initialBalance;
            if (startDateString) {
                const opsBeforeRange = DB.operations.filter(op =>
                    op.accountId === account.id && op.date < startDateString
                );
                opsBeforeRange.forEach(op => {
                    let pl = op.pl;
                    if (op.currency !== chartTargetCurrency) {
                        pl = convertCurrency(pl, op.currency, chartTargetCurrency);
                    }
                    startingBalance += pl;
                });
            }

            const labels = ['Inicio'];
            const data = [startingBalance];
            let currentBalance = startingBalance;
            chartOps.forEach(op => {
                let pl = op.pl;
                if (op.currency !== chartTargetCurrency) pl = convertCurrency(pl, op.currency, chartTargetCurrency);
                currentBalance += pl; data.push(currentBalance); labels.push(formatDate(op.date));
            });
            accountDetailChart = new Chart(ctx, {
                type: 'line', data: { labels: labels, datasets: [{ label: 'Balance', data: data, borderColor: '#FFFFFF', backgroundColor: 'rgba(255, 255, 255, 0.1)', borderWidth: 2, fill: true, tension: 0.1, pointRadius: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, plugins: { tooltip: { enabled: DB.settings.showTooltips, callbacks: { title: (ctx) => ctx[0].label, label: (ctx) => 'Balance: ' + formatCurrency(ctx.raw, chartTargetCurrency, chartTargetCurrency) } }, legend: { display: false } }, scales: { x: { grid: { display: false }, ticks: { color: '#FFFFFF'} }, y: { grid: { color: '#2a2a2a' }, ticks: { color: '#FFFFFF', callback: (val) => formatCurrency(val, chartTargetCurrency, chartTargetCurrency) } } } }
            });
        }

        function calculateAdvancedMetrics(operations, accountId = 'all') {
            const metrics = calculateMetrics(operations, accountId);
            let totalPLInDefault = metrics.totalWin + metrics.totalLoss;

            const avgWin = metrics.winningTrades > 0 ? metrics.totalWin / metrics.winningTrades : 0;
            const avgLoss = metrics.losingTrades > 0 ? metrics.totalLoss / metrics.losingTrades : 0;
            const avgPLPerTrade = metrics.totalTrades > 0 ? totalPLInDefault / metrics.totalTrades : 0;

            const lossRateNormalized = (metrics.winningTrades + metrics.losingTrades) > 0 ? metrics.losingTrades / (metrics.winningTrades + metrics.losingTrades) : 0;
            const expectancy = ((metrics.winRate / 100) * avgWin) - (lossRateNormalized * Math.abs(avgLoss));

            let largestWin = 0;
            let largestLoss = 0;
            operations.forEach(op => {
                let plInDefault = op.pl;
                if (op.currency !== DB.settings.defaultCurrency) {
                    plInDefault = convertCurrency(plInDefault, op.currency, DB.settings.defaultCurrency);
                }
                if (op.result === 'win' && plInDefault > largestWin) largestWin = plInDefault;
                if (op.result === 'loss' && plInDefault < largestLoss) largestLoss = plInDefault;
            });

            let longestWinStreak = 0;
            let currentWinStreak = 0;
            let longestLossStreak = 0;
            let currentLossStreak = 0;

            const sortedOpsByDate = [...operations].sort((a,b) => new Date(a.date + 'T00:00:00Z') - new Date(b.date + 'T00:00:00Z'));

            sortedOpsByDate.forEach(op => {
                if (op.result === 'win') {
                    currentWinStreak++;
                    currentLossStreak = 0;
                    if (currentWinStreak > longestWinStreak) longestWinStreak = currentWinStreak;
                } else if (op.result === 'loss') {
                    currentLossStreak++;
                    currentWinStreak = 0;
                    if (currentLossStreak > longestLossStreak) longestLossStreak = currentLossStreak;
                } else {
                    currentWinStreak = 0;
                    currentLossStreak = 0;
                }
            });

            return {
                avgWin, avgLoss, avgPLPerTrade, expectancy,
                largestWin, largestLoss,
                longestWinStreak, longestLossStreak
            };
        }
        
        function calculateExtraAnalytics(operations, accountId = 'all') {
            const sortedOps = [...operations].sort((a, b) => new Date(a.date + 'T' + (a.entryTime || '00:00')) - new Date(b.date + 'T' + (b.entryTime || '00:00')));

            // --- Max Drawdown Calculation ---
            let initialBalanceForDD = 0;
            let currencyForDD = DB.settings.defaultCurrency;

            if (accountId !== 'all') {
                const account = DB.accounts.find(a => a.id === accountId);
                if (account) {
                    initialBalanceForDD = account.initialBalance;
                    currencyForDD = account.currency;
                }
            } else {
                initialBalanceForDD = DB.accounts.reduce((sum, acc) => sum + convertCurrency(acc.initialBalance, acc.currency, currencyForDD), 0);
            }
            
            let peakBalance = initialBalanceForDD;
            let maxDrawdownValue = 0;
            let currentBalance = initialBalanceForDD;
            sortedOps.forEach(op => {
                let pl = convertCurrency(op.pl, op.currency, currencyForDD);
                currentBalance += pl;
                if (currentBalance > peakBalance) peakBalance = currentBalance;
                const drawdown = peakBalance - currentBalance;
                if (drawdown > maxDrawdownValue) maxDrawdownValue = drawdown;
            });
            const maxDrawdownPercentage = initialBalanceForDD > 0 ? (maxDrawdownValue / initialBalanceForDD) * 100 : 0;

            // --- Average Holding Time ---
            let totalDurationMinutes = 0, tradesWithDuration = 0;
            operations.forEach(op => {
                if (op.entryTime && op.exitTime) {
                    try {
                        const startDate = new Date(`1970-01-01T${op.entryTime}`);
                        const endDate = new Date(`1970-01-01T${op.exitTime}`);
                        let duration = (endDate - startDate) / 60000;
                        if (duration < 0) duration += 24 * 60; // Overnight
                        totalDurationMinutes += duration;
                        tradesWithDuration++;
                    } catch (e) { /* ignore */ }
                }
            });
            let avgHoldTimeText = 'N/A';
            if (tradesWithDuration > 0) {
                const avgMinutes = totalDurationMinutes / tradesWithDuration;
                if (avgMinutes < 1) avgHoldTimeText = `${(avgMinutes * 60).toFixed(0)} seg`;
                else if (avgMinutes < 60) avgHoldTimeText = `${avgMinutes.toFixed(0)} min`;
                else avgHoldTimeText = `${Math.floor(avgMinutes / 60)}h ${Math.round(avgMinutes % 60)}m`;
            }

            // --- Standard Deviation of P/L ---
            let stdDevPL = 0;
            if (operations.length > 1) {
                const plsInDefaultCurrency = operations.map(op => convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency));
                const mean = plsInDefaultCurrency.reduce((sum, val) => sum + val, 0) / plsInDefaultCurrency.length;
                const variance = plsInDefaultCurrency.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / plsInDefaultCurrency.length;
                stdDevPL = Math.sqrt(variance);
            }

            // --- Average Win/Loss Ratio ---
            const basicMetrics = calculateMetrics(operations, accountId);
            const advancedMetricsForRatio = calculateAdvancedMetrics(operations, accountId);
            const avgWLRatio = Math.abs(advancedMetricsForRatio.avgLoss) > 0 ? Math.abs(advancedMetricsForRatio.avgWin / advancedMetricsForRatio.avgLoss) : (advancedMetricsForRatio.avgWin > 0 ? Infinity : 0);

            return {
                maxDrawdownValue, maxDrawdownPercentage, currencyForDD,
                avgHoldTimeText,
                stdDevPL,
                avgWLRatio
            };
        }


        function initAnalytics() {
            updateAccountSelect('analytics-account-select');
            refreshAnalytics();
            document.getElementById('analytics-account-select').addEventListener('change', refreshAnalytics);
            document.querySelectorAll('input[name="currency"]').forEach(radio => {
                radio.addEventListener('change', refreshAnalytics);
            });
            // NUEVO: Listeners para el modal de detalles
            document.getElementById('analytics-detail-close-btn').addEventListener('click', closeAnalyticsDetailModal);
            document.getElementById('analytics-detail-modal').addEventListener('click', (e) => {
                 if (e.target.id === 'analytics-detail-modal') {
                    closeAnalyticsDetailModal();
                }
            });
        }

        function refreshAnalytics() {
            if (!document.getElementById('analytics').classList.contains('active')) return;
            const selectedAccount = document.getElementById('analytics-account-select').value;
            let operationsForAnalytics = applyDateFilterToData(DB.operations);
            if (selectedAccount !== 'all') {
                operationsForAnalytics = operationsForAnalytics.filter(op => op.accountId === selectedAccount);
            }
            const displayCurrency = document.querySelector('input[name="currency"]:checked').value;

            const basicMetrics = calculateMetrics(operationsForAnalytics, selectedAccount);
            const advancedMetrics = calculateAdvancedMetrics(operationsForAnalytics, selectedAccount);
            const extraMetrics = calculateExtraAnalytics(operationsForAnalytics, selectedAccount);

            const totalPlEl = document.getElementById('analytics-total-pl');
            totalPlEl.textContent = formatCurrency(basicMetrics.totalWin + basicMetrics.totalLoss, DB.settings.defaultCurrency, displayCurrency);
            totalPlEl.className = `text-2xl font-bold ${(basicMetrics.totalWin + basicMetrics.totalLoss) >= 0 ? 'text-green' : 'text-negative'}`;

            document.getElementById('analytics-win-rate').textContent = basicMetrics.winRate.toFixed(0) + '%';
            document.getElementById('analytics-profit-factor').textContent = isFinite(basicMetrics.profitFactor) ? basicMetrics.profitFactor.toFixed(2) : "∞";
            document.getElementById('analytics-total-trades').textContent = basicMetrics.totalTrades;

            document.getElementById('analytics-avg-win').textContent = formatCurrency(advancedMetrics.avgWin, DB.settings.defaultCurrency, displayCurrency);
            document.getElementById('analytics-avg-loss').textContent = formatCurrency(advancedMetrics.avgLoss, DB.settings.defaultCurrency, displayCurrency);
            
            const avgPlTradeEl = document.getElementById('analytics-avg-pl-trade');
            avgPlTradeEl.textContent = formatCurrency(advancedMetrics.avgPLPerTrade, DB.settings.defaultCurrency, displayCurrency);
            avgPlTradeEl.className = `font-semibold ${advancedMetrics.avgPLPerTrade >= 0 ? 'text-white' : 'text-negative'}`;
            
            const expectancyEl = document.getElementById('analytics-expectancy');
            expectancyEl.textContent = formatCurrency(advancedMetrics.expectancy, DB.settings.defaultCurrency, displayCurrency);
            expectancyEl.className = `font-semibold ${advancedMetrics.expectancy >= 0 ? 'text-green' : 'text-negative'}`;

            document.getElementById('analytics-largest-win').textContent = formatCurrency(advancedMetrics.largestWin, DB.settings.defaultCurrency, displayCurrency);
            document.getElementById('analytics-largest-loss').textContent = formatCurrency(advancedMetrics.largestLoss, DB.settings.defaultCurrency, displayCurrency);

            document.getElementById('analytics-longest-win-streak').textContent = advancedMetrics.longestWinStreak;
            document.getElementById('analytics-longest-loss-streak').textContent = advancedMetrics.longestLossStreak;
            document.getElementById('analytics-total-wins-count').textContent = basicMetrics.winningTrades;
            document.getElementById('analytics-total-losses-count').textContent = basicMetrics.losingTrades;
            document.getElementById('analytics-total-breakeven-count').textContent = basicMetrics.breakevenTrades;
            
            // Populate new extra metrics
            document.getElementById('analytics-max-drawdown').textContent = `${formatCurrency(extraMetrics.maxDrawdownValue, extraMetrics.currencyForDD, displayCurrency)} (${extraMetrics.maxDrawdownPercentage.toFixed(1)}%)`;
            const avgWLRatioEl = document.getElementById('analytics-avg-wl-ratio');
            avgWLRatioEl.textContent = isFinite(extraMetrics.avgWLRatio) ? extraMetrics.avgWLRatio.toFixed(2) : "∞";
            avgWLRatioEl.className = `font-semibold ${extraMetrics.avgWLRatio >= 1 ? 'text-green' : 'text-negative'}`;
            document.getElementById('analytics-avg-hold-time').textContent = extraMetrics.avgHoldTimeText;
            document.getElementById('analytics-std-dev-pl').textContent = formatCurrency(extraMetrics.stdDevPL, DB.settings.defaultCurrency, displayCurrency);


            populateAnalyticsDailyPerformance(operationsForAnalytics, selectedAccount);
            populateAnalyticsMonthlyPerformance(operationsForAnalytics, selectedAccount);
            updateInstrumentPerformanceChart(operationsForAnalytics, 'analytics-instrument-performance-chart');
            updateHourlyPerformanceChart(operationsForAnalytics, 'analytics-hourly-performance-chart');
        }

        let analyticsHourlyPerformanceChart = null;
        function updateHourlyPerformanceChart(operations, chartId) {
            const ctx = document.getElementById(chartId)?.getContext('2d');
            if (!ctx) return;

            if (analyticsHourlyPerformanceChart) {
                analyticsHourlyPerformanceChart.destroy();
            }

            const hourlyPerformance = Array(24).fill(0);
            operations.forEach(op => {
                if (op.entryTime) {
                    try {
                        const hour = parseInt(op.entryTime.split(':')[0], 10);
                        if (!isNaN(hour) && hour >= 0 && hour <= 23) {
                             hourlyPerformance[hour] += convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency);
                        }
                    } catch(e) { /* ignore invalid time */ }
                }
            });
            
            const labels = Array.from({length: 24}, (_, i) => `${String(i).padStart(2, '0')}:00`);

            analyticsHourlyPerformanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'P/L por Hora',
                        data: hourlyPerformance,
                        backgroundColor: hourlyPerformance.map(v => v >= 0 ? 'rgba(57, 255, 20, 0.7)' : 'rgba(255, 65, 54, 0.7)')
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false }, ticks: { color: '#FFFFFF', maxRotation: 90, minRotation: 45, autoSkip: true, maxTicksLimit: 12 } },
                        y: { grid: { color: '#2a2a2a' }, ticks: { color: '#FFFFFF' } }
                    }
                }
            });
        }


        function populateAnalyticsDailyPerformance(operations, accountId) {
            const tbody = document.getElementById('analytics-daily-performance');
            if (!tbody) return;
            tbody.innerHTML = '';
            const displayCurrency = document.querySelector('input[name="currency"]:checked').value;
            const targetCurrency = displayCurrency === '%' ? DB.settings.defaultCurrency : displayCurrency;

            const daysOfWeek = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
            const dailyPerformance = daysOfWeek.map(() => ({ pl: 0, trades: 0, wins: 0, losses: 0 }));

            operations.forEach(op => {
                const dayIndex = new Date(op.date + 'T00:00:00Z').getUTCDay();
                let plConverted = op.pl;
                if (op.currency !== targetCurrency) {
                    plConverted = convertCurrency(op.pl, op.currency, targetCurrency);
                }
                dailyPerformance[dayIndex].pl += plConverted;
                dailyPerformance[dayIndex].trades++;
                if (op.result === 'win') dailyPerformance[dayIndex].wins++;
                if (op.result === 'loss') dailyPerformance[dayIndex].losses++;
            });

            let initialBalanceForPercent = 0;
            if (displayCurrency === '%') {
                if (accountId === 'all') {
                    initialBalanceForPercent = DB.accounts.reduce((sum, acc) => sum + convertCurrency(acc.initialBalance, acc.currency, targetCurrency), 0);
                } else {
                    const account = DB.accounts.find(a => a.id === accountId);
                    if (account) initialBalanceForPercent = convertCurrency(account.initialBalance, account.currency, targetCurrency);
                }
            }

            daysOfWeek.forEach((dayName, index) => {
                const dayData = dailyPerformance[index];
                if (dayData.trades === 0) return; // No mostrar días sin operaciones

                const winRate = (dayData.wins + dayData.losses) > 0 ? (dayData.wins / (dayData.wins + dayData.losses)) * 100 : 0;
                let plDisplay;
                if (displayCurrency === '%') {
                    plDisplay = initialBalanceForPercent !== 0 ? ((dayData.pl / initialBalanceForPercent) * 100).toFixed(2) + '%' : '0.00%';
                } else {
                    plDisplay = formatCurrency(dayData.pl, targetCurrency, targetCurrency);
                }
                const plClass = dayData.pl > 0 ? 'text-positive' : (dayData.pl < 0 ? 'text-negative' : 'text-neutral');

                const row = document.createElement('tr');
                row.dataset.dayIndex = index; // Guardar el índice del día
                row.innerHTML = `
                    <td>${dayName}</td>
                    <td class="${plClass}">${plDisplay}</td>
                    <td>${dayData.trades}</td>
                    <td class="text-green">${winRate.toFixed(1)}%</td>
                `;
                // NUEVO: Añadir listener para abrir modal
                row.addEventListener('click', () => openAnalyticsDetailModal('dayOfWeek', index, dayName));
                tbody.appendChild(row);
            });
        }

        function populateAnalyticsMonthlyPerformance(operations, accountId) {
            const tbody = document.getElementById('analytics-monthly-performance');
            if (!tbody) return;
            tbody.innerHTML = '';
            const displayCurrency = document.querySelector('input[name="currency"]:checked').value;
            const targetCurrency = displayCurrency === '%' ? DB.settings.defaultCurrency : displayCurrency;

            const monthlyPerformance = {};

            operations.forEach(op => {
                const opDate = new Date(op.date + 'T00:00:00Z');
                const monthKey = `${opDate.getUTCFullYear()}-${String(opDate.getUTCMonth() + 1).padStart(2, '0')}`;
                if (!monthlyPerformance[monthKey]) {
                    monthlyPerformance[monthKey] = { pl: 0, trades: 0, wins: 0, losses: 0, year: opDate.getUTCFullYear(), monthIndex: opDate.getUTCMonth() };
                }
                let plConverted = op.pl;
                if (op.currency !== targetCurrency) {
                    plConverted = convertCurrency(op.pl, op.currency, targetCurrency);
                }
                monthlyPerformance[monthKey].pl += plConverted;
                monthlyPerformance[monthKey].trades++;
                if (op.result === 'win') monthlyPerformance[monthKey].wins++;
                if (op.result === 'loss') monthlyPerformance[monthKey].losses++;
            });

            let initialBalanceForPercent = 0;
            if (displayCurrency === '%') {
                 if (accountId === 'all') {
                    initialBalanceForPercent = DB.accounts.reduce((sum, acc) => sum + convertCurrency(acc.initialBalance, acc.currency, targetCurrency), 0);
                } else {
                    const account = DB.accounts.find(a => a.id === accountId);
                    if (account) initialBalanceForPercent = convertCurrency(account.initialBalance, account.currency, targetCurrency);
                }
            }

            Object.keys(monthlyPerformance).sort().reverse().forEach(monthKey => {
                const monthData = monthlyPerformance[monthKey];
                const winRate = (monthData.wins + monthData.losses) > 0 ? (monthData.wins / (monthData.wins + monthData.losses)) * 100 : 0;
                let plDisplay;
                 if (displayCurrency === '%') {
                    plDisplay = initialBalanceForPercent !== 0 ? ((monthData.pl / initialBalanceForPercent) * 100).toFixed(2) + '%' : '0.00%';
                } else {
                    plDisplay = formatCurrency(monthData.pl, targetCurrency, targetCurrency);
                }
                const plClass = monthData.pl > 0 ? 'text-positive' : (monthData.pl < 0 ? 'text-negative' : 'text-neutral');
                const fullMonthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                const monthLabel = `${fullMonthNames[monthData.monthIndex]} ${monthData.year}`;

                const row = document.createElement('tr');
                row.dataset.monthKey = monthKey; // Guardar la clave del mes
                row.innerHTML = `
                    <td>${monthLabel}</td>
                    <td class="${plClass}">${plDisplay}</td>
                    <td>${monthData.trades}</td>
                    <td class="text-green">${winRate.toFixed(1)}%</td>
                `;
                // NUEVO: Añadir listener para abrir modal
                row.addEventListener('click', () => openAnalyticsDetailModal('month', monthKey, monthLabel));
                tbody.appendChild(row);
            });
             if (Object.keys(monthlyPerformance).length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-text-secondary py-3">No hay datos</td></tr>';
            }
        }
        
        // --- NUEVO: Funciones para el Modal de Detalles de Analytics ---
        function openAnalyticsDetailModal(type, value, titleLabel) {
            const modal = document.getElementById('analytics-detail-modal');
            document.getElementById('analytics-detail-title').textContent = `Análisis de ${titleLabel}`;

            // 1. Filtrar las operaciones
            let periodOperations = [];
            const selectedAccount = document.getElementById('analytics-account-select').value;
            let sourceOps = applyDateFilterToData(DB.operations); // Usar operaciones ya filtradas por fecha global
             if (selectedAccount !== 'all') {
                sourceOps = sourceOps.filter(op => op.accountId === selectedAccount);
            }

            if (type === 'month') {
                const [year, month] = value.split('-');
                periodOperations = sourceOps.filter(op => op.date.startsWith(value));
            } else if (type === 'dayOfWeek') {
                periodOperations = sourceOps.filter(op => new Date(op.date + 'T00:00:00Z').getUTCDay() === value);
            }

            // 2. Calcular Métricas para el período
            const displayCurrency = document.querySelector('input[name="currency"]:checked').value;
            const metrics = calculateMetrics(periodOperations, selectedAccount);
            const advancedMetrics = calculateAdvancedMetrics(periodOperations, selectedAccount);
            const extraMetrics = calculateExtraAnalytics(periodOperations, selectedAccount);

            const totalPL = metrics.totalWin + metrics.totalLoss;

            // 3. Poblar el modal
            const plEl = document.getElementById('analytics-detail-pl');
            plEl.textContent = formatCurrency(totalPL, DB.settings.defaultCurrency, displayCurrency);
            plEl.className = `text-3xl font-bold ${totalPL >= 0 ? 'text-positive' : 'text-negative'}`;
            document.getElementById('analytics-detail-winrate').textContent = `${metrics.winRate.toFixed(1)}%`;
            document.getElementById('analytics-detail-pf').textContent = isFinite(metrics.profitFactor) ? metrics.profitFactor.toFixed(2) : "∞";
            document.getElementById('analytics-detail-trades').textContent = metrics.totalTrades;

            document.getElementById('analytics-detail-avg-win').textContent = formatCurrency(advancedMetrics.avgWin, DB.settings.defaultCurrency, displayCurrency);
            document.getElementById('analytics-detail-avg-loss').textContent = formatCurrency(advancedMetrics.avgLoss, DB.settings.defaultCurrency, displayCurrency);
            document.getElementById('analytics-detail-largest-win').textContent = formatCurrency(advancedMetrics.largestWin, DB.settings.defaultCurrency, displayCurrency);
            document.getElementById('analytics-detail-largest-loss').textContent = formatCurrency(advancedMetrics.largestLoss, DB.settings.defaultCurrency, displayCurrency);
            
            const wLRatioEl = document.getElementById('analytics-detail-w-l-ratio');
            wLRatioEl.textContent = isFinite(extraMetrics.avgWLRatio) ? extraMetrics.avgWLRatio.toFixed(2) : '∞';
            wLRatioEl.className = `font-semibold ${extraMetrics.avgWLRatio >= 1 ? 'text-green' : 'text-negative'}`;

            document.getElementById('analytics-detail-drawdown').textContent = formatCurrency(extraMetrics.maxDrawdownValue, extraMetrics.currencyForDD, displayCurrency);

            // 4. Renderizar Gráficos
            updateDashboardRadarChart(periodOperations, selectedAccount, 'analytics-detail-radar-chart');
            updateInstrumentPerformanceChart(periodOperations, 'analytics-detail-instrument-chart');
            updateTypePerformanceChart(periodOperations, 'analytics-detail-long-short-chart');


            // 5. Poblar tabla de operaciones
            const tableBody = document.getElementById('analytics-detail-table-body');
            tableBody.innerHTML = '';
            periodOperations.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(op => {
                const plClass = op.pl >= 0 ? 'text-positive' : 'text-negative';
                const precision = getInstrumentPrecision(op.instrument);
                tableBody.innerHTML += `
                    <tr class="cursor-pointer" data-id="${op.id}">
                        <td>${formatDate(op.date)}</td>
                        <td>${op.instrument}</td>
                        <td class="${op.type === 'buy' ? 'text-positive' : 'text-negative'}">${op.type === 'buy' ? 'Long' : 'Short'}</td>
                        <td>${op.entry !== null ? op.entry.toFixed(precision) : '-'}</td>
                        <td>${op.exit !== null ? op.exit.toFixed(precision) : '-'}</td>
                        <td>${op.volume}</td>
                        <td class="${plClass}">${formatCurrency(op.pl, op.currency, op.currency)}</td>
                    </tr>
                `;
            });

            tableBody.querySelectorAll('tr').forEach(row => {
                row.addEventListener('click', () => {
                    const opId = row.dataset.id;
                    if(opId) {
                        closeAnalyticsDetailModal();
                        showOperationDetailPage(opId);
                    }
                });
            });

            // 6. Mostrar el modal
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden'; // Evitar scroll del fondo
        }

        function closeAnalyticsDetailModal() {
            const modal = document.getElementById('analytics-detail-modal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
        // --- FIN de Funciones para el Modal de Detalles de Analytics ---

        function initFinances() {
            document.getElementById('add-finance-entry-btn').addEventListener('click', () => toggleAddFinanceEntryForm());
            document.getElementById('finance-cancel-btn').addEventListener('click', () => toggleAddFinanceEntryForm());
            document.getElementById('finance-save-btn').addEventListener('click', saveFinanceEntry);
            document.getElementById('finances-table-body').addEventListener('click', handleFinancesTableClick);
            refreshFinancesView();
        }

        function toggleAddFinanceEntryForm(entryToEdit = null) {
            const formContainer = document.getElementById('add-finance-entry-form');
            const isVisible = formContainer.style.display === 'block';

            if (!isVisible) {
                formContainer.style.display = 'block';
                document.getElementById('add-finance-entry-btn').textContent = 'Ocultar Formulario';
                formContainer.querySelector('form').reset();

                if (entryToEdit) {
                    formContainer.querySelector('h3').textContent = 'Editar Movimiento';
                    document.getElementById('finance-date').value = entryToEdit.date;
                    document.getElementById('finance-amount').value = entryToEdit.amount;
                    document.getElementById('finance-currency').value = entryToEdit.currency;
                    document.getElementById('finance-notes').value = entryToEdit.notes;
                    formContainer.dataset.editingId = entryToEdit.id;
                } else {
                    formContainer.querySelector('h3').textContent = 'Nuevo Movimiento Financiero';
                    document.getElementById('finance-date').valueAsDate = new Date();
                    document.getElementById('finance-currency').value = DB.settings.defaultCurrency;
                    delete formContainer.dataset.editingId;
                }
                formContainer.scrollIntoView({ behavior: 'smooth' });
            } else {
                formContainer.style.display = 'none';
                document.getElementById('add-finance-entry-btn').innerHTML = '<i class="fas fa-plus mr-2"></i>Añadir Movimiento';
                delete formContainer.dataset.editingId;
            }
        }

        async function saveFinanceEntry() {
            showLoading(true);
            const formContainer = document.getElementById('add-finance-entry-form');
            const editingId = formContainer.dataset.editingId;

            const date = document.getElementById('finance-date').value;
            const amount = parseFloat(document.getElementById('finance-amount').value);
            const currency = document.getElementById('finance-currency').value;
            const notes = document.getElementById('finance-notes').value.trim();

            if (!date || isNaN(amount) || !notes) {
                alert('Por favor, complete todos los campos (Fecha, Monto, Descripción).');
                showLoading(false);
                return;
            }
            
            const entryData = { date, amount, currency, notes };

            try {
                if (editingId) {
                    await dexieDB.finances.update(parseInt(editingId), entryData);
                    const index = DB.finances.findIndex(f => f.id === parseInt(editingId));
                    if (index !== -1) {
                        DB.finances[index] = { ...DB.finances[index], ...entryData };
                        // Actualizar en Supabase (nota: para edición necesitamos el ID de Supabase)
                        if (DB.finances[index].supabase_id) {
                            await updateFinanceInSupabase(DB.finances[index].supabase_id, entryData);
                        }
                    }
                } else {
                    const newId = await dexieDB.finances.add(entryData);
                    entryData.id = newId;
                    
                    // Guardar en Supabase
                    const supabaseData = await saveFinanceToSupabase(entryData);
                    if (supabaseData) {
                        entryData.supabase_id = supabaseData.id;
                        // Actualizar el registro local con el ID de Supabase
                        await dexieDB.finances.update(newId, { supabase_id: supabaseData.id });
                    }
                    
                    DB.finances.push(entryData);
                }
                toggleAddFinanceEntryForm();
                refreshFinancesView();
            } catch (e) {
                console.error("Error saving finance entry:", e);
                alert("Error al guardar el movimiento financiero.");
            } finally {
                showLoading(false);
            }
        }
        
        async function handleFinancesTableClick(event) {
            const button = event.target.closest('button');
            if (!button) return;

            const entryId = parseInt(button.dataset.id);
            if (isNaN(entryId)) return;

            if (button.classList.contains('edit-finance-btn')) {
                const entry = DB.finances.find(f => f.id === entryId);
                if (entry) toggleAddFinanceEntryForm(entry);
            } else if (button.classList.contains('delete-finance-btn')) {
                if (confirm('¿Estás seguro de que deseas eliminar este movimiento?')) {
                    showLoading(true);
                    try {
                        const entry = DB.finances.find(f => f.id === entryId);
                        await dexieDB.finances.delete(entryId);
                        
                        // Eliminar de Supabase si tiene supabase_id
                        if (entry && entry.supabase_id) {
                            await deleteFinanceFromSupabase(entry.supabase_id);
                        }
                        
                        DB.finances = DB.finances.filter(f => f.id !== entryId);
                        refreshFinancesView();
                    } catch (e) {
                        console.error("Error deleting finance entry:", e);
                        alert("Error al eliminar el movimiento.");
                    } finally {
                        showLoading(false);
                    }
                }
            }
        }
        
        function refreshFinancesView() {
            if (!document.getElementById('finances').classList.contains('active')) return;
            
            const filteredFinances = applyDateFilterToData(DB.finances);
            const filteredOperations = applyDateFilterToData(DB.operations);

            updateFinancePageSummary(filteredFinances, filteredOperations);
            renderFinancesTable(filteredFinances);
            updateFinancesEvolutionChart(filteredFinances);
        }

        function updateFinancePageSummary(financeEntries, tradeOperations) {
            const targetCurrency = DB.settings.defaultCurrency;
            
            let totalIncome = 0;
            let totalExpenses = 0;
            financeEntries.forEach(entry => {
                let amount = convertCurrency(entry.amount, entry.currency, targetCurrency);
                if (amount > 0) totalIncome += amount;
                else totalExpenses += amount;
            });
            const netBalance = totalIncome + totalExpenses;
            const tradingMetrics = calculateMetrics(tradeOperations, 'all');

            const tradingPLEl = document.getElementById('finance-trading-pl');
            tradingPLEl.textContent = formatCurrency(tradingMetrics.totalWin + tradingMetrics.totalLoss, targetCurrency, targetCurrency);
            tradingPLEl.className = `text-xl font-bold ${(tradingMetrics.totalWin + tradingMetrics.totalLoss) >= 0 ? 'text-positive' : 'text-negative'}`;

            document.getElementById('finance-win-rate').textContent = `${tradingMetrics.winRate.toFixed(1)}%`;
            
            document.getElementById('finance-total-income').textContent = formatCurrency(totalIncome, targetCurrency, targetCurrency);
            document.getElementById('finance-total-expenses').textContent = formatCurrency(totalExpenses, targetCurrency, targetCurrency);
            const netBalanceEl = document.getElementById('finance-net-balance');
            netBalanceEl.textContent = formatCurrency(netBalance, targetCurrency, targetCurrency);
            netBalanceEl.className = `text-xl font-bold ${netBalance >= 0 ? 'text-green' : 'text-negative'}`;
        }


        function renderFinancesTable(entries) {
            const tableBody = document.getElementById('finances-table-body');
            tableBody.innerHTML = '';
            
            const sortedEntries = [...entries].sort((a, b) => new Date(b.date) - new Date(a.date));

            if (sortedEntries.length === 0) {
                 tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-text-secondary py-4">No hay movimientos en el período seleccionado.</td></tr>';
                 return;
            }

            sortedEntries.forEach(entry => {
                const amountClass = entry.amount >= 0 ? 'text-positive' : 'text-negative';
                const row = `
                    <tr>
                        <td>${formatDate(entry.date)}</td>
                        <td>${entry.notes}</td>
                        <td class="${amountClass} font-semibold">${formatCurrency(entry.amount, entry.currency, entry.currency)}</td>
                        <td>${entry.currency}</td>
                        <td class="flex items-center justify-center space-x-2">
                            <button class="text-white edit-finance-btn" data-id="${entry.id}" title="Editar"><i class="fas fa-edit"></i></button>
                            <button class="text-red delete-finance-btn" data-id="${entry.id}" title="Eliminar"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }

        let currentCalendarDate = new Date();
        function initCalendar() {
            updateAccountSelect('calendar-account-select');
            updateCalendar();
            document.getElementById('prev-month').addEventListener('click', () => { currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1); updateCalendar(); });
            document.getElementById('next-month').addEventListener('click', () => { currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1); updateCalendar(); });
            document.getElementById('calendar-account-select').addEventListener('change', updateCalendar);
            document.querySelectorAll('input[name="cal-currency"]').forEach(radio => { radio.addEventListener('change', updateCalendar); });
        }

        updateCalendar = function () {
            if (!document.getElementById('calendar').classList.contains('active')) return;
            const selectedAccount = document.getElementById('calendar-account-select').value;
            const currencyMode = document.querySelector('input[name="cal-currency"]:checked').value;
            const year = currentCalendarDate.getFullYear(); const month = currentCalendarDate.getMonth();

            const firstDayOfMonth = new Date(Date.UTC(year, month, 1));
            const lastDayOfMonth = new Date(Date.UTC(year, month + 1, 0));

            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            document.getElementById('current-month').textContent = `${monthNames[month]} ${year}`;

            let monthOperations = DB.operations.filter(op => {
                const opDate = new Date(op.date + 'T00:00:00Z');
                return opDate.getUTCMonth() === month && opDate.getUTCFullYear() === year && (selectedAccount === 'all' || op.accountId === selectedAccount);
            });

            const dailyData = {}; const weeklyData = {};
            let baseCurrencyForCalc = DB.settings.defaultCurrency;
            let initialBalanceForPercent = 0;

            if (selectedAccount !== 'all') {
                const account = DB.accounts.find(a => a.id === selectedAccount);
                if (account) {
                    baseCurrencyForCalc = account.currency;
                    initialBalanceForPercent = account.initialBalance;
                }
            } else {
                initialBalanceForPercent = DB.accounts.reduce((sum, acc) => {
                    return sum + convertCurrency(acc.initialBalance, acc.currency, DB.settings.defaultCurrency);
                }, 0);
                baseCurrencyForCalc = DB.settings.defaultCurrency;
            }

            monthOperations.forEach(op => {
                const date = new Date(op.date + 'T00:00:00Z');
                const day = date.getUTCDate();
                const weekNumber = getWeekNumber(date);
                if (!dailyData[day]) dailyData[day] = { operations: [], totalPL: 0, count: 0 };
                if (!weeklyData[weekNumber]) weeklyData[weekNumber] = { operations: [], totalPL: 0, count: 0, weekNumber: weekNumber };

                let pl = op.pl;
                if (op.currency !== baseCurrencyForCalc) {
                    pl = convertCurrency(pl, op.currency, baseCurrencyForCalc);
                }
                dailyData[day].operations.push(op); dailyData[day].totalPL += pl; dailyData[day].count++;
                weeklyData[weekNumber].operations.push(op); weeklyData[weekNumber].totalPL += pl; weeklyData[weekNumber].count++;
            });

            const grid = document.getElementById('calendar-grid'); grid.innerHTML = '';
            const daysInMonth = lastDayOfMonth.getUTCDate();
            const firstDayOfWeekIndex = firstDayOfMonth.getUTCDay();

            for (let i = 0; i < firstDayOfWeekIndex; i++) {
                grid.innerHTML += `<div class="calendar-day empty"></div>`;
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(Date.UTC(year, month, day));
                const dayOfWeekIndex = currentDate.getUTCDay();
                const dayData = dailyData[day];
                let cellHTML = `<div class="calendar-day `;

                if (dayData) {
                    const isProfit = dayData.totalPL > 0; const isLoss = dayData.totalPL < 0;
                    cellHTML += isProfit ? 'profit' : (isLoss ? 'loss' : '');
                    cellHTML += `" data-day="${day}">`;
                    cellHTML += `<div class="day-number">${day}</div>`;
                    let formattedPL;
                    if (currencyMode === '%') {
                        const percentage = initialBalanceForPercent > 0 ? (dayData.totalPL / initialBalanceForPercent) * 100 : 0;
                        formattedPL = percentage.toFixed(2) + '%';
                    } else {
                        formattedPL = formatCurrency(dayData.totalPL, baseCurrencyForCalc, currencyMode);
                    }
                    cellHTML += `<div class="day-profit ${isProfit ? 'positive' : (isLoss ? 'negative' : '')}">${formattedPL}</div>`;
                    cellHTML += `<div class="day-trades">${dayData.count} op.</div>`;
                } else {
                    cellHTML += `" data-day="${day}">`;
                    cellHTML += `<div class="day-number text-text-secondary">${day}</div>`;
                }
                cellHTML += `</div>`;
                grid.innerHTML += cellHTML;

                if (dayOfWeekIndex === 6) {
                    const weekNumber = getWeekNumber(currentDate);
                    const weekData = weeklyData[weekNumber] || { totalPL: 0, count: 0, weekNumber: weekNumber };
                    const isWeekProfit = weekData.totalPL > 0; const isWeekLoss = weekData.totalPL < 0;
                    let formattedWeekPL;
                    if (currencyMode === '%') {
                        const percentage = initialBalanceForPercent > 0 ? (weekData.totalPL / initialBalanceForPercent) * 100 : 0;
                        formattedWeekPL = percentage.toFixed(2) + '%';
                    } else {
                        formattedWeekPL = formatCurrency(weekData.totalPL, baseCurrencyForCalc, currencyMode);
                    }
                    grid.innerHTML += `<div class="week-summary" style="background-color: var(--surface); border: 1px solid var(--surface-light)">
                                          <div class="font-bold text-sm">Sem ${weekData.weekNumber}</div>
                                          <div class="text-lg font-semibold ${isWeekProfit ? 'text-positive' : (isWeekLoss ? 'text-negative' : '')}">${formattedWeekPL}</div>
                                          <div class="text-xs text-text-secondary">${weekData.count} trades</div>
                                       </div>`;
                }
            }

            if (lastDayOfMonth.getUTCDay() !== 6) {
                for (let i = lastDayOfMonth.getUTCDay() + 1; i <= 6; i++) {
                    grid.innerHTML += `<div class="calendar-day empty"></div>`;
                }
                const weekNumber = getWeekNumber(lastDayOfMonth);
                const weekData = weeklyData[weekNumber] || { totalPL: 0, count: 0, weekNumber: weekNumber };
                const isWeekProfit = weekData.totalPL > 0; const isWeekLoss = weekData.totalPL < 0;
                let formattedWeekPL;
                if (currencyMode === '%') {
                    const percentage = initialBalanceForPercent > 0 ? (weekData.totalPL / initialBalanceForPercent) * 100 : 0;
                    formattedWeekPL = percentage.toFixed(2) + '%';
                } else {
                    formattedWeekPL = formatCurrency(weekData.totalPL, baseCurrencyForCalc, currencyMode);
                }
                grid.innerHTML += `<div class="week-summary" style="background-color: var(--surface); border: 1px solid var(--surface-light)">
                                      <div class="font-bold text-sm">Sem ${weekData.weekNumber}</div>
                                      <div class="text-lg font-semibold ${isWeekProfit ? 'text-positive' : (isWeekLoss ? 'text-negative' : '')}">${formattedWeekPL}</div>
                                      <div class="text-xs text-text-secondary">${weekData.count} trades</div>
                                   </div>`;
            }

            grid.querySelectorAll('.calendar-day:not(.empty)').forEach(cell => {
                const dayHasData = dailyData[parseInt(cell.dataset.day)];
                const newCell = cell.cloneNode(true); cell.parentNode.replaceChild(newCell, cell);
                if (dayHasData) {
                    newCell.onclick = () => {
                        const day = parseInt(newCell.dataset.day, 10); if (isNaN(day)) return;
                        const dateKeyYYYYMMDD = new Date(Date.UTC(year, month, day)).toISOString().split('T')[0];
                        const opsForDay = DB.operations.filter(op => op.date === dateKeyYYYYMMDD && (selectedAccount === 'all' || op.accountId === selectedAccount));
                        let totalPLForDayInModalCurrency = opsForDay.reduce((sum, op) => {
                            let plConverted = op.pl;
                            if (op.currency !== baseCurrencyForCalc) {
                                plConverted = convertCurrency(op.pl, op.currency, baseCurrencyForCalc);
                            }
                            return sum + plConverted;
                        }, 0);
                        openDayDetailModal(dateKeyYYYYMMDD, opsForDay, totalPLForDayInModalCurrency, baseCurrencyForCalc);
                    };
                }
            });

            updateMonthSummary(monthOperations, baseCurrencyForCalc);
            updateWeeklyTrendChart(weeklyData, baseCurrencyForCalc, initialBalanceForPercent);
        };


        function updateMonthSummary(operations, baseCurrency) {
            let totalPL = 0; let tradingDays = 0; let winDays = 0; let loseDays = 0; const dailyPL = {};
            const currencyMode = document.querySelector('input[name="cal-currency"]:checked').value;

            operations.forEach(op => {
                const date = op.date;
                if (!dailyPL[date]) dailyPL[date] = 0;
                let pl = op.pl;
                if (op.currency !== baseCurrency) pl = convertCurrency(pl, op.currency, baseCurrency);
                dailyPL[date] += pl;
                totalPL += pl;
            });
            Object.values(dailyPL).forEach(dayPL => { tradingDays++; if (dayPL > 0) winDays++; else if (dayPL < 0) loseDays++; });

            let initialBalanceForPercent = 0;
            const selectedAccount = document.getElementById('calendar-account-select').value;
            if (currencyMode === '%') {
                if (selectedAccount !== 'all') {
                    const account = DB.accounts.find(a => a.id === selectedAccount);
                    if (account) initialBalanceForPercent = convertCurrency(account.initialBalance, account.currency, baseCurrency);
                } else {
                    initialBalanceForPercent = DB.accounts.reduce((sum, acc) => sum + convertCurrency(acc.initialBalance, acc.currency, baseCurrency), 0);
                }
            }

            let plDisplay;
            if (currencyMode === '%') {
                plDisplay = initialBalanceForPercent > 0 ? ((totalPL / initialBalanceForPercent) * 100).toFixed(2) + '%' : '0.00%';
            } else {
                plDisplay = formatCurrency(totalPL, baseCurrency, currencyMode);
            }
            const monthlyPlEl = document.getElementById('monthly-pl');
            monthlyPlEl.textContent = plDisplay;
            monthlyPlEl.className = `text-2xl font-bold ${totalPL >= 0 ? 'text-green' : 'text-negative'}`;

            document.getElementById('monthly-trading-days').textContent = tradingDays;
            document.getElementById('monthly-winning-days').textContent = winDays;
            document.getElementById('monthly-losing-days').textContent = loseDays;
        }

        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function initOperations() {
            updateAccountSelect('op-account');
            updateAccountSelect('filter-account');
            
            document.getElementById('add-operation-btn').addEventListener('click', () => toggleAddOperationForm());
            document.getElementById('op-cancel').addEventListener('click', () => toggleAddOperationForm());
            document.getElementById('op-save').addEventListener('click', saveOperation);
            document.getElementById('filter-account').addEventListener('change', refreshOperationsTable);
            document.getElementById('filter-instrument').addEventListener('input', refreshOperationsTable);

            // NUEVO: Listener para ordenar la tabla
            document.querySelector('#operations-table-render thead').addEventListener('click', (event) => {
                const header = event.target.closest('th');
                if (!header || !header.dataset.sort) return;

                const column = header.dataset.sort;
                if (operationSortState.column === column) {
                    operationSortState.order = operationSortState.order === 'asc' ? 'desc' : 'asc';
                } else {
                    operationSortState.column = column;
                    operationSortState.order = 'desc';
                }
                refreshOperationsTable();
            });

            const winBtn = document.getElementById('op-win-btn');
            const lossBtn = document.getElementById('op-loss-btn');
            winBtn.addEventListener('click', function () {
                winBtn.classList.add('bg-green'); lossBtn.classList.remove('bg-red');
                winBtn.classList.remove('bg-surface-light'); lossBtn.classList.add('bg-surface-light');
                winBtn.dataset.selected = 'true'; lossBtn.dataset.selected = 'false';
            });
            lossBtn.addEventListener('click', function () {
                lossBtn.classList.add('bg-red'); winBtn.classList.remove('bg-green');
                lossBtn.classList.remove('bg-surface-light'); winBtn.classList.add('bg-surface-light');
                winBtn.dataset.selected = 'false'; lossBtn.dataset.selected = 'true';
            });

            const priceInputs = ['op-entry', 'op-exit', 'op-volume', 'op-type', 'op-manual-pl'];
            priceInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', autoSelectWinLoss);
                    element.addEventListener('change', autoSelectWinLoss);
                }
            });

            document.getElementById('op-manual-pl').addEventListener('input', function () {
                if (this.value.trim() !== "") {
                    const manualPLValue = parseFloat(this.value);
                    if (!isNaN(manualPLValue)) {
                        if (manualPLValue > 0) document.getElementById('op-win-btn').click();
                        else if (manualPLValue < 0) document.getElementById('op-loss-btn').click();
                        else {
                            const winBtn = document.getElementById('op-win-btn');
                            const lossBtn = document.getElementById('op-loss-btn');
                            winBtn.classList.remove('bg-green'); lossBtn.classList.remove('bg-red');
                            winBtn.classList.add('bg-surface-light'); lossBtn.classList.add('bg-surface-light');
                            winBtn.dataset.selected = 'false'; lossBtn.dataset.selected = 'false';
                        }
                    }
                } else {
                    autoSelectWinLoss();
                }
            });

            document.getElementById('op-image').addEventListener('change', handleOpImageSelection);
            document.getElementById('operations-table-render').addEventListener('click', handleOperationsTableClick);
            refreshOperationsTable();
        }


        function handleOpImageSelection(event) {
            const files = event.target.files;
            const MAX_IMAGES = 5;

            for (let i = 0; i < files.length; i++) {
                if (currentEditingOpImages.length >= MAX_IMAGES) {
                    alert(`Puedes adjuntar un máximo de ${MAX_IMAGES} imágenes.`);
                    break;
                }
                const file = files[i];
                if (!['image/png', 'image/jpeg', 'image/jpg'].includes(file.type)) {
                    alert('Formato de imagen no válido. Por favor, selecciona PNG, JPG o JPEG.');
                    continue;
                }
                const maxSizeMB = 2;
                if (file.size > maxSizeMB * 1024 * 1024) {
                    alert(`La imagen "${file.name}" es demasiado grande (Máx: ${maxSizeMB}MB).`);
                    continue;
                }

                const reader = new FileReader();
                reader.onload = function (e) {
                    if (currentEditingOpImages.length < MAX_IMAGES) {
                        currentEditingOpImages.push(e.target.result);
                        renderOpImagePreviews();
                    }
                }
                reader.onerror = function () { alert(`Error al leer la imagen "${file.name}".`); }
                reader.readAsDataURL(file);
            }
            event.target.value = null;
        }

        function renderOpImagePreviews() {
            const container = document.getElementById('op-image-previews-container');
            container.innerHTML = '';
            currentEditingOpImages.forEach((imageDataUrl, index) => {
                const previewItem = document.createElement('div');
                previewItem.className = 'op-image-preview-item h-20 w-full';
                previewItem.innerHTML = `
                    <img src="${imageDataUrl}" alt="Preview ${index + 1}" class="object-cover h-full w-full">
                    <button type="button" class="op-image-remove-btn" data-index="${index}">&times;</button>
                `;
                container.appendChild(previewItem);
            });

            container.querySelectorAll('.op-image-remove-btn').forEach(button => {
                button.addEventListener('click', function () {
                    const indexToRemove = parseInt(this.dataset.index);
                    currentEditingOpImages.splice(indexToRemove, 1);
                    renderOpImagePreviews();
                });
            });
        }


        function autoSelectWinLoss() {
            const entryPrice = parseFloat(document.getElementById('op-entry').value);
            const exitPrice = parseFloat(document.getElementById('op-exit').value);
            const type = document.getElementById('op-type').value;
            const manualPL = document.getElementById('op-manual-pl').value;

            if (manualPL.trim() !== "") return;

            const winBtn = document.getElementById('op-win-btn');
            const lossBtn = document.getElementById('op-loss-btn');

            if (isNaN(entryPrice) || isNaN(exitPrice) || entryPrice === 0 || exitPrice === 0) {
                winBtn.classList.remove('bg-green'); lossBtn.classList.remove('bg-red');
                winBtn.classList.add('bg-surface-light'); lossBtn.classList.add('bg-surface-light');
                winBtn.dataset.selected = 'false'; lossBtn.dataset.selected = 'false';
                return;
            }

            let isWin = false;
            if (type === 'buy' && exitPrice > entryPrice) isWin = true;
            else if (type === 'sell' && entryPrice > exitPrice) isWin = true;

            if (entryPrice === exitPrice) {
                winBtn.classList.remove('bg-green'); lossBtn.classList.remove('bg-red');
                winBtn.classList.add('bg-surface-light'); lossBtn.classList.add('bg-surface-light');
                winBtn.dataset.selected = 'false'; lossBtn.dataset.selected = 'false';
                return;
            }

            if (isWin) winBtn.click();
            else lossBtn.click();
        }

        function toggleAddOperationForm(operationToEdit = null) {
            const formContainer = document.getElementById('add-operation-form');
            const isVisible = formContainer.style.display === 'block';
            const imageInput = document.getElementById('op-image');
            const manualPLInput = document.getElementById('op-manual-pl');
            currentEditingOpImages = [];

            if (!isVisible) {
                formContainer.style.display = 'block';
                document.getElementById('add-operation-btn').textContent = 'Ocultar Formulario';
                document.getElementById('operation-details-form').reset();

                if (operationToEdit) {
                    formContainer.querySelector('h3').textContent = 'Editar Operación';
                    document.getElementById('op-date').value = operationToEdit.date;
                    document.getElementById('op-account').value = operationToEdit.accountId;
                    document.getElementById('op-instrument').value = operationToEdit.instrument;
                    document.getElementById('op-type').value = operationToEdit.type;
                    document.getElementById('op-entry').value = operationToEdit.entry;
                    document.getElementById('op-exit').value = operationToEdit.exit;
                    document.getElementById('op-entry-time').value = operationToEdit.entryTime || '';
                    document.getElementById('op-exit-time').value = operationToEdit.exitTime || '';
                    document.getElementById('op-volume').value = operationToEdit.volume;
                    document.getElementById('op-currency').value = operationToEdit.currency;
                    document.getElementById('op-notes').value = operationToEdit.notes;
                    document.getElementById('op-session').value = operationToEdit.session || ''; // Cargar campo Sesión
                    manualPLInput.value = operationToEdit.manualPL !== null && typeof operationToEdit.manualPL !== 'undefined' ? operationToEdit.manualPL : '';

                    if (operationToEdit.imageDatas && Array.isArray(operationToEdit.imageDatas)) {
                        currentEditingOpImages = [...operationToEdit.imageDatas];
                    }
                    renderOpImagePreviews();
                    imageInput.value = '';

                    if (operationToEdit.result === 'win') document.getElementById('op-win-btn').click();
                    else if (operationToEdit.result === 'loss') document.getElementById('op-loss-btn').click();
                    else {
                        const winBtn = document.getElementById('op-win-btn'); const lossBtn = document.getElementById('op-loss-btn');
                        winBtn.classList.remove('bg-green'); lossBtn.classList.remove('bg-red');
                        winBtn.classList.add('bg-surface-light'); lossBtn.classList.add('bg-surface-light');
                        winBtn.dataset.selected = 'false'; lossBtn.dataset.selected = 'false';
                    }
                    formContainer.dataset.editingId = operationToEdit.id;
                } else {
                    formContainer.querySelector('h3').textContent = 'Nueva Operación';
                    document.getElementById('op-date').valueAsDate = new Date();
                    document.getElementById('op-account').value = DB.accounts.length > 0 ? DB.accounts[0].id : '';
                    document.getElementById('op-currency').value = DB.settings.defaultCurrency;
                    document.getElementById('op-session').value = ''; // Limpiar campo Sesión
                    renderOpImagePreviews();
                    imageInput.value = '';
                    manualPLInput.value = '';
                    const winBtn = document.getElementById('op-win-btn'); const lossBtn = document.getElementById('op-loss-btn');
                    winBtn.classList.remove('bg-green'); lossBtn.classList.remove('bg-red');
                    winBtn.classList.add('bg-surface-light'); lossBtn.classList.add('bg-surface-light');
                    winBtn.dataset.selected = 'false'; lossBtn.dataset.selected = 'false';
                    delete formContainer.dataset.editingId;
                }
                autoSelectWinLoss();
                formContainer.scrollIntoView({ behavior: 'smooth' });
            } else {
                formContainer.style.display = 'none';
                document.getElementById('add-operation-btn').innerHTML = '<i class="fas fa-plus mr-2"></i>Añadir Operación';
                delete formContainer.dataset.editingId;
                currentEditingOpImages = [];
                renderOpImagePreviews();
                imageInput.value = '';
                manualPLInput.value = '';
                document.getElementById('operation-details-form').reset();
            }
        }

        async function saveOperation() {
            showLoading(true);
            const formContainer = document.getElementById('add-operation-form');
            const editingId = formContainer.dataset.editingId;

            const date = document.getElementById('op-date').value;
            const accountId = document.getElementById('op-account').value;
            const instrument = document.getElementById('op-instrument').value.toUpperCase().trim();
            const type = document.getElementById('op-type').value;
            const entry = parseFloat(document.getElementById('op-entry').value);
            const exit = parseFloat(document.getElementById('op-exit').value);
            const entryTime = document.getElementById('op-entry-time').value;
            const exitTime = document.getElementById('op-exit-time').value;
            const volume = parseFloat(document.getElementById('op-volume').value);
            const currency = document.getElementById('op-currency').value;
            const notes = document.getElementById('op-notes').value.trim();
            const session = document.getElementById('op-session').value.trim(); // Capturar Sesión
            const manualPLValue = document.getElementById('op-manual-pl').value;

            const isWinSelected = document.getElementById('op-win-btn').dataset.selected === 'true';
            const isLossSelected = document.getElementById('op-loss-btn').dataset.selected === 'true';

            let result;
            let finalPL;
            let manualPLInputVal = null;

            if (!date || !accountId || !instrument || isNaN(volume) || volume <= 0) {
                alert('Por favor, complete todos los campos obligatorios (Fecha, Cuenta, Instrumento, Volumen > 0).');
                showLoading(false); return;
            }

            if (manualPLValue.trim() !== "") {
                manualPLInputVal = parseFloat(manualPLValue);
                if (isNaN(manualPLInputVal)) {
                    alert('P&L Manual no es un número válido.');
                    showLoading(false); return;
                }
                finalPL = manualPLInputVal;
                if (manualPLInputVal > 0) result = 'win';
                else if (manualPLInputVal < 0) result = 'loss';
                else result = 'breakeven';
            } else {
                if (isNaN(entry) || isNaN(exit)) {
                    alert('Por favor, ingrese precios de Entrada y Salida válidos, o ingrese un P&L Manual.');
                    showLoading(false); return;
                }
                if (entry !== exit && !isWinSelected && !isLossSelected) {
                    alert('Por favor, seleccione si la operación fue Ganancia o Pérdida, o ingrese un P&L Manual.');
                    showLoading(false); return;
                }

                if (entry === exit) {
                    result = 'breakeven';
                    finalPL = 0;
                } else {
                    result = isWinSelected ? 'win' : 'loss';
                    if (type === 'buy') finalPL = (exit - entry) * volume;
                    else finalPL = (entry - exit) * volume;

                    if ((result === 'win' && finalPL <= 0) || (result === 'loss' && finalPL >= 0)) {
                        if (!confirm(`El P&L calculado (${finalPL.toFixed(2)} ${currency}) no coincide con el resultado ('${result}') seleccionado. Si continúa, se guardará con el resultado '${result}' y el P&L calculado. ¿Desea continuar?`)) {
                            showLoading(false); return;
                        }
                    }
                }
            }
            finalPL = parseFloat(finalPL.toFixed(5));

            let operationData = {
                id: editingId || generateId(), // Usar el ID existente si se edita, si no generar uno nuevo
                date, accountId, instrument, type,
                entry: isNaN(entry) ? null : entry,
                exit: isNaN(exit) ? null : exit,
                entryTime, exitTime,
                volume,
                result, pl: finalPL, currency, notes,
                imageDatas: [...currentEditingOpImages],
                manualPL: manualPLInputVal,
                session: session // Guardar el campo Sesión
            };

            try {
                if (editingId) {
                    await dexieDB.operations.update(editingId, operationData);
                    const index = DB.operations.findIndex(op => op.id === editingId);
                    if (index !== -1) {
                        DB.operations[index] = { ...DB.operations[index], ...operationData };
                    }
                    // Guardar en Supabase
                    try {
                        await saveOperationToSupabase(operationData);
                        console.log('✅ Operation updated in Supabase');
                    } catch (supabaseError) {
                        console.error('❌ Failed to update operation in Supabase:', supabaseError);
                        // Continuar sin fallar la operación local
                    }
                } else {
                    await dexieDB.operations.add(operationData);
                    DB.operations.push(operationData);
                    // Guardar en Supabase
                    try {
                        await saveOperationToSupabase(operationData);
                        console.log('✅ Operation saved to Supabase');
                    } catch (supabaseError) {
                        console.error('❌ Failed to save operation to Supabase:', supabaseError);
                        // Continuar sin fallar la operación local
                    }
                }

                updateAccountBalances();
                toggleAddOperationForm();

                refreshAllViews();
            } catch (e) {
                console.error("Error saving operation:", e);
                alert("Error al guardar la operación.");
            } finally {
                showLoading(false);
            }
        }

        function refreshAllViews() {
            const activeTabElement = document.querySelector('.nav-tab.active');
            if (!activeTabElement) return;
            const activeTabId = activeTabElement.dataset.target;

            // Asegurarse de que la sección de detalles de operación se oculte si se cambia de pestaña
            if (activeTabId !== 'operation-detail-page') {
                document.getElementById('operation-detail-page').classList.remove('active');
            }

            if (activeTabId === 'dashboard') refreshDashboard();
            else if (activeTabId === 'analytics') refreshAnalytics();
            else if (activeTabId === 'finances') refreshFinancesView();
            else if (activeTabId === 'calendar') updateCalendar();
            else if (activeTabId === 'operations') refreshOperationsTable();
            else if (activeTabId === 'accounts') refreshAccountsView();
            // operation-detail-page no se refresca automáticamente desde aquí, solo cuando se invoca directamente

            if (document.getElementById('selected-account-details')?.style.display === 'block' && document.getElementById('selected-account-details').dataset.accountId) {
                showAccountDetails(document.getElementById('selected-account-details').dataset.accountId);
            }
        }


        async function handleOperationsTableClick(event) {
            const target = event.target;
            const buttonElement = target.closest('button');
            if (!buttonElement) {
                return;
            }
            const operationId = buttonElement.dataset.id;
            if (!operationId) return;

            if (buttonElement.classList.contains('delete-op-btn')) {
                if (confirm('¿Estás seguro de que deseas eliminar esta operación?')) {
                    showLoading(true);
                    try {
                        await dexieDB.operations.delete(operationId);
                        // Eliminar de Supabase
                        await deleteOperationFromSupabase(operationId);
                        DB.operations = DB.operations.filter(op => op.id !== operationId);
                        updateAccountBalances();
                        refreshAllViews();
                    } catch (e) {
                        console.error("Error deleting operation:", e); alert("Error al eliminar la operación.");
                    } finally { showLoading(false); }
                }
            } else if (buttonElement.classList.contains('edit-op-btn')) {
                const operationToEdit = DB.operations.find(op => op.id === operationId);
                if (operationToEdit) toggleAddOperationForm(operationToEdit);
            }
        }

        async function refreshOperationsTable() {
            const operationsSection = document.getElementById('operations');
            if (!operationsSection || !operationsSection.classList.contains('active')) {
                return;
            }

            const tableBody = document.getElementById('operations-table');
            const tableHeaders = document.querySelectorAll('#operations-table-render th[data-sort]');
            if (!tableBody) {
                console.error("Operations table body not found during refresh.");
                return;
            }

            const accountFilter = document.getElementById('filter-account').value;
            const instrumentFilter = document.getElementById('filter-instrument').value.toLowerCase().trim();
            tableBody.innerHTML = '';

            let filteredOperations = applyDateFilterToData(DB.operations);

            filteredOperations = filteredOperations.filter(op =>
                (accountFilter === 'all' || op.accountId === accountFilter) &&
                (!instrumentFilter || op.instrument.toLowerCase().includes(instrumentFilter))
            );
            
            // NUEVO: Lógica de ordenamiento
            const sortColumn = operationSortState.column;
            const sortOrder = operationSortState.order;
            
            filteredOperations.sort((a, b) => {
                let valA = a[sortColumn];
                let valB = b[sortColumn];

                // Manejo especial para la columna 'cuenta' que usa 'accountId'
                if (sortColumn === 'accountId') {
                    valA = DB.accounts.find(acc => acc.id === valA)?.name || '';
                    valB = DB.accounts.find(acc => acc.id === valB)?.name || '';
                }

                if (typeof valA === 'string') {
                    valA = valA.toLowerCase();
                    valB = valB.toLowerCase();
                }

                if (valA === null || valA === undefined) return 1;
                if (valB === null || valB === undefined) return -1;
                
                if (valA < valB) return sortOrder === 'asc' ? -1 : 1;
                if (valA > valB) return sortOrder === 'asc' ? 1 : -1;
                return 0;
            });


            tableHeaders.forEach(th => {
                th.classList.remove('sorted', 'asc', 'desc');
                if (th.dataset.sort === sortColumn) {
                    th.classList.add('sorted', sortOrder);
                }
            });


            filteredOperations.forEach(op => {
                const account = DB.accounts.find(acc => acc.id === op.accountId);
                const accountName = account ? account.name : 'Desconocida';
                const plClass = op.pl > 0 ? 'text-positive' : op.pl < 0 ? 'text-negative' : 'text-neutral';
                let resultText, resultClass;
                if (op.result === 'win') { resultText = 'Ganancia'; resultClass = 'text-positive'; }
                else if (op.result === 'loss') { resultText = 'Pérdida'; resultClass = 'text-negative'; }
                else { resultText = 'Neutral'; resultClass = 'text-neutral'; }

                const precision = getInstrumentPrecision(op.instrument);
                const entryDisplay = op.entry !== null ? op.entry.toFixed(precision) : '-';
                const exitDisplay = op.exit !== null ? op.exit.toFixed(precision) : '-';

                const row = tableBody.insertRow();
                row.dataset.id = op.id; // Añade el ID de la operación a la fila
                row.classList.add('cursor-pointer'); // Añade una clase para indicar que es clicable (cambio de cursor)

                row.innerHTML = `
                    <td>${formatDate(op.date)}</td>
                    <td>${op.entryTime || '-'}</td>
                    <td>${op.exitTime || '-'}</td>
                    <td>${accountName}</td><td>${op.instrument}</td>
                    <td>${op.type === 'buy' ? 'Compra' : 'Venta'}</td><td>${entryDisplay}</td><td>${exitDisplay}</td>
                    <td>${op.volume}</td><td class="${resultClass}">${resultText}</td>
                    <td class="${plClass}">${formatCurrency(op.pl, op.currency, op.currency)}</td><td>${op.currency}</td>
                    <td>${op.session || '-'}</td> <!-- NUEVA COLUMNA: SESIÓN -->
                    <td class="text-center space-x-2">
                        <button class="text-white edit-op-btn" data-id="${op.id}" title="Editar"><i class="fas fa-edit"></i></button>
                        <button class="text-red delete-op-btn" data-id="${op.id}" title="Eliminar"><i class="fas fa-trash"></i></button>
                    </td>`;
            });

            // Añade un nuevo event listener para las filas después de que se renderizan
            tableBody.querySelectorAll('tr').forEach(row => {
                row.addEventListener('click', (event) => {
                    // Verifica si el clic fue en un botón de acción (editar/eliminar)
                    if (event.target.closest('.edit-op-btn') || event.target.closest('.delete-op-btn')) {
                        // Deja que el manejador existente `handleOperationsTableClick` lo procese
                        return;
                    }
                    // Si no fue en un botón de acción, asume que es un clic para ver detalles
                    const operationId = row.dataset.id;
                    if (operationId) {
                        showOperationDetailPage(operationId);
                    }
                });
            });
        }


        function getInstrumentPrecision(instrument) {
            if (!instrument) return 5;
            const instUpper = instrument.toUpperCase();
            if (instUpper.includes('BTC') || instUpper.includes('ETH') || instUpper.includes('XAU') || instUpper.includes('XAG') || instUpper.endsWith('USDT')) return 2;
            if (instUpper.includes('JPY')) return 3;
            if (instUpper.includes('DE40') || instUpper.includes('US30') || instUpper.includes('SPX500') || instUpper.includes('NAS100')) return 1;
            return 5;
        }

        function openImageModal(imageList, startIndex = 0) {
            if (!imageList || imageList.length === 0) return;

            modalImageList = imageList;
            modalImageIndex = startIndex;

            const modal = document.getElementById('image-modal');
            const modalImg = document.getElementById('modal-image-content');

            modalImg.src = modalImageList[modalImageIndex];
            modal.style.display = "flex";

            updateModalNavigation();
        }

        function closeImageModal() {
            const modal = document.getElementById('image-modal');
            if (modal) {
                modal.style.display = "none";
                document.getElementById('modal-image-content').src = "";
                modalImageList = [];
                modalImageIndex = 0;
            }
        }

        function updateModalNavigation() {
            const prevBtn = document.getElementById('image-modal-prev');
            const nextBtn = document.getElementById('image-modal-next');

            prevBtn.style.display = (modalImageIndex > 0) ? 'block' : 'none';
            nextBtn.style.display = (modalImageIndex < modalImageList.length - 1) ? 'block' : 'none';
        }

        function initImageModal() {
            document.getElementById('image-modal-close-btn').addEventListener('click', closeImageModal);

            document.getElementById('image-modal-prev').addEventListener('click', (e) => {
                e.stopPropagation();
                if (modalImageIndex > 0) {
                    modalImageIndex--;
                    document.getElementById('modal-image-content').src = modalImageList[modalImageIndex];
                    updateModalNavigation();
                }
            });

            document.getElementById('image-modal-next').addEventListener('click', (e) => {
                e.stopPropagation();
                if (modalImageIndex < modalImageList.length - 1) {
                    modalImageIndex++;
                    document.getElementById('modal-image-content').src = modalImageList[modalImageIndex];
                    updateModalNavigation();
                }
            });
        }

        function initAccounts() {
            refreshAccountsView();
            document.getElementById('add-account-btn').addEventListener('click', () => toggleAddAccountForm());
            document.getElementById('acc-cancel').addEventListener('click', () => toggleAddAccountForm());
            document.getElementById('acc-save').addEventListener('click', saveAccount);
        }
        function toggleAddAccountForm(accountToEdit = null) {
            const form = document.getElementById('add-account-form'); const isVisible = form.style.display === 'block';
            if (!isVisible) {
                form.style.display = 'block'; document.getElementById('add-account-btn').textContent = 'Ocultar Formulario';
                if (accountToEdit) { form.querySelector('h3').textContent = 'Editar Cuenta'; document.getElementById('acc-name').value = accountToEdit.name; document.getElementById('acc-balance').value = accountToEdit.initialBalance; document.getElementById('acc-currency').value = accountToEdit.currency; document.getElementById('acc-platform').value = accountToEdit.platform; form.dataset.editingId = accountToEdit.id; }
                else { form.querySelector('h3').textContent = 'Nueva Cuenta'; document.getElementById('acc-name').value = ''; document.getElementById('acc-balance').value = ''; document.getElementById('acc-currency').value = DB.settings.defaultCurrency; document.getElementById('acc-platform').value = 'meta-trader-4'; delete form.dataset.editingId; }
                form.scrollIntoView({ behavior: 'smooth' });
            } else { form.style.display = 'none'; document.getElementById('add-account-btn').innerHTML = '<i class="fas fa-plus mr-2"></i>Agregar Cuenta'; delete form.dataset.editingId; }
        }
        async function saveAccount() {
            showLoading(true);
            const form = document.getElementById('add-account-form');
            const editingId = form.dataset.editingId;
            const name = document.getElementById('acc-name').value.trim();
            const initialBalance = parseFloat(document.getElementById('acc-balance').value);
            const currency = document.getElementById('acc-currency').value;
            const platform = document.getElementById('acc-platform').value;
            if (!name || isNaN(initialBalance) || initialBalance < 0) { alert('Nombre y balance inicial válido requerido.'); showLoading(false); return; }

            let accountData;
            try {
                if (editingId) {
                    const existingAccount = DB.accounts.find(acc => acc.id === editingId);
                    accountData = { ...existingAccount, name, initialBalance, currency, platform };
                    accountData.balance = initialBalance;
                    const accountOps = DB.operations.filter(op => op.accountId === editingId);
                    accountOps.forEach(op => {
                        let pl = op.pl;
                        if (op.currency !== accountData.currency) pl = convertCurrency(pl, op.currency, accountData.currency);
                        accountData.balance += pl;
                    });
                    accountData.balance = Math.round(accountData.balance * 100) / 100;
                    await dexieDB.accounts.update(editingId, accountData);
                    const index = DB.accounts.findIndex(acc => acc.id === editingId);
                    if (index !== -1) DB.accounts[index] = accountData;
                    // Guardar en Supabase
                    try {
                        await saveAccountToSupabase(accountData);
                        console.log('✅ Account updated in Supabase');
                    } catch (supabaseError) {
                        console.error('❌ Failed to update account in Supabase:', supabaseError);
                    }
                } else {
                    accountData = { id: generateId(), name, initialBalance, balance: initialBalance, currency, platform };
                    console.log('🏦 Creating new account:', accountData);
                    
                    await dexieDB.accounts.add(accountData);
                    console.log('✅ Account added to local DB');
                    
                    DB.accounts.push(accountData);
                    console.log('✅ Account added to memory');
                    
                    // Guardar en Supabase
                    console.log('💾 Attempting to save account to Supabase...');
                    console.log('👤 Current user:', currentUser);
                    
                    try {
                        const supabaseResult = await saveAccountToSupabase(accountData);
                        console.log('✅ Account saved to Supabase successfully:', supabaseResult);
                    } catch (supabaseError) {
                        console.error('❌ Failed to save account to Supabase:', supabaseError);
                        console.error('❌ Error details:', {
                            message: supabaseError.message,
                            details: supabaseError.details,
                            hint: supabaseError.hint,
                            code: supabaseError.code
                        });
                    }
                }
                toggleAddAccountForm();
                updateAccountBalances();
                ['dashboard-account-select', 'analytics-account-select', 'calendar-account-select', 'op-account', 'filter-account', 'ctrader-account', 'bingx-account'].forEach(updateAccountSelect);
                refreshAllViews();

            } catch (e) {
                console.error("Error saving account:", e); alert("Error al guardar la cuenta.");
            } finally { showLoading(false); }
        }

        async function refreshAccountsView() {
            if (!document.getElementById('accounts').classList.contains('active')) return;
            const container = document.getElementById('accounts-container');
            if (!container) return;
            container.innerHTML = '';
            DB.accounts.forEach(account => {
                const card = document.createElement('div'); card.classList.add('account-card'); card.dataset.id = account.id;
                const accountOps = DB.operations.filter(op => op.accountId === account.id);
                const winningOps = accountOps.filter(op => op.result === 'win').length;
                const losingOps = accountOps.filter(op => op.result === 'loss').length;
                const winRate = (winningOps + losingOps) > 0 ? (winningOps / (winningOps + losingOps)) * 100 : 0;
                const pl = account.balance - account.initialBalance;
                const plPercentage = account.initialBalance !== 0 ? (pl / account.initialBalance) * 100 : 0;
                card.innerHTML = ` <div class="flex justify-between items-start mb-4"><h4 class="text-lg font-semibold">${account.name}</h4><span class="text-xs bg-surface-light px-2 py-1 rounded text-text-secondary">${formatPlatformName(account.platform)}</span></div><div class="mb-4"><p class="text-sm text-text-secondary">Balance</p><p class="text-2xl font-semibold">${formatCurrency(account.balance, account.currency, account.currency)}</p></div><div class="grid grid-cols-2 gap-4 mb-3"><div><p class="text-sm text-text-secondary">P&L</p><p class="text-lg font-semibold ${pl > 0 ? 'text-positive' : (pl < 0 ? 'text-negative' : '')}">${formatCurrency(pl, account.currency, account.currency)} (${plPercentage.toFixed(1)}%)</p></div><div><p class="text-sm text-text-secondary">Win Rate</p><p class="text-lg font-semibold text-green">${winRate.toFixed(0)}%</p></div></div><div class="flex justify-between items-center mt-4"><button class="view-account-btn text-sm" data-id="${account.id}"><i class="fas fa-chart-line mr-1"></i> Detalles</button><div class="space-x-2"><button class="edit-account-btn text-sm text-white" data-id="${account.id}" title="Editar Cuenta"><i class="fas fa-edit"></i></button><button class="delete-account-btn text-sm text-red" data-id="${account.id}" title="Eliminar Cuenta"><i class="fas fa-trash"></i></button></div></div>`;
                container.appendChild(card);
            });
            container.addEventListener('click', async function (event) {
                const targetButton = event.target.closest('button');
                if (!targetButton) return;

                const accountId = targetButton.dataset.id;
                const account = DB.accounts.find(acc => acc.id === accountId);

                if (targetButton.classList.contains('view-account-btn')) {
                    showAccountDetails(accountId);
                } else if (targetButton.classList.contains('edit-account-btn')) {
                    if (account) toggleAddAccountForm(account);
                } else if (targetButton.classList.contains('delete-account-btn')) {
                    const opsCount = DB.operations.filter(op => op.accountId === accountId).length;
                    if (confirm(`¿Eliminar cuenta "${account?.name || accountId}" y TODAS sus ${opsCount} operaciones? Esta acción es irreversible.`)) {
                        showLoading(true);
                        try {
                            await dexieDB.transaction('rw', dexieDB.accounts, dexieDB.operations, async () => {
                                await dexieDB.accounts.delete(accountId);
                                const opsToDelete = DB.operations.filter(op => op.accountId === accountId).map(op => op.id);
                                if (opsToDelete.length > 0) await dexieDB.operations.bulkDelete(opsToDelete);
                            });
                            
                            // Eliminar de Supabase
                            await deleteAccountFromSupabase(accountId);
                            // También eliminar todas las operaciones de esta cuenta de Supabase
                            const opsToDelete = DB.operations.filter(op => op.accountId === accountId);
                            for (const op of opsToDelete) {
                                await deleteOperationFromSupabase(op.id);
                            }
                            
                            DB.accounts = DB.accounts.filter(a => a.id !== accountId);
                            DB.operations = DB.operations.filter(op => op.accountId !== accountId);

                            updateAccountBalances();
                            ['dashboard-account-select', 'analytics-account-select', 'calendar-account-select', 'op-account', 'filter-account', 'ctrader-account', 'bingx-account'].forEach(updateAccountSelect);

                            const detailsSection = document.getElementById('selected-account-details');
                            if (detailsSection.style.display === 'block' && detailsSection.dataset.accountId === accountId) {
                                detailsSection.style.display = 'none'; detailsSection.removeAttribute('data-accountId');
                            }
                            refreshAllViews();
                        }
                        catch (e) {
                            console.error("Error deleting account:", e); alert("Error al eliminar la cuenta.");
                        } finally { showLoading(false); }
                    }
                }
            });
        }
        
        let accountDetailRadarChart = null;
        function updateAccountDetailRadarChart(operations, accountId) {
            const ctx = document.getElementById('account-detail-radar-chart')?.getContext('2d');
            if (!ctx) return;
            if (accountDetailRadarChart) accountDetailRadarChart.destroy();

            // This function is essentially the same as updateDashboardRadarChart,
            // but targets the account detail canvas.
            const basicMetrics = calculateMetrics(operations, accountId);
            const advancedMetrics = calculateAdvancedMetrics(operations, accountId);

            let maxDrawdownPercentage = 0;
            const account = DB.accounts.find(a => a.id === accountId);
            if (operations.length > 0 && account) {
                const sortedOps = [...operations].sort((a, b) => new Date(a.date + 'T' + (a.entryTime || '00:00')) - new Date(b.date + 'T' + (b.entryTime || '00:00')));
                let accountInitialBalance = account.initialBalance;
                
                if (accountInitialBalance > 0) {
                    let peakBalance = accountInitialBalance;
                    let maxDrawdownValue = 0;
                    let currentBalance = accountInitialBalance;
                    sortedOps.forEach(op => {
                        let pl = convertCurrency(op.pl, op.currency, account.currency);
                        currentBalance += pl;
                        if (currentBalance > peakBalance) peakBalance = currentBalance;
                        const drawdown = peakBalance - currentBalance;
                        if (drawdown > maxDrawdownValue) maxDrawdownValue = drawdown;
                    });
                    maxDrawdownPercentage = (maxDrawdownValue / accountInitialBalance) * 100;
                }
            }

            const winRateScore = basicMetrics.winRate || 0;
            const profitFactorScore = Math.min(basicMetrics.profitFactor / 3, 1) * 100;
            const avgWLRatio = advancedMetrics.avgWin && advancedMetrics.avgLoss ? Math.abs(convertCurrency(advancedMetrics.avgWin, DB.settings.defaultCurrency, account.currency) / convertCurrency(advancedMetrics.avgLoss, DB.settings.defaultCurrency, account.currency)) : 0;
            const avgWLRatioScore = Math.min(avgWLRatio / 3, 1) * 100;
            const drawdownScore = Math.max(0, (1 - Math.min(maxDrawdownPercentage / 20, 1)) * 100);

            let consistencyScore = 0;
            if (operations.length > 1) {
                const tradingDays = new Set(operations.map(op => op.date));
                if (tradingDays.size > 0) {
                    const dailyPL = {};
                    operations.forEach(op => {
                        if (!dailyPL[op.date]) dailyPL[op.date] = 0;
                        dailyPL[op.date] += convertCurrency(op.pl, op.currency, account.currency);
                    });
                    const winningDays = Object.values(dailyPL).filter(pl => pl > 0).length;
                    consistencyScore = (winningDays / tradingDays.size) * 100;
                }
            }

            accountDetailRadarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Win %', 'Profit Factor', 'Avg Win/Loss', 'Drawdown Ctrl', 'Consistencia'],
                    datasets: [{
                        label: 'Puntuación',
                        data: [winRateScore, profitFactorScore, avgWLRatioScore, drawdownScore, consistencyScore],
                        fill: true,
                        backgroundColor: 'rgba(57, 255, 20, 0.2)',
                        borderColor: 'rgba(57, 255, 20, 0.8)',
                        pointBackgroundColor: 'var(--primary)',
                        pointBorderColor: '#0a0a0a',
                        pointHoverBackgroundColor: '#FFFFFF',
                        pointHoverBorderColor: 'var(--primary)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            min: 0,
                            max: 100,
                            angleLines: { color: '#2a2a2a' },
                            grid: { color: '#2a2a2a' },
                            pointLabels: { color: '#FFFFFF', font: { size: 10 } },
                            ticks: { display: false, stepSize: 25 }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }


        function showAccountDetails(accountId) {
            const account = DB.accounts.find(acc => acc.id === accountId); if (!account) return;
            document.querySelectorAll('.account-card').forEach(card => card.classList.toggle('selected', card.dataset.id === accountId));
            const detailsSection = document.getElementById('selected-account-details');
            if (!detailsSection) return;
            detailsSection.style.display = 'block'; detailsSection.dataset.accountId = accountId;

            document.getElementById('account-detail-name').textContent = `Detalles de ${account.name}`;

            const operations = DB.operations.filter(op => op.accountId === accountId);
            const sortedOps = [...operations].sort((a, b) => new Date(a.date + 'T' + (a.entryTime || '00:00')) - new Date(b.date + 'T' + (b.entryTime || '00:00')));

            let totalWin = 0, totalLoss = 0, winCount = 0, lossCount = 0;
            let avgWin = 0, avgLoss = 0;

            operations.forEach(op => {
                let pl = op.pl;
                if (op.currency !== account.currency) pl = convertCurrency(pl, op.currency, account.currency);
                if (op.result === 'win') { totalWin += pl; winCount++; }
                else if (op.result === 'loss') { totalLoss += pl; lossCount++; }
            });

            if (winCount > 0) avgWin = totalWin / winCount;
            if (lossCount > 0) avgLoss = totalLoss / lossCount;

            const totalPL = totalWin + totalLoss;
            const winRate = (winCount + lossCount) > 0 ? (winCount / (winCount + lossCount)) * 100 : 0;
            const profitFactor = Math.abs(totalLoss) > 0 ? Math.abs(totalWin / totalLoss) : (totalWin > 0 ? Infinity : 0);
            const avgWLRatio = Math.abs(avgLoss) > 0 ? Math.abs(avgWin / avgLoss) : (avgWin > 0 ? Infinity : 0);

            let peakBalance = account.initialBalance;
            let maxDrawdownValue = 0;
            let currentBalance = account.initialBalance;
            sortedOps.forEach(op => {
                let pl = op.pl;
                if (op.currency !== account.currency) pl = convertCurrency(pl, op.currency, account.currency);
                currentBalance += pl;
                if (currentBalance > peakBalance) peakBalance = currentBalance;
                const drawdown = peakBalance - currentBalance;
                if (drawdown > maxDrawdownValue) maxDrawdownValue = drawdown;
            });
            const maxDrawdownPercentage = account.initialBalance > 0 ? (maxDrawdownValue / account.initialBalance) * 100 : 0;

            let totalDurationMinutes = 0, tradesWithDuration = 0;
            operations.forEach(op => {
                if (op.entryTime && op.exitTime) {
                    try {
                        const startDate = new Date(`1970-01-01T${op.entryTime}`);
                        const endDate = new Date(`1970-01-01T${op.exitTime}`);
                        let duration = (endDate - startDate) / 60000;
                        if (duration < 0) duration += 24 * 60; // Overnight
                        totalDurationMinutes += duration;
                        tradesWithDuration++;
                    } catch (e) { console.warn("Invalid time format for holding time calc", e); }
                }
            });
            let avgHoldTimeText = 'N/A';
            if (tradesWithDuration > 0) {
                const avgMinutes = totalDurationMinutes / tradesWithDuration;
                if (avgMinutes < 1) avgHoldTimeText = `${(avgMinutes * 60).toFixed(0)} seg`;
                else if (avgMinutes < 60) avgHoldTimeText = `${avgMinutes.toFixed(0)} min`;
                else avgHoldTimeText = `${Math.floor(avgMinutes / 60)}h ${Math.round(avgMinutes % 60)}m`;
            }

            let longestWinStreak = 0, currentWinStreak = 0, longestLossStreak = 0, currentLossStreak = 0;
            sortedOps.forEach(op => {
                if (op.result === 'win') { currentWinStreak++; currentLossStreak = 0; longestWinStreak = Math.max(longestWinStreak, currentWinStreak); }
                else if (op.result === 'loss') { currentLossStreak++; currentWinStreak = 0; longestLossStreak = Math.max(longestLossStreak, currentLossStreak); }
                else { currentWinStreak = 0; currentLossStreak = 0; }
            });

            const analyzeTradeType = (trades) => {
                const wins = trades.filter(t => t.result === 'win').length;
                const losses = trades.filter(t => t.result === 'loss').length;
                const totalPL = trades.reduce((sum, t) => sum + (t.currency !== account.currency ? convertCurrency(t.pl, t.currency, account.currency) : t.pl), 0);
                const winRate = (wins + losses) > 0 ? (wins / (wins + losses)) * 100 : 0;
                return { count: trades.length, totalPL, winRate };
            };
            const longStats = analyzeTradeType(operations.filter(op => op.type === 'buy'));
            const shortStats = analyzeTradeType(operations.filter(op => op.type === 'sell'));

            const plEl = document.getElementById('account-detail-pl');
            plEl.textContent = formatCurrency(totalPL, account.currency, account.currency);
            plEl.className = `text-2xl font-bold ${totalPL >= 0 ? 'text-positive' : 'text-negative'}`;
            document.getElementById('account-detail-winrate').textContent = `${winRate.toFixed(1)}%`;
            document.getElementById('account-detail-winrate').className = "text-2xl font-bold text-green";
            document.getElementById('account-detail-trades').textContent = operations.length;
            const pfEl = document.getElementById('account-detail-pf');
            pfEl.textContent = isFinite(profitFactor) ? profitFactor.toFixed(2) : "∞";
            pfEl.className = `text-2xl font-bold ${profitFactor >= 1 ? 'text-green' : 'text-negative'}`;

            document.getElementById('account-detail-drawdown').textContent = `${formatCurrency(maxDrawdownValue, account.currency, account.currency)} (${maxDrawdownPercentage.toFixed(1)}%)`;
            const avgWLRatioEl = document.getElementById('account-detail-avg-w-l-ratio');
            avgWLRatioEl.textContent = isFinite(avgWLRatio) ? avgWLRatio.toFixed(2) : "∞";
            avgWLRatioEl.className = `font-semibold ${avgWLRatio >= 1 ? 'text-green' : 'text-negative'}`;

            document.getElementById('account-detail-win-streak').textContent = longestWinStreak;
            document.getElementById('account-detail-loss-streak').textContent = longestLossStreak;
            document.getElementById('account-detail-hold-time').textContent = avgHoldTimeText;

            const lsBody = document.getElementById('account-long-short-analysis');
            lsBody.innerHTML = `
                <tr>
                    <td>Compras</td><td>${longStats.count}</td>
                    <td class="${longStats.totalPL >= 0 ? 'text-positive' : 'text-negative'}">${formatCurrency(longStats.totalPL, account.currency, account.currency)}</td>
                    <td class="text-green">${longStats.winRate.toFixed(1)}%</td>
                </tr>
                <tr>
                    <td>Ventas</td><td>${shortStats.count}</td>
                    <td class="${shortStats.totalPL >= 0 ? 'text-positive' : 'text-negative'}">${formatCurrency(shortStats.totalPL, account.currency, account.currency)}</td>
                    <td class="text-green">${shortStats.winRate.toFixed(1)}%</td>
                </tr>`;

            const accountDetailTimeRangeContainer = document.getElementById('account-detail-time-range');
            accountDetailTimeRangeContainer.querySelectorAll('.time-range-btn').forEach(btn => btn.classList.remove('active'));
            const allButtonAccountDetail = Array.from(accountDetailTimeRangeContainer.querySelectorAll('.time-range-btn')).find(btn => btn.dataset.range === 'ALL');
            if (allButtonAccountDetail) allButtonAccountDetail.classList.add('active');

            updateAccountDetailChart(account, operations, 'ALL');
            updateAccountDetailRadarChart(operations, accountId); // <-- Nueva llamada
            updateBestWorstTrades(account, sortedOps);
            detailsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function updateBestWorstTrades(account, sortedOperations) {
            const bestTradesBody = document.getElementById('best-trades');
            const worstTradesBody = document.getElementById('worst-trades');
            if (!bestTradesBody || !worstTradesBody) return;
            bestTradesBody.innerHTML = ''; worstTradesBody.innerHTML = '';

            const best5 = [...sortedOperations].sort((a, b) => b.pl - a.pl).filter(op => op.pl > 0).slice(0, 5);
            const worst5 = [...sortedOperations].sort((a, b) => a.pl - b.pl).filter(op => op.pl < 0).slice(0, 5);

            const populateTable = (tbody, ops) => {
                if (ops.length === 0) { tbody.innerHTML = '<tr><td colspan="3" class="text-center text-text-secondary py-4">No hay operaciones</td></tr>'; return; }
                ops.forEach(op => {
                    const plClass = op.pl >= 0 ? 'text-positive' : 'text-negative';
                    const row = tbody.insertRow(); // Insertar la fila
                    row.dataset.id = op.id; // Añadir data-id a la fila
                    row.classList.add('cursor-pointer'); // Añadir clase para hacerla clicable

                    row.innerHTML = `
                        <td>${formatDate(op.date)}</td>
                        <td>${op.instrument}</td>
                        <td class="${plClass}">${formatCurrency(op.pl, op.currency, op.currency)}</td>`;
                });
            };
            populateTable(bestTradesBody, best5);
            populateTable(worstTradesBody, worst5);

            // Añadir event listeners a las tablas de mejores y peores operaciones
            bestTradesBody.querySelectorAll('tr').forEach(row => {
                row.addEventListener('click', () => {
                    const operationId = row.dataset.id;
                    if (operationId) showOperationDetailPage(operationId);
                });
            });
            worstTradesBody.querySelectorAll('tr').forEach(row => {
                row.addEventListener('click', () => {
                    const operationId = row.dataset.id;
                    if (operationId) showOperationDetailPage(operationId);
                });
            });
        }

        function initCsvImport() {
            const importBtn = document.getElementById('import-csv-btn');
            const fileInput = document.getElementById('csv-file-input');
            const statusDiv = document.getElementById('csv-import-status');

            importBtn.addEventListener('click', async () => {
                if (!fileInput.files || fileInput.files.length === 0) {
                    statusDiv.textContent = 'Por favor, selecciona un archivo CSV.';
                    statusDiv.className = 'mt-2 text-sm text-red';
                    return;
                }
                const file = fileInput.files[0];
                statusDiv.textContent = 'Importando...';
                statusDiv.className = 'mt-2 text-sm text-yellow';
                showLoading(true);

                try {
                    const csvText = await file.text();
                    const parsedData = parseCSV(csvText);

                    if (!parsedData.headers || parsedData.rows.length === 0) {
                        throw new Error("CSV vacío o formato de cabecera incorrecto.");
                    }

                    const headerMap = {};
                    parsedData.headers.forEach((header, index) => {
                        headerMap[header.toLowerCase().trim().replace(/\s+/g, ' ')] = index;
                    });

                    const requiredHeaders = ['nombre cuenta', 'fecha', 'hora entrada', 'hora salida', 'instrumento', 'tipo', 'entrada', 'salida', 'volumen', 'divisa'];
                    for (const reqHeader of requiredHeaders) {
                        if (!(reqHeader in headerMap)) {
                            throw new Error(`Cabecera requerida no encontrada en CSV: '${reqHeader}'.`);
                        }
                    }

                    let importedOpsCount = 0;
                    let skippedOpsCount = 0;
                    const newOperations = [];

                    for (const row of parsedData.rows) {
                        const accountNameFromCsv = row[headerMap['nombre cuenta']];
                        if (!accountNameFromCsv || accountNameFromCsv.trim() === "") {
                            skippedOpsCount++;
                            continue;
                        }

                        const account = DB.accounts.find(acc => acc.name.trim().toLowerCase() === accountNameFromCsv.trim().toLowerCase());

                        if (!account) {
                            skippedOpsCount++;
                            continue;
                        }

                        const dateStr = row[headerMap['fecha']];
                        let opDate;
                        if (dateStr.includes('-') && dateStr.split('-')[0].length === 4) {
                            opDate = dateStr;
                        } else if (dateStr.includes('/')) {
                            const parts = dateStr.split('/');
                            if (parts.length === 3) {
                                opDate = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                            }
                        }
                        if (!opDate || isNaN(new Date(opDate + "T00:00:00Z").getTime())) {
                            skippedOpsCount++;
                            continue;
                        }

                        const instrument = row[headerMap['instrumento']].toUpperCase().trim();
                        const type = row[headerMap['tipo']].toLowerCase().trim();
                        const entryStr = String(row[headerMap['entrada']]).replace(',', '.');
                        const exitStr = String(row[headerMap['salida']]).replace(',', '.');
                        const volumeStr = String(row[headerMap['volumen']]).replace(',', '.');

                        const entryTime = row[headerMap['hora entrada']] || null;
                        const exitTime = row[headerMap['hora salida']] || null;
                        const session = headerMap['sesion'] !== undefined ? row[headerMap['sesion']].trim() : null; // Leer campo sesión

                        const entry = parseFloat(entryStr);
                        const exit = parseFloat(exitStr);
                        const volume = parseFloat(volumeStr);

                        const currency = row[headerMap['divisa']].toUpperCase().trim();
                        const notes = headerMap['notas'] !== undefined ? row[headerMap['notas']] : '';

                        let pl = (headerMap['p&l'] !== undefined && row[headerMap['p&l']] && String(row[headerMap['p&l']]).trim() !== "")
                            ? parseFloat(String(row[headerMap['p&l']]).replace(',', '.'))
                            : null;
                        let result;

                        if (isNaN(volume) || volume <= 0) {
                            skippedOpsCount++;
                            continue;
                        }

                        if ((pl === null || isNaN(pl)) && (isNaN(entry) || isNaN(exit))) {
                            skippedOpsCount++;
                            continue;
                        }

                        if (pl !== null && !isNaN(pl)) {
                            result = pl > 0 ? 'win' : (pl < 0 ? 'loss' : 'breakeven');
                        } else {
                            if (isNaN(entry) || isNaN(exit)) {
                                skippedOpsCount++;
                                continue;
                            }
                            if (type === 'buy')
                             pl = (exit - entry) * volume;
                            else pl = (entry - exit) * volume;
                            result = pl > 0 ? 'win' : (pl < 0 ? 'loss' : 'breakeven');
                        }
                        pl = parseFloat(pl.toFixed(5));

                        newOperations.push({
                            id: generateId(), date: opDate, accountId: account.id, instrument, type,
                            entry: isNaN(entry) ? null : entry,
                            exit: isNaN(exit) ? null : exit,
                            entryTime, exitTime,
                            volume, result, pl, currency, notes, imageDatas: [],
                            manualPL: (headerMap['p&l'] !== undefined && row[headerMap['p&l']] && String(row[headerMap['p&l']]).trim() !== "" && !isNaN(parseFloat(String(row[headerMap['p&l']]).replace(',', '.'))))
                                ? parseFloat(String(row[headerMap['p&l']]).replace(',', '.'))
                                : null,
                            session: session // Añadir el campo sesión importado
                        });
                        importedOpsCount++;
                    }

                    if (newOperations.length > 0) {
                        await dexieDB.operations.bulkAdd(newOperations);
                        DB.operations.push(...newOperations);

                        updateAccountBalances();
                        refreshAllViews();
                    }
                    statusDiv.textContent = `Importación completada: ${importedOpsCount} operaciones añadidas, ${skippedOpsCount} omitidas.`;
                    statusDiv.className = 'mt-2 text-sm text-positive';
                    fileInput.value = '';

                } catch (error) {
                    console.error("Error importando CSV:", error);
                    statusDiv.textContent = `Error: ${error.message}`;
                    statusDiv.className = 'mt-2 text-sm text-negative';
                } finally {
                    showLoading(false);
                }
            });
        }

        function parseCSV(csvText) {
            const lines = csvText.replace(/\r\n/g, '\n').replace(/\r/g, '\n').split('\n');
            if (lines.length === 0) return { headers: [], rows: [] };

            const splitLine = (line) => {
                const result = [];
                let current = '';
                let inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"' && (i === 0 || line[i - 1] !== '\\')) { 
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                result.push(current.trim());
                return result.map(v => v.replace(/^"|"$/g, ''));
            };

            const headers = splitLine(lines[0]);
            const rows = [];

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line === "") continue;
                const values = splitLine(line);
                if (values.length >= headers.length) { 
                    rows.push(values);
                } else {
                    console.warn(`Línea CSV con número incorrecto de columnas: "${line}". Esperadas ${headers.length}, obtenidas ${values.length}.`);
                }
            }
            return { headers, rows };
        }


        async function initConfig() {
            updateAccountSelect('ctrader-account'); updateAccountSelect('bingx-account');
            document.getElementById('show-tooltips').checked = DB.settings.showTooltips;
            document.getElementById('ctrader-api-key').value = DB.apiKeys.ctrader.key ? '********' : ''; document.getElementById('ctrader-api-secret').value = DB.apiKeys.ctrader.secret ? '********' : ''; document.getElementById('ctrader-account').value = DB.apiKeys.ctrader.accountId || '';
            document.getElementById('bingx-api-key').value = DB.apiKeys.bingx.key ? '********' : ''; document.getElementById('bingx-api-secret').value = DB.apiKeys.bingx.secret ? '********' : ''; document.getElementById('bingx-account').value = DB.apiKeys.bingx.accountId || '';

            initCsvImport();

            document.getElementById('show-tooltips').addEventListener('change', async (e) => {
                DB.settings.showTooltips = e.target.checked;
                try {
                    await dexieDB.generalData.put(DB.settings, 'settings'); alert('Configuración de tooltips guardada.');
                } catch (err) { console.error("Error saving tooltip settings:", err); alert("Error al guardar configuración."); }
            });
            document.getElementById('ctrader-connect').addEventListener('click', () => alert('Funcionalidad API no implementada.'));
            document.getElementById('bingx-connect').addEventListener('click', () => alert('Funcionalidad API no implementada.'));
            document.getElementById('load-sample-data').addEventListener('click', addSampleData);
            document.getElementById('test-supabase').addEventListener('click', async () => {
                console.log('🧪 Testing Supabase connection...');
                const isConnected = await testSupabaseConnection();
                if (isConnected) {
                    alert('✅ Conexión con Supabase exitosa!');
                } else {
                    alert('❌ Error de conexión con Supabase. Revisa la consola para más detalles.');
                }
            });
            
            document.getElementById('test-rls').addEventListener('click', async () => {
                console.log('🛡️ Testing RLS permissions...');
                await testRLSPermissions();
            });

            document.getElementById('export-data').addEventListener('click', async () => {
                showLoading(true);
                try {
                    const exportableDB = {
                        accounts: await dexieDB.accounts.toArray(),
                        operations: await dexieDB.operations.toArray(),
                        finances: await dexieDB.finances.toArray(),
                        settings: await dexieDB.generalData.get('settings') || DB.settings,
                        apiKeys: await dexieDB.generalData.get('apiKeys') || DB.apiKeys
                    };
                    const dataStr = JSON.stringify(exportableDB, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a'); link.href = url; const date = new Date().toISOString().split('T')[0]; link.download = `trader_survivor_backup_${date}.json`;
                    document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url);
                    alert('Datos exportados correctamente.');
                } catch (e) {
                    console.error('Error exporting data:', e); alert('Error al exportar.');
                } finally { showLoading(false); }
            });

            const importInput = document.getElementById('import-data');
            importInput.addEventListener('change', (event) => {
                const file = event.target.files[0]; if (!file) return;
                if (!confirm('Importar datos reemplazará TODOS los datos actuales. ¿Seguro?')) { importInput.value = ''; return; }
                const reader = new FileReader();
                reader.onload = async (e) => {
                    showLoading(true);
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (importedData.accounts && importedData.operations && importedData.settings) {
                            await dexieDB.transaction('rw', dexieDB.accounts, dexieDB.operations, dexieDB.finances, dexieDB.generalData, async () => {
                                await dexieDB.accounts.clear();
                                await dexieDB.operations.clear();
                                await dexieDB.finances.clear();
                                await dexieDB.generalData.clear();
                                await dexieDB.accounts.bulkPut(importedData.accounts || []);
                                await dexieDB.operations.bulkPut(importedData.operations || []);
                                await dexieDB.finances.bulkPut(importedData.finances || []);
                                await dexieDB.generalData.put(importedData.settings || DB.settings, 'settings');
                                await dexieDB.generalData.put(importedData.apiKeys || DB.apiKeys, 'apiKeys');
                            });
                            alert('Datos importados. Recargando aplicación...'); location.reload();
                        } else { alert('Error: Archivo con estructura no esperada.'); }
                    } catch (err) {
                        console.error('Error importing file:', err); alert('Error al procesar el archivo.');
                    } finally { importInput.value = ''; showLoading(false); }
                };
                reader.onerror = () => { alert('Error al leer el archivo.'); importInput.value = ''; };
                reader.readAsText(file);
            });

            document.getElementById('clear-data').addEventListener('click', async () => {
                if (confirm('¡ATENCIÓN! Esto eliminará TODOS tus datos de forma permanente y la plataforma quedará vacía. ¿Estás seguro?')) {
                    showLoading(true);
                    try {
                        await Promise.all([
                            dexieDB.accounts.clear(),
                            dexieDB.operations.clear(),
                            dexieDB.finances.clear(),
                            dexieDB.generalData.clear()
                        ]);
                        DB.accounts = [];
                        DB.operations = [];
                        DB.finances = [];
                        DB.settings = { darkMode: true, showTooltips: true, autoRefresh: false, defaultCurrency: 'USD' };
                        DB.apiKeys = { ctrader: { key: '', secret: '', accountId: '' }, bingx: { key: '', secret: '', accountId: '' } };
                        await dexieDB.generalData.put(DB.settings, 'settings');
                        await dexieDB.generalData.put(DB.apiKeys, 'apiKeys');

                        alert('Todos los datos han sido eliminados. Recargando aplicación...');
                        location.reload();
                    } catch (e) {
                        console.error("Error clearing DexieDB:", e);
                        alert("Error al borrar los datos de la base de datos local.");
                    } finally {
                        showLoading(false);
                    }
                }
            });
        }

        function updateAccountSelect(selectId) {
            const selectElement = document.getElementById(selectId); if (!selectElement) return;
            const currentValue = selectElement.value; selectElement.innerHTML = '';
            if (['dashboard-account-select', 'analytics-account-select', 'calendar-account-select', 'filter-account'].includes(selectId)) {
                const allOption = document.createElement('option'); allOption.value = 'all'; allOption.textContent = 'Todas las cuentas'; selectElement.appendChild(allOption);
            }
            if (['ctrader-account', 'bingx-account'].includes(selectId)) {
                const placeholderOption = document.createElement('option'); placeholderOption.value = ''; placeholderOption.textContent = 'Seleccionar cuenta...'; selectElement.appendChild(placeholderOption);
            }
            DB.accounts.forEach(account => { const option = document.createElement('option'); option.value = account.id; option.textContent = `${account.name} (${account.currency})`; selectElement.appendChild(option); });

            if (Array.from(selectElement.options).some(opt => opt.value === currentValue)) {
                selectElement.value = currentValue;
            } else if (selectId === 'op-account' && DB.accounts.length > 0) {
                selectElement.value = DB.accounts[0].id;
            } else if (!['ctrader-account', 'bingx-account'].includes(selectId) && selectElement.options.length > 0 && selectElement.options[0].value === 'all') {
                selectElement.value = 'all';
            } else if (selectElement.options.length > 0) {
                selectElement.value = selectElement.options[0].value;
            }
        }
        function showLoading(show) {
            const loadingElement = document.getElementById('loading'); if (loadingElement) { loadingElement.style.display = show ? 'flex' : 'none'; }
        }

        const calendarPopup = document.getElementById('global-calendar-popup');

        function getWeekRangeForDate(date, startOfWeek = 1) { 
            const d = new Date(date);
            d.setUTCHours(0, 0, 0, 0);
            const dayOfWeek = d.getUTCDay();
            const diff = (dayOfWeek < startOfWeek ? 7 : 0) + dayOfWeek - startOfWeek;
            const startDate = new Date(d);
            startDate.setUTCDate(d.getUTCDate() - diff);
            const endDate = new Date(startDate);
            endDate.setUTCDate(startDate.getUTCDate() + 6);
            return {
                startDate: startDate.toISOString().split('T')[0],
                endDate: endDate.toISOString().split('T')[0]
            };
        }

        function getMonthRangeForDate(date) {
            const d = new Date(date);
            const year = d.getUTCFullYear();
            const month = d.getUTCMonth();
            const startDate = new Date(Date.UTC(year, month, 1));
            const endDate = new Date(Date.UTC(year, month + 1, 0));
            return {
                startDate: startDate.toISOString().split('T')[0],
                endDate: endDate.toISOString().split('T')[0]
            };
        }

        function getSemesterRangeForDate(date) {
            const d = new Date(date);
            const year = d.getUTCFullYear();
            const month = d.getUTCMonth();
            let startDate, endDate;
            if (month < 6) { 
                startDate = new Date(Date.UTC(year, 0, 1));
                endDate = new Date(Date.UTC(year, 5, 30));
            } else { 
                startDate = new Date(Date.UTC(year, 6, 1));
                endDate = new Date(Date.UTC(year, 11, 31));
            }
            return {
                startDate: startDate.toISOString().split('T')[0],
                endDate: endDate.toISOString().split('T')[0]
            };
        }

        function getYearRangeForDate(date) {
            const d = new Date(date);
            const year = d.getUTCFullYear();
            const startDate = new Date(Date.UTC(year, 0, 1));
            const endDate = new Date(Date.UTC(year, 11, 31));
            return {
                startDate: startDate.toISOString().split('T')[0],
                endDate: endDate.toISOString().split('T')[0]
            };
        }

        // Función auxiliar para mostrar una sección y ocultar las demás
        function showSection(sectionId) {
            document.querySelectorAll('.section-container').forEach(s => s.classList.remove('active'));
            // Opcional: Si quieres que la pestaña de navegación correspondiente también se active
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            const targetTab = document.querySelector(`.nav-tab[data-target="${sectionId}"]`);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            document.getElementById(sectionId).classList.add('active');
        }


        function renderPopupCalendar(dateForMonthView) {
            const year = dateForMonthView.getUTCFullYear();
            const month = dateForMonthView.getUTCMonth();
            document.getElementById('popup-cal-current-month-year').textContent = `${monthNamesShort[month]} ${year}`;

            const grid = document.getElementById('popup-cal-days-grid');
            grid.innerHTML = '';

            const firstDayOfMonth = new Date(Date.UTC(year, month, 1));
            const lastDayOfMonth = new Date(Date.UTC(year, month + 1, 0));
            const daysInMonth = lastDayOfMonth.getUTCDate();

            let startingDayOfWeek = firstDayOfMonth.getUTCDay();
            if (startingDayOfWeek === 0) startingDayOfWeek = 6;
            else startingDayOfWeek -= 1;

            for (let i = 0; i < startingDayOfWeek; i++) {
                grid.innerHTML += `<div class="popup-cal-day other-month"></div>`;
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const currentDateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayBtn = document.createElement('button');
                dayBtn.classList.add('popup-cal-day');
                dayBtn.dataset.date = currentDateStr;
                dayBtn.textContent = day;

                if (globalDateFilter.type === 'day' && globalDateFilter.startDate === currentDateStr) {
                    dayBtn.classList.add('selected');
                } else if ((globalDateFilter.type === 'week' || globalDateFilter.type === 'month' || globalDateFilter.type === 'semester' || globalDateFilter.type === 'year') &&
                    globalDateFilter.startDate && globalDateFilter.endDate &&
                    currentDateStr >= globalDateFilter.startDate && currentDateStr <= globalDateFilter.endDate) {
                    dayBtn.classList.add('in-range');
                }

                dayBtn.onclick = () => {
                    updateGlobalDateFilter({
                        type: 'day',
                        startDate: currentDateStr,
                        endDate: currentDateStr,
                        display: `Día: ${formatDate(currentDateStr)}`
                    });
                    calendarPopup.classList.add('hidden');
                };
                grid.appendChild(dayBtn);
            }
            const totalCells = startingDayOfWeek + daysInMonth;
            const remainingCells = (7 - (totalCells % 7)) % 7;
            for (let i = 0; i < remainingCells; i++) {
                grid.innerHTML += `<div class="popup-cal-day other-month"></div>`;
            }
        }

        function updateGlobalDateFilter(newFilter) {
            globalDateFilter = newFilter;
            document.querySelectorAll('.date-filter-display-text').forEach(el => {
                el.textContent = globalDateFilter.display;
            });
            refreshAllViews();
        }

        function initGlobalCalendarPopup() {
            popupCalendarStateDate = new Date();
            renderPopupCalendar(popupCalendarStateDate);

            document.querySelectorAll('.date-filter-trigger').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const rect = button.getBoundingClientRect();
                    calendarPopup.style.top = `${rect.bottom + window.scrollY + 5}px`;
                    calendarPopup.style.left = `${rect.left + window.scrollX}px`;
                    calendarPopup.classList.toggle('hidden');
                    if (!calendarPopup.classList.contains('hidden')) {
                        popupCalendarStateDate = new Date();
                        renderPopupCalendar(popupCalendarStateDate);
                    }
                });
            });

            document.getElementById('popup-cal-prev-month-btn').addEventListener('click', () => {
                popupCalendarStateDate.setUTCMonth(popupCalendarStateDate.getUTCMonth() - 1);
                renderPopupCalendar(popupCalendarStateDate);
            });
            document.getElementById('popup-cal-next-month-btn').addEventListener('click', () => {
                popupCalendarStateDate.setUTCMonth(popupCalendarStateDate.getUTCMonth() + 1);
                renderPopupCalendar(popupCalendarStateDate);
            });

            document.getElementById('popup-cal-select-week-btn').addEventListener('click', () => {
                const firstDayOfVisibleMonth = new Date(Date.UTC(popupCalendarStateDate.getUTCFullYear(), popupCalendarStateDate.getUTCMonth(), 1));
                const weekRange = getWeekRangeForDate(firstDayOfVisibleMonth, 1);
                updateGlobalDateFilter({
                    type: 'week',
                    startDate: weekRange.startDate,
                    endDate: weekRange.endDate,
                    display: `Semana: ${formatDate(weekRange.startDate)} - ${formatDate(weekRange.endDate)}`
                });
                calendarPopup.classList.add('hidden');
            });

            document.getElementById('popup-cal-select-month-btn').addEventListener('click', () => {
                const monthRange = getMonthRangeForDate(popupCalendarStateDate);
                updateGlobalDateFilter({
                    type: 'month',
                    startDate: monthRange.startDate,
                    endDate: monthRange.endDate,
                    display: `Mes: ${monthNamesShort[popupCalendarStateDate.getUTCMonth()]} ${popupCalendarStateDate.getUTCFullYear()}`
                });
                calendarPopup.classList.add('hidden');
            });

            document.getElementById('popup-cal-select-semester-btn').addEventListener('click', () => {
                const semesterRange = getSemesterRangeForDate(new Date());
                updateGlobalDateFilter({
                    type: 'semester',
                    startDate: semesterRange.startDate,
                    endDate: semesterRange.endDate,
                    display: `Semestre: ${formatDate(semesterRange.startDate)} - ${formatDate(semesterRange.endDate)}`
                });
                calendarPopup.classList.add('hidden');
            });

            document.getElementById('popup-cal-select-year-btn').addEventListener('click', () => {
                const yearRange = getYearRangeForDate(new Date());
                updateGlobalDateFilter({
                    type: 'year',
                    startDate: yearRange.startDate,
                    endDate: yearRange.endDate,
                    display: `Año: ${new Date().getFullYear()}`
                });
                calendarPopup.classList.add('hidden');
            });

            document.getElementById('popup-cal-clear-filter-btn').addEventListener('click', () => {
                updateGlobalDateFilter({ type: 'all', startDate: null, endDate: null, display: 'Sin filtro de fecha' });
                calendarPopup.classList.add('hidden');
            });

            document.addEventListener('click', (e) => {
                if (!calendarPopup.classList.contains('hidden') && !calendarPopup.contains(e.target) && !e.target.closest('.date-filter-trigger')) {
                    calendarPopup.classList.add('hidden');
                }
            });
        }

        document.addEventListener('DOMContentLoaded', async () => {
            showLoading(true);
            await loadData();
            updateAccountBalances();

            initDashboard();
            initAnalytics();
            initFinances();
            initCalendar();
            initOperations(); // Esto ahora configurará el clic en la fila
            initAccounts();
            await initConfig();
            initGlobalCalendarPopup();
            initImageModal(); // Mantén esto para el pop-up de imágenes desde la página de detalles

            const tabs = document.querySelectorAll('.nav-tab');
            const sections = document.querySelectorAll('.section-container');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetId = tab.dataset.target;
                    tabs.forEach(t => t.classList.remove('active'));
                    sections.forEach(s => s.classList.remove('active'));
                    tab.classList.add('active');
                    const targetSection = document.getElementById(targetId);
                    if (targetSection) {
                        targetSection.classList.add('active');
                        refreshAllViews();
                    }
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
            });

            const initialActiveTab = document.querySelector('.nav-tab.active');
            if (initialActiveTab) {
                const initialTargetId = initialActiveTab.dataset.target;
                const initialTargetSection = document.getElementById(initialTargetId);
                if (initialTargetSection) initialTargetSection.classList.add('active');
                refreshAllViews();
            }

            document.getElementById('close-day-modal-icon').addEventListener('click', closeDayDetailModal);
            document.getElementById('close-day-modal-btn').addEventListener('click', closeDayDetailModal);
            document.getElementById('day-detail-modal').addEventListener('click', function (e) {
                if (e.target.id === 'day-detail-modal') closeDayDetailModal();
            });

            const dashboardTimeRangeContainer = document.querySelector('#dashboard .time-range-buttons');
            if (dashboardTimeRangeContainer) {
                dashboardTimeRangeContainer.addEventListener('click', (event) => {
                    if (event.target.classList.contains('time-range-btn')) {
                        dashboardTimeRangeContainer.querySelectorAll('.time-range-btn').forEach(btn => btn.classList.remove('active'));
                        event.target.classList.add('active');
                        refreshDashboard();
                    }
                });
            }

            const accountDetailTimeRangeContainer = document.getElementById('account-detail-time-range');
            if (accountDetailTimeRangeContainer) {
                accountDetailTimeRangeContainer.addEventListener('click', (event) => {
                    if (event.target.classList.contains('time-range-btn')) {
                        accountDetailTimeRangeContainer.querySelectorAll('.time-range-btn').forEach(btn => btn.classList.remove('active'));
                        event.target.classList.add('active');
                        const selectedRange = event.target.dataset.range;
                        const accountId = document.getElementById('selected-account-details').dataset.accountId;
                        if (accountId) {
                            const account = DB.accounts.find(acc => acc.id === accountId);
                            const accountOps = DB.operations.filter(op => op.accountId === accountId);
                            if (account) updateAccountDetailChart(account, accountOps, selectedRange);
                        }
                    }
                });
            }

            document.getElementById('dashboard-account-select').addEventListener('change', () => {
                if (dashboardTimeRangeContainer) {
                    const rangeButtons = dashboardTimeRangeContainer.querySelectorAll('.time-range-btn');
                    rangeButtons.forEach(btn => btn.classList.remove('active'));
                    const allButton = Array.from(rangeButtons).find(btn => btn.dataset.range === 'ALL');
                    if (allButton) allButton.classList.add('active');
                }
                if (document.getElementById('dashboard').classList.contains('active')) refreshDashboard();
            });
            document.getElementById('analytics-account-select').addEventListener('change', () => {
                if (document.getElementById('analytics').classList.contains('active')) refreshAnalytics();
            });

            // Manejador del botón "Volver a Operaciones"
            document.getElementById('back-to-operations-btn').addEventListener('click', () => {
                showSection('operations'); // Activa la sección de operaciones
                // refreshOperationsTable(); // Ya se refresca al activar la sección de operaciones si es necesario
                window.scrollTo({ top: 0, behavior: 'smooth' }); // Desplazarse al inicio de la página de operaciones
            });


            showLoading(false);
        });

        function openDayDetailModal(dateKeyYYYYMMDD, ops, totalPLForDayInBaseCurrency, baseCurrency) {
            const modal = document.getElementById('day-detail-modal');
            document.getElementById('day-modal-title').textContent = `Trades del ${formatDate(dateKeyYYYYMMDD)}`;
            const totalTrades = ops.length;
            const winners = ops.filter(op => op.result === 'win').length;
            const losers = ops.filter(op => op.result === 'loss').length;
            const winRate = (winners + losers) > 0 ? (winners / (winners + losers)) * 100 : 0;
            let totalVolume = ops.reduce((sum, op) => sum + (parseFloat(op.volume) || 0), 0);
            let sumWinPL = 0, sumLossPL = 0;

            const currencyModeForModal = document.querySelector('input[name="cal-currency"]:checked').value;
            let initialBalanceForModalPercent = 0;
            if (currencyModeForModal === '%') {
                const selectedAccount = document.getElementById('calendar-account-select').value;
                if (selectedAccount !== 'all') {
                    const account = DB.accounts.find(a => a.id === selectedAccount);
                    if (account) initialBalanceForModalPercent = convertCurrency(account.initialBalance, account.currency, baseCurrency);
                } else {
                    initialBalanceForModalPercent = DB.accounts.reduce((sum, acc) => sum + convertCurrency(acc.initialBalance, acc.currency, baseCurrency), 0);
                }
            }


            ops.forEach(op => {
                let plConvertedToBase = op.currency !== baseCurrency ? convertCurrency(op.pl, op.currency, baseCurrency) : op.pl;
                if (op.result === 'win') sumWinPL += plConvertedToBase;
                else if (op.result === 'loss') sumLossPL += plConvertedToBase;
            });
            const profitFactor = sumLossPL !== 0 ? Math.abs(sumWinPL / sumLossPL) : (sumWinPL > 0 ? Infinity : 0);

            let totalPLDisplay;
            if (currencyModeForModal === '%') {
                totalPLDisplay = initialBalanceForModalPercent > 0 ? ((totalPLForDayInBaseCurrency / initialBalanceForModalPercent) * 100).toFixed(2) + '%' : '0.00%';
            } else {
                totalPLDisplay = formatCurrency(totalPLForDayInBaseCurrency, baseCurrency, currencyModeForModal);
            }

            document.getElementById('day-total-pl-header').textContent = totalPLDisplay;
            document.getElementById('day-total-trades-header').textContent = totalTrades;
            document.getElementById('day-win-rate-header').textContent = `${winRate.toFixed(1)}%`;
            document.getElementById('day-winners-header').textContent = winners;
            document.getElementById('day-losers-header').textContent = losers;
            document.getElementById('day-volume-header').textContent = totalVolume.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 4 });
            document.getElementById('day-profit-factor-header').textContent = profitFactor === Infinity ? "Inf" : profitFactor.toFixed(2);

            const tbody = document.getElementById('day-modal-table-body'); tbody.innerHTML = '';
            if (ops.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-text-secondary">No hay operaciones para este día.</td></tr>`;
            } else {
                ops.forEach(op => {
                    const tr = document.createElement('tr');
                    tr.dataset.id = op.id; // Añadir data-id a la fila
                    tr.classList.add('cursor-pointer'); // Hacerla clicable

                    let plConvertedToBaseForOp = op.currency !== baseCurrency ? convertCurrency(op.pl, op.currency, baseCurrency) : op.pl;
                    let opPLDisplay;
                    if (currencyModeForModal === '%') {
                        opPLDisplay = initialBalanceForModalPercent > 0 ? ((plConvertedToBaseForOp / initialBalanceForModalPercent) * 100).toFixed(2) + '%' : '0.00%';
                    } else {
                        opPLDisplay = formatCurrency(plConvertedToBaseForOp, baseCurrency, currencyModeForModal);
                    }

                    tr.innerHTML = `
                        <td>${op.entryTime || '-'}</td>
                        <td>${op.instrument}</td>
                        <td class="${op.type === 'buy' ? 'text-positive' : 'text-negative'} font-semibold">${op.type === 'buy' ? 'COMPRA' : 'VENTA'}</td>
                        <td class="${plConvertedToBaseForOp >= 0 ? 'text-positive' : 'text-negative'}">${opPLDisplay}</td>
                        <td>${op.exitTime || '-'}</td>`;
                    tbody.appendChild(tr);
                });
                 // Listener para las operaciones dentro del modal del calendario
                tbody.querySelectorAll('tr').forEach(row => {
                    row.addEventListener('click', () => {
                        const operationId = row.dataset.id;
                        if (operationId) {
                            closeDayDetailModal(); // Cerrar el modal del día
                            showOperationDetailPage(operationId); // Abrir la página de detalles
                        }
                    });
                });
            }
            modal.classList.remove('hidden'); modal.classList.add('flex');
        }
        function closeDayDetailModal() {
            const modal = document.getElementById('day-detail-modal');
            modal.classList.add('hidden'); modal.classList.remove('flex');
        }

        // Nueva función para determinar la sesión de trading basada en la hora de entrada UTC
        function getTradingSession(entryTimeStr) {
            if (!entryTimeStr) return 'No especificado';

            const [hoursStr] = entryTimeStr.split(':');
            const entryHourUTC = parseInt(hoursStr, 10);

            // Horarios aproximados de las principales sesiones de trading en UTC
            // Estas son clasificaciones primarias, los solapamientos se manejan con lógica específica
            // Se asume que las horas de entrada de la operación ya están en UTC o se manejarán como si lo fuera.
            
            // Sesión Asiática (incluye Tokio, Sídney) - Abarca la noche y madrugada europea/americana
            if (entryHourUTC >= 22 || entryHourUTC < 7) { // 22:00 UTC (noche) hasta 06:59 UTC (mañana)
                return 'Asia';
            }
            // Sesión de Londres (Europa) - Solapa con Asia y Nueva York
            else if (entryHourUTC >= 7 && entryHourUTC < 12) { // 07:00 UTC hasta 11:59 UTC (antes de que abra NY)
                return 'Londres';
            }
            // Sesión de Nueva York (América) - Solapa con Londres
            else if (entryHourUTC >= 12 && entryHourUTC < 17) { // 12:00 UTC hasta 16:59 UTC (solapamiento Londres-NY)
                return 'Nueva York (solapamiento Londres)';
            }
            else if (entryHourUTC >= 17 && entryHourUTC < 21) { // 17:00 UTC hasta 20:59 UTC (solo NY)
                return 'Nueva York';
            }
            // Cualquier otra hora
            return 'Fuera de Sesión Principal / Otro';
        }

        // Nueva función para mostrar las métricas de sesión en la página de detalles
        function displaySessionMetrics(currentOperation) {
            const currentSessionEl = document.getElementById('op-detail-session-current');
            const sessionMetricsTableBody = document.getElementById('op-detail-session-metrics');
            sessionMetricsTableBody.innerHTML = ''; // Limpiar datos anteriores

            const currentTradeSession = getTradingSession(currentOperation.entryTime);
            currentSessionEl.textContent = currentTradeSession;

            // Agrega métricas para TODAS las operaciones basándose en la sesión
            const sessionPerformance = {
                'Asia': { pl: 0, trades: 0, wins: 0, losses: 0 },
                'Londres': { pl: 0, trades: 0, wins: 0, losses: 0 },
                'Nueva York (solapamiento Londres)': { pl: 0, trades: 0, wins: 0, losses: 0 },
                'Nueva York': { pl: 0, trades: 0, wins: 0, losses: 0 },
                'Fuera de Sesión Principal / Otro': { pl: 0, trades: 0, wins: 0, losses: 0 },
                'No especificado': { pl: 0, trades: 0, wins: 0, losses: 0 }
            };

            DB.operations.forEach(op => {
                const session = getTradingSession(op.entryTime); // Usar la sesión derivada de la hora
                let plConverted = op.pl;
                // Convertir PL a la divisa por defecto para un análisis consistente
                if (op.currency !== DB.settings.defaultCurrency) {
                    plConverted = convertCurrency(op.pl, op.currency, DB.settings.defaultCurrency);
                }

                if (!sessionPerformance[session]) { // Asegurarse de que la clave exista si getTradingSession devuelve algo inesperado
                    sessionPerformance[session] = { pl: 0, trades: 0, wins: 0, losses: 0 };
                }
                sessionPerformance[session].pl += plConverted;
                sessionPerformance[session].trades++;
                if (op.result === 'win') sessionPerformance[session].wins++;
                else if (op.result === 'loss') sessionPerformance[session].losses++;
            });

            // Ordenar las sesiones para la tabla (opcional, pero profesional)
            const orderedSessionNames = ['Asia', 'Londres', 'Nueva York (solapamiento Londres)', 'Nueva York', 'Fuera de Sesión Principal / Otro', 'No especificado'].filter(name => sessionPerformance[name].trades > 0);
            
            // Si hay sesiones con datos pero no están en la lista ordenada, añadirlas al final
            Object.keys(sessionPerformance).forEach(sessionName => {
                if (!orderedSessionNames.includes(sessionName) && sessionPerformance[sessionName].trades > 0) {
                    orderedSessionNames.push(sessionName);
                }
            });

            if (orderedSessionNames.length === 0) {
                sessionMetricsTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-text-secondary py-3">No hay operaciones registradas para análisis de sesión.</td></tr>';
                return;
            }

            // Rellenar la tabla
            orderedSessionNames.forEach(sessionName => {
                const data = sessionPerformance[sessionName];
                const winRate = (data.wins + data.losses) > 0 ? (data.wins / (data.wins + data.losses)) * 100 : 0;
                const plClass = data.pl > 0 ? 'text-positive' : (data.pl < 0 ? 'text-negative' : 'text-neutral');

                const row = `
                    <tr>
                        <td>${sessionName}</td>
                        <td class="${plClass}">${formatCurrency(data.pl, DB.settings.defaultCurrency, DB.settings.defaultCurrency)}</td>
                        <td>${data.trades}</td>
                        <td class="text-green">${winRate.toFixed(1)}%</td>
                    </tr>
                `;
                sessionMetricsTableBody.innerHTML += row;
            });
        }

        // Nueva función para mostrar la página completa de detalles de la operación
        function showOperationDetailPage(operationId) {
            const operation = DB.operations.find(op => op.id === operationId);
            if (!operation) {
                alert("Operación no encontrada.");
                return;
            }

            const account = DB.accounts.find(acc => acc.id === operation.accountId);
            const precision = getInstrumentPrecision(operation.instrument);

            // Rellenar la nueva sección
            document.getElementById('op-detail-page-title').textContent = `Detalles de la Operación: ${operation.instrument}`;
            document.getElementById('op-detail-date').textContent = formatDate(operation.date);
            document.getElementById('op-detail-account').textContent = account ? account.name : 'N/A';
            document.getElementById('op-detail-instrument').textContent = operation.instrument;
            document.getElementById('op-detail-type').textContent = operation.type === 'buy' ? 'Compra (Long)' : 'Venta (Short)';
            document.getElementById('op-detail-entry').textContent = operation.entry !== null ? operation.entry.toFixed(precision) : '-';
            document.getElementById('op-detail-exit').textContent = operation.exit !== null ? operation.exit.toFixed(precision) : '-';
            document.getElementById('op-detail-entry-time').textContent = operation.entryTime || '-';
            document.getElementById('op-detail-exit-time').textContent = operation.exitTime || '-';
            document.getElementById('op-detail-volume').textContent = operation.volume;
            document.getElementById('op-detail-currency').textContent = operation.currency;
            document.getElementById('op-detail-manual-pl').textContent = operation.manualPL !== null ? formatCurrency(operation.manualPL, operation.currency, operation.currency) : 'No especificado';
            document.getElementById('op-detail-session').textContent = operation.session || 'N/A'; // Mostrar el campo Sesión

            const resultEl = document.getElementById('op-detail-result');
            resultEl.textContent = operation.result === 'win' ? 'Ganancia' : (operation.result === 'loss' ? 'Pérdida' : 'Neutral');
            resultEl.className = `font-semibold ${operation.result === 'win' ? 'text-positive' : (operation.result === 'loss' ? 'text-negative' : 'text-neutral')}`;

            const plEl = document.getElementById('op-detail-pl');
            plEl.textContent = formatCurrency(operation.pl, operation.currency, operation.currency);
            plEl.className = `font-semibold ${operation.pl >= 0 ? 'text-positive' : (operation.pl < 0 ? 'text-negative' : 'text-neutral')}`;

            document.getElementById('op-detail-notes').textContent = operation.notes || 'Sin notas.';

            // Imágenes
            const imagesContainer = document.getElementById('op-detail-images');
            imagesContainer.innerHTML = ''; // Limpiar imágenes anteriores
            if (operation.imageDatas && operation.imageDatas.length > 0) {
                operation.imageDatas.forEach((imageDataUrl, index) => {
                    const img = document.createElement('img');
                    img.src = imageDataUrl;
                    img.alt = `Imagen ${index + 1}`;
                    img.className = "w-full h-40 object-cover rounded-md border border-surface-light cursor-pointer";
                    img.onclick = () => openImageModal(operation.imageDatas, index);
                    imagesContainer.appendChild(img);
                });
            } else {
                imagesContainer.innerHTML = '<p class="text-sm text-text-secondary md:col-span-3 text-center">No hay imágenes adjuntas.</p>';
            }

            // Análisis de Sesión
            displaySessionMetrics(operation);


            // Mostrar la página de detalles y ocultar otras
            showSection('operation-detail-page');
            window.scrollTo({ top: 0, behavior: 'smooth' }); // Desplazarse al inicio de la nueva página
        }
    </script>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";
        import { getStorage } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-storage.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-analytics.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBWX_li52qXOfsee0v6dEX6TsTre5nsyJQ",
            authDomain: "tradersurvivor99.firebaseapp.com",
            projectId: "tradersurvivor99",
            storageBucket: "tradersurvivor99.firebasestorage.app",
            messagingSenderId: "321644861145",
            appId: "1:321644861145:web:4adf78d89de42ab14650c8",
            measurementId: "G-CS7ST78JQT"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const analytics = getAnalytics(app);

        // Función de prueba para verificar la conexión
        async function probarFirebase() {
            try {
                // Intentamos agregar un documento de prueba
                const docRef = await addDoc(collection(db, "prueba"), {
                    mensaje: "Prueba de conexión",
                    fecha: new Date()
                });
                console.log("¡Conexión exitosa! Documento creado con ID:", docRef.id);
                
                // Mostramos un mensaje en la página
                const mensajePrueba = document.createElement('div');
                mensajePrueba.style.position = 'fixed';
                mensajePrueba.style.top = '20px';
                mensajePrueba.style.left = '50%';
                mensajePrueba.style.transform = 'translateX(-50%)';
                mensajePrueba.style.backgroundColor = '#4CAF50';
                mensajePrueba.style.color = 'white';
                mensajePrueba.style.padding = '15px';
                mensajePrueba.style.borderRadius = '5px';
                mensajePrueba.textContent = '✅ Firebase conectado correctamente';
                document.body.appendChild(mensajePrueba);
                
                // Eliminamos el mensaje después de 5 segundos
                setTimeout(() => {
                    mensajePrueba.remove();
                }, 5000);

                // Eliminamos el documento de prueba
                await deleteDoc(doc(db, "prueba", docRef.id));
            } catch (error) {
                console.error("Error al conectar con Firebase:", error);
                
                // Mostramos mensaje de error en la página
                const mensajeError = document.createElement('div');
                mensajeError.style.position = 'fixed';
                mensajeError.style.top = '20px';
                mensajeError.style.left = '50%';
                mensajeError.style.transform = 'translateX(-50%)';
                mensajeError.style.backgroundColor = '#f44336';
                mensajeError.style.color = 'white';
                mensajeError.style.padding = '15px';
                mensajeError.style.borderRadius = '5px';
                mensajeError.textContent = '❌ Error al conectar con Firebase';
                document.body.appendChild(mensajeError);
                
                // Eliminamos el mensaje después de 5 segundos
                setTimeout(() => {
                    mensajeError.remove();
                }, 5000);
            }
        }

        // Ejecutamos la prueba cuando la página termine de cargar
        window.addEventListener('load', probarFirebase);
    </script>
<script>
// Función para verificar permisos RLS
async function testRLSPermissions() {
    if (!currentUser) {
        alert('❌ No hay usuario logueado');
        return;
    }
    
    try {
        console.log('🛡️ Testing RLS permissions...');
        console.log('👤 Current user ID:', currentUser.id);
        
        // Test 1: Probar SELECT en accounts
        console.log('🔍 Testing SELECT on accounts...');
        const { data: selectData, error: selectError } = await supabase
            .from('accounts')
            .select('*')
            .eq('user_id', currentUser.id);
        
        if (selectError) {
            console.error('❌ SELECT test failed:', selectError);
            alert(`❌ Error en SELECT: ${selectError.message}`);
            return;
        }
        
        console.log('✅ SELECT test passed:', selectData);
        
        // Test 2: Probar INSERT en accounts
        console.log('🔍 Testing INSERT on accounts...');
        const testAccount = {
            id: 'test_' + Date.now(),
            user_id: currentUser.id,
            name: 'Test Account',
            currency: 'USD',
            platform: 'test',
            initial_balance: 1000,
            balance: 1000
        };
        
        const { data: insertData, error: insertError } = await supabase
            .from('accounts')
            .insert(testAccount)
            .select();
        
        if (insertError) {
            console.error('❌ INSERT test failed:', insertError);
            alert(`❌ Error en INSERT: ${insertError.message}`);
            return;
        }
        
        console.log('✅ INSERT test passed:', insertData);
        
        // Test 3: Limpiar - eliminar el registro de prueba
        await supabase
            .from('accounts')
            .delete()
            .eq('id', testAccount.id);
        
        console.log('✅ Test cleanup completed');
        alert('✅ Todos los permisos RLS funcionan correctamente!');
        
    } catch (error) {
        console.error('❌ RLS test error:', error);
        alert(`❌ Error en prueba RLS: ${error.message}`);
    }
}
async function testSupabaseConnection() {
    try {
        console.log('🔍 Testing Supabase connection...');
        console.log('🔍 Current user:', currentUser);
        console.log('🔍 Supabase client:', supabase);
        
        if (!currentUser) {
            console.log('❌ No current user for testing');
            alert('❌ No hay usuario logueado');
            return false;
        }
        
        console.log('🔍 Testing simple query...');
        
        // Probar una consulta simple
        const { data, error, count } = await supabase
            .from('accounts')
            .select('*', { count: 'exact' })
            .eq('user_id', currentUser.id);
        
        if (error) {
            console.error('❌ Supabase connection test failed:', error);
            alert(`❌ Error de conexión: ${error.message}`);
            return false;
        }
        
        console.log('✅ Supabase connection test successful');
        console.log('📊 Current accounts in Supabase:', data);
        console.log('📊 Total accounts count:', count);
        
        alert(`✅ Conexión exitosa! Cuentas encontradas: ${count || 0}`);
        return true;
    } catch (error) {
        console.error('❌ Supabase connection test error:', error);
        alert(`❌ Error inesperado: ${error.message}`);
        return false;
    }
}

// ===== SUPABASE AUTHENTICATION SYSTEM =====

// Configuración de Supabase
const supabaseUrl = 'https://gakiamardmlgftfrlxkm.supabase.co'
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdha2lhbWFyZG1sZ2Z0ZnJseGttIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwMjczMzUsImV4cCI6MjA2ODYwMzMzNX0.wR3c9DMtSXzoagFDJdrmYqnN6vjfQMn8ijtUdOSpmYM'
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey)

// ===== SUPABASE DATABASE FUNCTIONS =====
// Variable global para el usuario actual
let currentUser = null;

// Función para inicializar las tablas de Supabase (solo para referencia)
async function initializeSupabaseTables() {
    // Las tablas deben crearse en el panel de Supabase con las siguientes estructuras:
    // 
    // 1. accounts: 
    //    - id (text, primary key)
    //    - user_id (uuid, references auth.users(id))
    //    - name (text)
    //    - currency (text)
    //    - platform (text)
    //    - initial_balance (numeric)
    //    - balance (numeric)
    //    - created_at (timestamp with time zone)
    //
    // 2. operations:
    //    - id (text, primary key)
    //    - user_id (uuid, references auth.users(id))
    //    - account_id (text)
    //    - date (text)
    //    - instrument (text)
    //    - type (text)
    //    - entry (numeric)
    //    - exit (numeric)
    //    - entry_time (text)
    //    - exit_time (text)
    //    - volume (numeric)
    //    - result (text)
    //    - pl (numeric)
    //    - currency (text)
    //    - notes (text)
    //    - image_datas (text[])
    //    - manual_pl (numeric)
    //    - session (text)
    //    - created_at (timestamp with time zone)
    //
    // 3. finances:
    //    - id (serial, primary key)
    //    - user_id (uuid, references auth.users(id))
    //    - date (text)
    //    - amount (numeric)
    //    - currency (text)
    //    - notes (text)
    //    - created_at (timestamp with time zone)
    //
    // 4. user_settings:
    //    - user_id (uuid, primary key, references auth.users(id))
    //    - settings (jsonb)
    //    - api_keys (jsonb)
    //    - created_at (timestamp with time zone)
    //    - updated_at (timestamp with time zone)
}

// Funciones para operaciones con cuentas
async function saveAccountToSupabase(accountData) {
    if (!currentUser) {
        console.warn('❌ No current user - cannot save account to Supabase');
        return null;
    }
    
    try {
        console.log('💾 Saving account to Supabase:', {
            id: accountData.id,
            user_id: currentUser.id,
            name: accountData.name,
            currency: accountData.currency
        });
        
        const { data, error } = await supabase
            .from('accounts')
            .upsert({
                id: accountData.id,
                user_id: currentUser.id,
                name: accountData.name,
                currency: accountData.currency,
                platform: accountData.platform,
                initial_balance: accountData.initialBalance,
                balance: accountData.balance
            });
        
        if (error) {
            console.error('❌ Supabase error saving account:', error);
            throw error;
        }
        
        console.log('✅ Account saved to Supabase successfully:', data);
        return data;
    } catch (error) {
        console.error('❌ Error saving account to Supabase:', error);
        throw error;
    }
}

async function loadAccountsFromSupabase() {
    if (!currentUser) return [];
    
    try {
        const { data, error } = await supabase
            .from('accounts')
            .select('*')
            .eq('user_id', currentUser.id);
        
        if (error) throw error;
        
        // Convertir de formato Supabase a formato local
        return data.map(account => ({
            id: account.id,
            name: account.name,
            currency: account.currency,
            platform: account.platform,
            initialBalance: account.initial_balance,
            balance: account.balance
        }));
    } catch (error) {
        console.error('Error loading accounts from Supabase:', error);
        return [];
    }
}

async function deleteAccountFromSupabase(accountId) {
    if (!currentUser) return;
    
    try {
        const { error } = await supabase
            .from('accounts')
            .delete()
            .eq('id', accountId)
            .eq('user_id', currentUser.id);
        
        if (error) throw error;
    } catch (error) {
        console.error('Error deleting account from Supabase:', error);
        throw error;
    }
}

// Funciones para operaciones
async function saveOperationToSupabase(operationData) {
    if (!currentUser) {
        console.warn('❌ No current user - cannot save operation to Supabase');
        return null;
    }
    
    try {
        console.log('💾 Saving operation to Supabase:', {
            id: operationData.id,
            user_id: currentUser.id,
            instrument: operationData.instrument,
            result: operationData.result
        });
        
        const { data, error } = await supabase
            .from('operations')
            .upsert({
                id: operationData.id,
                user_id: currentUser.id,
                account_id: operationData.accountId,
                date: operationData.date,
                instrument: operationData.instrument,
                type: operationData.type,
                entry: operationData.entry,
                exit: operationData.exit,
                entry_time: operationData.entryTime,
                exit_time: operationData.exitTime,
                volume: operationData.volume,
                result: operationData.result,
                pl: operationData.pl,
                currency: operationData.currency,
                notes: operationData.notes,
                image_datas: operationData.imageDatas || [],
                manual_pl: operationData.manualPL,
                session: operationData.session
            });
        
        if (error) {
            console.error('❌ Supabase error saving operation:', error);
            throw error;
        }
        
        console.log('✅ Operation saved to Supabase successfully:', data);
        return data;
    } catch (error) {
        console.error('❌ Error saving operation to Supabase:', error);
        throw error;
    }
}

async function loadOperationsFromSupabase() {
    if (!currentUser) return [];
    
    try {
        const { data, error } = await supabase
            .from('operations')
            .select('*')
            .eq('user_id', currentUser.id)
            .order('date', { ascending: false });
        
        if (error) throw error;
        
        // Convertir de formato Supabase a formato local
        return data.map(operation => ({
            id: operation.id,
            accountId: operation.account_id,
            date: operation.date,
            instrument: operation.instrument,
            type: operation.type,
            entry: operation.entry,
            exit: operation.exit,
            entryTime: operation.entry_time,
            exitTime: operation.exit_time,
            volume: operation.volume,
            result: operation.result,
            pl: operation.pl,
            currency: operation.currency,
            notes: operation.notes,
            imageDatas: operation.image_datas || [],
            manualPL: operation.manual_pl,
            session: operation.session
        }));
    } catch (error) {
        console.error('Error loading operations from Supabase:', error);
        return [];
    }
}

async function deleteOperationFromSupabase(operationId) {
    if (!currentUser) return;
    
    try {
        const { error } = await supabase
            .from('operations')
            .delete()
            .eq('id', operationId)
            .eq('user_id', currentUser.id);
        
        if (error) throw error;
    } catch (error) {
        console.error('Error deleting operation from Supabase:', error);
        throw error;
    }
}

// Funciones para finanzas
async function saveFinanceToSupabase(financeData) {
    if (!currentUser) return null;
    
    try {
        const { data, error } = await supabase
            .from('finances')
            .insert({
                user_id: currentUser.id,
                date: financeData.date,
                amount: financeData.amount,
                currency: financeData.currency,
                notes: financeData.notes
            })
            .select();
        
        if (error) throw error;
        return data[0];
    } catch (error) {
        console.error('Error saving finance to Supabase:', error);
        throw error;
    }
}

async function updateFinanceInSupabase(supabaseId, financeData) {
    if (!currentUser) return null;
    
    try {
        const { data, error } = await supabase
            .from('finances')
            .update({
                date: financeData.date,
                amount: financeData.amount,
                currency: financeData.currency,
                notes: financeData.notes
            })
            .eq('id', supabaseId)
            .eq('user_id', currentUser.id);
        
        if (error) throw error;
        return data;
    } catch (error) {
        console.error('Error updating finance in Supabase:', error);
        throw error;
    }
}

async function loadFinancesFromSupabase() {
    if (!currentUser) return [];
    
    try {
        const { data, error } = await supabase
            .from('finances')
            .select('*')
            .eq('user_id', currentUser.id)
            .order('date', { ascending: false });
        
        if (error) throw error;
        
        return data;
    } catch (error) {
        console.error('Error loading finances from Supabase:', error);
        return [];
    }
}

async function deleteFinanceFromSupabase(financeId) {
    if (!currentUser) return;
    
    try {
        const { error } = await supabase
            .from('finances')
            .delete()
            .eq('id', financeId)
            .eq('user_id', currentUser.id);
        
        if (error) throw error;
    } catch (error) {
        console.error('Error deleting finance from Supabase:', error);
        throw error;
    }
}

// Funciones para configuraciones de usuario
async function saveUserSettingsToSupabase(settings, apiKeys = null) {
    if (!currentUser) return;
    
    try {
        const { data, error } = await supabase
            .from('user_settings')
            .upsert({
                user_id: currentUser.id,
                settings: settings,
                api_keys: apiKeys,
                updated_at: new Date().toISOString()
            });
        
        if (error) throw error;
        return data;
    } catch (error) {
        console.error('Error saving user settings to Supabase:', error);
        throw error;
    }
}

async function loadUserSettingsFromSupabase() {
    if (!currentUser) return { settings: null, apiKeys: null };
    
    try {
        const { data, error } = await supabase
            .from('user_settings')
            .select('*')
            .eq('user_id', currentUser.id)
            .single();
        
        if (error && error.code !== 'PGRST116') throw error; // PGRST116 es "no rows returned"
        
        return {
            settings: data?.settings || null,
            apiKeys: data?.api_keys || null
        };
    } catch (error) {
        console.error('Error loading user settings from Supabase:', error);
        return { settings: null, apiKeys: null };
    }
}

// Función para sincronizar todos los datos desde Supabase
async function syncDataFromSupabase() {
    if (!currentUser) {
        console.warn('❌ No current user - cannot sync data from Supabase');
        return;
    }
    
    try {
        console.log('🔄 Sincronizando datos desde Supabase para usuario:', currentUser.email);
        showLoading(true);
        
        // Cargar todos los datos desde Supabase
        const [accounts, operations, finances, userSettings] = await Promise.all([
            loadAccountsFromSupabase(),
            loadOperationsFromSupabase(),
            loadFinancesFromSupabase(),
            loadUserSettingsFromSupabase()
        ]);
        
        console.log('📊 Datos cargados desde Supabase:', {
            accounts: accounts.length,
            operations: operations.length,
            finances: finances.length,
            hasSettings: !!userSettings.settings
        });
        
        // Actualizar las variables locales
        DB.accounts = accounts;
        DB.operations = operations;
        DB.finances = finances;
        
        if (userSettings.settings) {
            DB.settings = userSettings.settings;
        }
        if (userSettings.apiKeys) {
            DB.apiKeys = userSettings.apiKeys;
        }
        
        // Actualizar también en Dexie para sincronización local
        await dexieDB.transaction('rw', dexieDB.accounts, dexieDB.operations, dexieDB.finances, dexieDB.generalData, async () => {
            await dexieDB.accounts.clear();
            await dexieDB.operations.clear();
            await dexieDB.finances.clear();
            
            if (accounts.length > 0) await dexieDB.accounts.bulkPut(accounts);
            if (operations.length > 0) await dexieDB.operations.bulkPut(operations);
            if (finances.length > 0) await dexieDB.finances.bulkPut(finances);
            
            if (userSettings.settings) await dexieDB.generalData.put(userSettings.settings, 'settings');
            if (userSettings.apiKeys) await dexieDB.generalData.put(userSettings.apiKeys, 'apiKeys');
        });
        
        updateAccountBalances();
        refreshAllViews();
        
        console.log('✅ Datos sincronizados desde Supabase exitosamente');
        
    } catch (error) {
        console.error('❌ Error syncing data from Supabase:', error);
        // Si hay error, mantener los datos locales
    } finally {
        showLoading(false);
    }
}

// Referencias DOM
const authModal = document.getElementById('authModal');
const mainApp = document.getElementById('mainApp');
const loginForm = document.getElementById('loginForm');
const registerForm = document.getElementById('registerForm');
const authMessage = document.getElementById('authMessage');
const userInfo = document.getElementById('userInfo');
const userEmail = document.getElementById('userEmail');
const userAvatar = document.getElementById('userAvatar');
const logoutBtn = document.getElementById('logoutBtn');

// ===== INICIALIZACIÓN =====
document.addEventListener('DOMContentLoaded', async () => {
    console.log('🚀 Inicializando sistema de autenticación...');
    
    // Configurar event listeners
    setupEventListeners();
    
    // Verificar sesión existente
    await checkAuth();
});

// ===== EVENT LISTENERS =====
function setupEventListeners() {
    // Tabs de autenticación
    document.querySelectorAll('.auth-tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
            const tabName = e.target.getAttribute('data-tab');
            switchAuthTab(tabName);
        });
    });

    // Formularios
    loginForm.addEventListener('submit', handleLogin);
    registerForm.addEventListener('submit', handleRegister);
    
    // Logout
    logoutBtn.addEventListener('click', handleLogout);
}

// ===== FUNCIONES DE UI =====
function switchAuthTab(tabName) {
    // Actualizar tabs
    document.querySelectorAll('.auth-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
    
    // Actualizar formularios
    document.querySelectorAll('.auth-form').forEach(form => {
        form.classList.remove('active');
    });
    document.getElementById(`${tabName}Form`).classList.add('active');
    
    // Limpiar mensaje
    hideMessage();
}

function showMessage(message, type = 'error') {
    authMessage.textContent = message;
    authMessage.className = type === 'error' ? 'auth-error' : 'auth-success';
    authMessage.style.display = 'block';
}

function hideMessage() {
    authMessage.style.display = 'none';
}

function showAuth() {
    authModal.style.display = 'flex';
    mainApp.classList.add('app-hidden');
}

function hideAuth() {
    authModal.style.display = 'none';
    mainApp.classList.remove('app-hidden');
}

function updateUserInfo(user) {
    console.log('👤 Updating user info:', user.email);
    currentUser = user;
    userEmail.textContent = user.email;
    userAvatar.textContent = user.email.charAt(0).toUpperCase();
    userInfo.style.display = 'flex';
    
    // Sincronizar datos desde Supabase cuando el usuario se autentica
    console.log('🔄 Iniciando sincronización de datos...');
    syncDataFromSupabase();
}

function clearUserInfo() {
    currentUser = null;
    userInfo.style.display = 'none';
}

// ===== FUNCIONES DE AUTENTICACIÓN =====
async function checkAuth() {
    try {
        console.log('🔐 Checking authentication...');
        const { data: { session } } = await supabase.auth.getSession();
        
        console.log('🔐 Session data:', session);
        
        if (session?.user) {
            console.log('✅ Usuario logueado:', session.user.email);
            console.log('👤 User ID:', session.user.id);
            updateUserInfo(session.user);
            hideAuth();
        } else {
            console.log('❌ No hay sesión activa');
            clearUserInfo();
            showAuth();
        }
    } catch (error) {
        console.error('❌ Error verificando autenticación:', error);
        showAuth();
    }
}

async function handleLogin(e) {
    e.preventDefault();
    
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;
    
    if (!email || !password) {
        showMessage('Por favor completa todos los campos');
        return;
    }
    
    // Deshabilitar botón
    const submitBtn = e.target.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Iniciando sesión...';
    
    try {
        const { data, error } = await supabase.auth.signInWithPassword({
            email: email,
            password: password
        });
        
        if (error) throw error;
        
        console.log('✅ Login exitoso:', data.user.email);
        showMessage('¡Bienvenido de vuelta!', 'success');
        
        setTimeout(() => {
            updateUserInfo(data.user);
            hideAuth();
            hideMessage();
        }, 1000);
        
    } catch (error) {
        console.error('❌ Error en login:', error);
        showMessage(getErrorMessage(error.message));
    } finally {
        // Rehabilitar botón
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i>Iniciar Sesión';
    }
}

async function handleRegister(e) {
    e.preventDefault();
    
    const email = document.getElementById('registerEmail').value.trim();
    const password = document.getElementById('registerPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    // Validaciones
    if (!email || !password || !confirmPassword) {
        showMessage('Por favor completa todos los campos');
        return;
    }
    
    if (password !== confirmPassword) {
        showMessage('Las contraseñas no coinciden');
        return;
    }
    
    if (password.length < 6) {
        showMessage('La contraseña debe tener al menos 6 caracteres');
        return;
    }
    
    // Deshabilitar botón
    const submitBtn = e.target.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creando cuenta...';
    
    try {
        const { data, error } = await supabase.auth.signUp({
            email: email,
            password: password
        });
        
        if (error) throw error;
        
        if (data.user && !data.session) {
            showMessage('¡Cuenta creada! Revisa tu email para confirmar tu cuenta', 'success');
            // Cambiar a tab de login después de unos segundos
            setTimeout(() => {
                switchAuthTab('login');
                document.getElementById('loginEmail').value = email;
            }, 3000);
        } else if (data.session) {
            console.log('✅ Registro exitoso:', data.user.email);
            showMessage('¡Cuenta creada exitosamente!', 'success');
            
            setTimeout(() => {
                updateUserInfo(data.user);
                hideAuth();
                hideMessage();
            }, 1000);
        }
        
    } catch (error) {
        console.error('❌ Error en registro:', error);
        showMessage(getErrorMessage(error.message));
    } finally {
        // Rehabilitar botón
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-user-plus mr-2"></i>Crear Cuenta';
    }
}

async function handleLogout() {
    try {
        console.log('🚪 Cerrando sesión...');
        
        const { error } = await supabase.auth.signOut();
        
        if (error) throw error;
        
        clearUserInfo();
        showAuth();
        
        // Limpiar formularios
        loginForm.reset();
        registerForm.reset();
        hideMessage();
        
        console.log('✅ Sesión cerrada exitosamente');
        
    } catch (error) {
        console.error('❌ Error cerrando sesión:', error);
        alert('Error al cerrar sesión: ' + error.message);
    }
}

// ===== UTILIDADES =====
function getErrorMessage(errorMsg) {
    const errorMessages = {
        'Invalid login credentials': 'Email o contraseña incorrectos',
        'Email not confirmed': 'Por favor confirma tu email antes de iniciar sesión',
        'User not found': 'Usuario no encontrado',
        'Invalid email': 'Email no válido',
        'Password should be at least 6 characters': 'La contraseña debe tener al menos 6 caracteres',
        'User already registered': 'Este email ya está registrado',
        'Signup is disabled': 'El registro está deshabilitado',
        'Email address not authorized': 'Email no autorizado'
    };
    
    return errorMessages[errorMsg] || errorMsg;
}

// ===== LISTENERS DE SUPABASE =====
supabase.auth.onAuthStateChange((event, session) => {
    console.log('🔄 Cambio de estado de autenticación:', event);
    
    if (event === 'SIGNED_IN' && session?.user) {
        updateUserInfo(session.user);
        hideAuth();
    } else if (event === 'SIGNED_OUT') {
        clearUserInfo();
        showAuth();
    }
});

// ===== FUNCIONES GLOBALES =====
window.getCurrentUser = () => currentUser;
window.isAuthenticated = () => !!currentUser;

console.log('✅ Sistema de autenticación inicializado');
</script>

</body>
</html>